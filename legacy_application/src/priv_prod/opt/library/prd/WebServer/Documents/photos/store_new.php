<?phpinclude("../../include/authPHOTOS.inc");/*echo "<pre>";print_r($_REQUEST);print_r($_SESSION);print_r($_FILES);echo "</pre>";exit;*/if($com){$com1=explode("*",urldecode($com));$comName=$com1[0];$sciName=trim($com1[1]);}$catArray=array("nrid"=>"NRID","scenic"=>"Scenic","activities"=>"Activities","visitor protection"=>"Visitor Protection","maintenance"=>"Maintenance","cultural"=>"Cultural/History","facility"=>"Facility","staff"=>"Staff","resource management"=>"Resource Management","people|groups"=>"People/Groups","geology"=>"Geology","other"=>"Other");  // also found in store.php	$testCat=array("nrid","scen","acti","cult","visi","main","faci","staf","othe","reso","peop","geol");$subcatArray=array("kron"=>"Kron House","homesite"=>"Homesite","grave"=>"Graveyard","native"=>"Native American","ferry"=>"MOMO Ferry","still"=>"Liquor Still","road"=>"Roads","ccc"=>"CCC");  // also found in store.php	$testsubCat=array("kron","home","grav","nati","ferr","stil","road","ccc");	?><HTML><HEAD><TITLE>Store photo in THE ID</TITLE><!-- THIS JUMP ONLY WORKS FOR FRAMES --><script language="JavaScript"><!--function MM_jumpMenu(selObj,restore){ //v3.0eval("parent.frames['mainFrame']"+".location='"+selObj.options[selObj.selectedIndex].value+"'");  if (restore) selObj.selectedIndex=0;}//-->function validate() {if (document.mainform.cat[0].checked == true) {alert('Photo was NOT entered. All plant and animal photos must first have an entry in NRID.');event.returnValue=false;	}}function toggle(){	var div1 = document.getElementById('div1')	if (div1.style.display == 'none') {		div1.style.display = 'block'	} else {		div1.style.display = 'none'	}}</script></HEAD><BODY><body bgcolor="#CCFFCC"><?php    // Data from form is processedif ($submit == "Add Photo")	{	$size=$_FILES['photo']['size'];	if($size<100000 AND $personID==""){echo "<br />This photo does not have a resolution high enough to be useable in printed materials.<br /><br />Instead, please add it to the NRID photo database using the Add a Photo to NRID  <= 640 pixels.";exit;}		if($cat[0]=="nrid" AND $source!="nrid" AND $park!="nonDPR"){echo "<b>Photo was NOT entered.</b> All plant and animal photos must first have an entry in NRID.	<br><br>Click <a href='http://149.168.1.196/nrid/' target='_blank'>here</a> to go to NRID.	<br><br>After entering a record, use the \"Add a Photo\" button to add your photo. Contact <a href='mailto:tom.howard@ncmail.net'>Tom Howard</a> if you are not familiar with the process of adding a record to NRID.";	exit;}			if($park==""){echo "You must designate Park.	<br><br>Click your browser's BACK button";	exit;}	if($cat[0] == "nrid" and $majorGroup == ""){echo "You must designate a Plant or Animal Group for any NRID entry.	<br><br>Click your browser's BACK button";	exit;}	if($cat[0] != "nrid" and $majorGroup != ""){echo "Do NOT designate a Plant or Animal Group for any non-NRID entry.	<br><br>Click your browser's BACK button";	exit;}	if($cat == ""){echo "You must select a <b>Category</b>!	<br><br>Click your browser's BACK button";	exit;}	/*  		print "<pre>";	print_r($_REQUEST); 	print_r($_FILES);	  print "</pre>";		exit;	*/	$_SESSION['parkS']=$park;	$sciName = $_REQUEST['sciName'];	$majorGroup = $_REQUEST['majorGroup'];	include("../../include/connectPHOTOS.inc");		include("tnModified.php");// loads functions to make thumbnail		$i=0;	while ($i <= count($catArray)) {	$category.=$cat[$i].",";		 $i++;	}		$i=0;	while ($i <= count($subcatArray)) {	$subcategory.=$subcat[$i].",";		 $i++;	}		//echo "$category";print_r($cat); exit;	$newdate = date("Y-m-d");	//$newdate = $datePhoto;	$park = strtoupper($park);		$file = $_FILES['photo']['name'];	$uploadFile = $_FILES['photo']['tmp_name'];	$ext = substr(strrchr($file, "."), 1);// find file extention, mp3 e.g.	// $file = str_replace(" ","",strtolower($sciName)).".".$ext;// remove spaces	if(!is_uploaded_file($uploadFile)){echo "No photo was selected or loaded. Click your browser's BACK button."; exit;}		// Clean up messy majorGroup when no species name selected	if($majorGroup){	$pos1 = strpos($majorGroup, "majorGroup=");	if($pos1>1){	$mg=explode("majorGroup=",$majorGroup); $majorGroup=$mg[1];}	}		$personID=str_replace("'","",$personID);// remove ' from O'Neal e.g.	$comment=addslashes($comment);	$photoname=addslashes($photoname);	$photog=addslashes($photog);	if($lon>0){$lon=(-$lon);}		$sql="INSERT INTO images (majorGroup,park,filename,filesize,filetype,photoname,photog,comment,date,cd, sciName,cat,subcat,personID,lat,lon,website) "."VALUES ('$majorGroup','$park','$photo[name]','$photo[size]','$photo[type]','$photoname','$photog','$comment','$datePhoto','$cd','$sciName','$category','$subcategory','$personID','$lat','$lon','$website')";	$result = @mysql_query($sql, $connection) or die("$sql Error 1#". mysql_errno() . ": " . mysql_error());	//echo "$sql"; exit;		$pid= mysql_insert_id();				$dir = explode("-",$newdate);		$dirname = $park."_".$dir[0];		$folder = "photos/".$dirname;	if (!file_exists($folder)) {mkdir ($folder, 0777);}			$dirname = $park."_".$dir[0]."/".$dir[1];		$folder = "photos/".$dirname;	if (!file_exists($folder)) {mkdir ($folder, 0777);}	$location = $folder."/".$pid.".jpg"; // original file			$p=$pid.".jpg";		move_uploaded_file($uploadFile,$location);// create file on server		$tn=$folder."/640.".$p;	$file_640=$tn;	$wid=640; $hei=640;	createthumb($folder."/".$p,$tn,$wid,$hei); // 640 size		// This creates a thumbnail using functions in tnModified.php	$tn=$folder."/ztn.".$p;			$wid=150;	$hei=150;	createthumb($file_640,$tn,$wid,$hei); // true thumbnail		// Prepare thumbnail of photo obtained from upload form to add to db	$data = addslashes(fread(fopen($tn, "r"), filesize ($tn))); 		  $sql = "UPDATE images set link='$location',photo='$data', height='$old_y', width='$old_x' where pid='$pid'";	$result = @mysql_query($sql, $connection) or die("$sql Error 1#". mysql_errno() . ": " . mysql_error());		MYSQL_CLOSE();		// Encode to preserve apostrophe '	$photoname=addslashes($photoname);	// Display	if($sciName){$sn = "SciName=".$sciName;$cn = "ComName=".$comName;}	echo "<table>			<tr><td>$sn</td><td>$cn</></tr>			<tr><td><img src='$tn'></td></tr>			<tr><td>$photoname by $photog on $datePhoto</td></tr>			<tr><td>$comment</td></tr>	<tr><td><br><a href='getData.php?pid=$pid&location=$location'>Show the full-size photo</a></td></tr>";		echo "<tr><td><br><a href='store.php?pid=$pid&submit=Edit the Photo Info&photoname=$photoname&photog=$photog&comment=$comment&date=$newdate'>Edit</a> the info.</td></tr>		<tr><td><br>		 <form method='post' action='$PHP_SELF' enctype='multipart/form-data'>		<INPUT TYPE='hidden' name='category' value='$category'>		<INPUT TYPE='hidden' name='photoname' value='$photoname'>		<INPUT TYPE='hidden' name='photog' value='$photog'>		<INPUT TYPE='hidden' name='comment' value='$comment'>		<INPUT TYPE='hidden' name='datePhoto' value='$datePhoto'>		<INPUT TYPE='hidden' name='majorGroup' value='$majorGroup'>		<INPUT TYPE='hidden' name='cd' value='$cd'>		<INPUT TYPE='hidden' name='sciName' value='$sciName'>		<INPUT TYPE='hidden' name='comName' value=\"$comName\">		<br><input type='submit' name='submit' value='Add a Photo'> with same info.			</form>	</td></tr>		<tr><td><br><a href='store.php?submit=Add a Photo'>Add</a> another photo with different info.</td></tr>		<tr><td><br><a href='search.php'>Search</a> the Database.</td></tr>	</table>";	} // *******************************************    // Show the form to submit a new photoif ($submit == "Add a Photo" or $submit == "Add species")	{	//print_r($_SESSION);	if($_SESSION['photos']['level']>2){	$employeeID="Employee ID (Lname1234): 		<input type='text' name='personID' value='$personID' size='26'>";}	else{$employeeID="";}	include("../../include/parkcodesDiv.inc");			$catArray=array("nrid"=>"NRID","scenic"=>"Scenic","activities"=>"Activities","visitor protection"=>"Visitor Protection","maintenance"=>"Maintenance","cultural"=>"Cultural/History","facility"=>"Facility","staff"=>"Staff","resource management"=>"Resource Management","people|groups"=>"People/Groups","geology"=>"Geology","other"=>"Other");  // also found in store.php		$testCat=array("nrid","scen","acti","cult","visi","main","faci","staf","othe","reso","peop","geol");		$subcatArray=array("kron"=>"Kron House","homesite"=>"Homesite","grave"=>"Graveyard","native"=>"Native American","ferry"=>"MOMO Ferry","still"=>"Liquor Still","road"=>"Roads","ccc"=>"CCC");  // also found in store.php		$testsubCat=array("kron","home","grav","nati","ferr","stil","road","ccc");				if($datePhoto){$year=$datePhoto;}else{$year=date("Y-m-");}	if($dateNRID){$year=$dateNRID;}	if(!$cd){$cd="none";} // set cd to none if blank			// *********** Blank form		echo "Enter the appropriate info.<hr>	 	 <form method='post' name='mainform' action='store.php' enctype='multipart/form-data' onsubmit=\"validate();\">";		include("GroupArray.inc");	$arrayNum = count($GroupArrayN);	$i = 1;		$file="listTest.php?park=$park&majorGroup=";		echo "When adding a NRID entry, select the Group <b>first.</b>	<br>	<select name=\"majorGroup\" onChange=\"MM_jumpMenu(this,0)\">\n";	 echo "<option value=''>\n";	 $i=1;	while ($i <= $arrayNum) {	if($majorGroup == $GroupArrayN[$i]){$ck="selected";}else{$ck="value";}		 echo "<option $ck=\"$file$GroupArrayV[$i]\">$GroupArrayN[$i]\n";		 $i++;	}	echo "</select>\n";	if($sciName){$nridCKED="checked";}	echo "Select Group (<font color='red'>required ONLY for NRID entry</font>)<br>";	echo "<br>	<b>Park:</b><select name='park'>";		$j=0;$k=count($parkCode);	$parkC=$_SESSION['parkS'];	if($parkNRID){$parkC=$parkNRID;}	while ($j < $k) {	if($parkCode[$j]==$parkC){$v="selected";}else{$v="value";}		 echo "<option $v='$parkCode[$j]'>$parkCode[$j]\n";		 $j++;	}	echo "</select> (<font color='red'>required</font>)<br>";		echo "<br><b>Category:</b> (<font color='red'>required</font>) - more than one can be selected.<br>	<table border='1'><tr>";			//$subcatArray  defined above	$i=1;$b="CKED"; $subcat="";	foreach($subcatArray as $key=>$val){		$a=strtolower(substr($key,0,4)); $ck=${$a.$b};		if(fmod($i,4)==0){$br="<br />";} $i++;		$subcat.="<input type='checkbox' name='subcat[]' value='$key' $ck>$val$br";		$br="";		}		//$catArray  defined above	foreach($catArray as $k=>$v){		$a=strtolower(substr($k,0,4)); $ck=${$a.$b};		if($k=="facility"){echo "</tr><tr>";}				if($k=="cultural"){		$v="$v<div id=\"topicTitle\" ><a onclick=\"toggle('div1');\" href=\"javascript:void('')\"> subcategories &#177</a></div>		<div id=\"div1\" style=\"display: none\"> $subcat</div>";		}			echo "<td><input type='checkbox' name='cat[]' value='$k' $ck>$v</td>";		}		/*	echo "<br><b>Category:</b> (<font color='red'>required</font>)<br>		[<input type='checkbox' name='cat[0]' value='nrid' $nridCKED>NRID]		[<input type='checkbox' name='cat[1]' value='scenic' $scenCKED>Scenic]	*/   		echo "</tr></table><br>	Mark for DPR Website inclusion: <input type='checkbox' name='website' value='x' $webCKED>[For use by Website administrator only.]	<br/ ><br/ >	Name, or Number, of CD containing original photo: 		<input type='text' name='cd' value='$cd' size='26'> (<font color='red'>required</font>)	<br><br>	Date of Photo: 		<input type='text' name='datePhoto' value='$year' size='16'>		$employeeID<br><br>";	if($majorGroup){echo "		SciName: <i>$sciName</i>		<br>		ComName: <b>$comName</b>		<br><br>";}	if($observer){$observer=urldecode($observer);$photog=$observer;}// passed from NRID	echo "Name of Photo: <input type='text' name='photoname' value='$photoname' size='75'><br><br>		Photographer(s): <input type='text' name='photog' value='$photog' size='50'><br><br>		Comment(s): <textarea cols='40' rows='5' name='comment'>$comment	</textarea><br /><br />	<input type='text' name='lat' value='$lat' size='10'> Latitude	<input type='text' name='lon' value='$lon' size='10'> Longitude in degrees decimal, e.g., 34.258621, -78.490335 for Google Earth/Map	<hr>		<INPUT TYPE='hidden' name='MAX_FILE_SIZE' value='30000000'>		<br>1. Click the BROWSE (or Choose File) button and select your photo.<br>		<input type='file' name='photo'  size='40'>	<input type='hidden' name='source' value='$source'>	<input type='hidden' name='sciName' value='$sciName'>	<input type='hidden' name='comName' value=\"$comName\">		<p>2. Then click this button. <input type='submit' name='submit' value='Add Photo'>		</form>";		echo "</BODY></HTML>";	exit;	}    // Show the form to submit edit photo infoif ($submit == "Edit the Photo Info") {    // else show the form to submit new data:  $photoname = urldecode($photoname);  $cd = urldecode($cd);  $photog = urldecode($photog);   $link = urldecode($link);   $comment = urldecode($comment);  $NSsciName = urlencode($sciName); if($_SESSION['photos']['level']>2){$employeeID="Employee ID (Lname1234):     <input type='text' name='personID' value='$personID' size='26'>";}else{$employeeID="";}echo "<form action='store.php' method='POST'>Park: <b>$park</b><br>"; echo "<hr>EDIT the info and Submit.<br><br>    CD Name:     <textarea cols='25' rows='1' name='cd'>$cd</textarea>    Photo Name:     <textarea cols='40' rows='1' name='photoname'>$photoname</textarea> <br>$employeeID<br>   Date of Photo:     <input type='text' name='date' value='$date' size='16'>  <b>IMPORTANT</b> Enter Date as either yyyy-mm-dd OR m/d/yyyy<br><br>    Photographer: <textarea cols='40' rows='1' name='photog'>$photog</textarea><br><br>    Comment:<br><textarea cols='40' rows='5' name='comment'>$comment</textarea><br/><br />Latitude:     <input type='text' name='lat' value='$lat' size='10'>    Longitude:     <input type='text' name='lon' value='$lon' size='10'><input type='hidden' name='pid' value='$pid'><input type='hidden' name='link' value='$link'><br><br><br><input type='submit' name='submit' value='Submit Edit'>    </form><hr></BODY></HTML>";exit;}    // UPDATE photo infoif ($submit == "Submit Edit") { //print_r($_REQUEST); EXIT;include("../../include/connectPHOTOS.inc");  $photoname = addslashes($photoname);  $photog = addslashes($photog);   $link = urldecode($link);   $comment = addslashes($comment);   $discus = urldecode($discus);   $cd = urldecode($cd);   $personID=str_replace("'","",$personID);if($lon>0){$lon=(-$lon);}     $sql = "UPDATE images set photoname='$photoname',cd='$cd',date='$date',photog='$photog',comment='$comment',personID='$personID', lat='$lat', lon='$lon' where pid='$pid'";$result = @mysql_query($sql, $connection) or die("$sql Error 1#". mysql_errno() . ": " . mysql_error());    MYSQL_CLOSE();header("Location: getData.php?pid=$pid");}?>