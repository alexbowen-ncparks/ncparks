<?php$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/iConnect.inc"); // connection parametersmysqli_select_db($connection, $database); // databaseextract($_REQUEST);include_once("menu.php");include_once("partf_fund_total.php");// Headerecho "<table border='1'><tr><th>"; sortCol(projNum); echo "PROJECT<BR>NUMBER</th><th>CALENDAR<BR>YEAR OF<BR>INITIAL<BR>FUNDING</th><th>"; sortCol(Center); sumCol(Center);echo "CRNT<BR>CNTR</th><th>"; sortCol(budgCode); echo "CODE</th><th>"; sortCol(comp,"partf_projects.projNum"); sumCol(comp);echo "COMP</th><th>MGR</th><th>FISCAL YR<br>OF FUNDING</th><th>"; sortCol(park,"partf_projects.projNum"); sumCol(park);echo "PARK</th><th>"; sortCol(dist,"partf_projects.park"); sumCol(dist);echo "DIST</th><th>"; sortCol(county,"partf_projects.park"); sumCol(county);echo "COUNTY</th><th>PROJECT NAME</th><th>TOTAL POSTED<BR><a href='editFunds.php'>FUNDS</a></th><th>TOTAL POSTED<BR>EXPENSES</th><th>TOTAL POSTED<BR>ENDING<BR>BALANCE</th><th>ESTIMATED<BR>CONSTRUCTION<BR>STATE DATE</th><th>ESTIMATED<BR>CONSTRUCTION<BR>END DATE</th><th>STATUS<BR>D=DESIGN<BR>C=CONST<BR>F=FINISHED</th><th>COMMENTS</th></tr>";//$where="where reportDisplay='Y'";$where="where reportDisplay='Y' and datePost!=''";if($s==""){$s="projNum";}$fldPARTF="tempPARTF";//*********** SWITCH ***************	switch ($g) {		case "county":$select="DISTINCT partf_projects.county, sum(partf_payments.amount) as amtFrom partf_projects LEFT JOIN partf_payments on partf_projects.projNum=partf_payments.proj_num$whereGROUP BY countyORDER BY county";	$sql = "SELECT $select";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$num=mysqli_num_rows($result);while($row=mysqli_fetch_array($result)){extract($row);// don't send $partf_approv_num use funds.credit insteadmakeReport($projNum,$projYN,$reportDisplay,$projCat,$projSCnum,$projDENRnum,$Center,$budgCode,$comp,$projsup,$manager,$fundMan,$YearFundC,$YearFundF,$fullname,$dist,$county,$section,$park,$projName,$active,$startDate,$endDate,$status,$percentCom,$statusPer,$comments,$commentsI,$dateadded,$brucefy,$proj_man,$secondCounty,$res_proj,$partfyn,$femayn,$fema_proj_num,$mult_proj,$partfid,$amt,$credit);}			break;			case "dist":$select="DISTINCT partf_projects.dist, sum(partf_payments.amount) as amtFrom partf_projects LEFT JOIN partf_payments on partf_projects.projNum=partf_payments.proj_num$whereGROUP BY distORDER BY dist";	$sql = "SELECT $select";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$num=mysqli_num_rows($result);while($row=mysqli_fetch_array($result)){extract($row);// don't send $partf_approv_num use funds.credit insteadmakeReport($projNum,$projYN,$reportDisplay,$projCat,$projSCnum,$projDENRnum,$Center,$budgCode,$comp,$projsup,$manager,$fundMan,$YearFundC,$YearFundF,$fullname,$dist,$county,$section,$park,$projName,$active,$startDate,$endDate,$status,$percentCom,$statusPer,$comments,$commentsI,$dateadded,$brucefy,$proj_man,$secondCounty,$res_proj,$partfyn,$femayn,$fema_proj_num,$mult_proj,$partfid,$amt,$credit);}			break;			case "park":$select="DISTINCT partf_projects.park, sum(partf_payments.amount) as amtFrom partf_projects LEFT JOIN partf_payments on partf_projects.projNum=partf_payments.proj_num$whereGROUP BY parkORDER BY park";	$sql = "SELECT $select";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$num=mysqli_num_rows($result);while($row=mysqli_fetch_array($result)){extract($row);// don't send $partf_approv_num use funds.credit insteadmakeReport($projNum,$projYN,$reportDisplay,$projCat,$projSCnum,$projDENRnum,$Center,$budgCode,$comp,$projsup,$manager,$fundMan,$YearFundC,$YearFundF,$fullname,$dist,$county,$section,$park,$projName,$active,$startDate,$endDate,$status,$percentCom,$statusPer,$comments,$commentsI,$dateadded,$brucefy,$proj_man,$secondCounty,$res_proj,$partfyn,$femayn,$fema_proj_num,$mult_proj,$partfid,$amt,$credit);}			break;			case "Center":$select="DISTINCT partf_projects.Center, sum(partf_payments.amount) as amt,funds.creditFrom partf_projects LEFT JOIN partf_payments on partf_projects.projNum=partf_payments.proj_numLEFT JOIN funds on partf_projects.projNum=funds.projNum$whereGROUP BY CenterORDER BY Center";	$sql = "SELECT $select";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$num=mysqli_num_rows($result);while($row=mysqli_fetch_array($result)){extract($row);// don't send $partf_approv_num use funds.credit insteadmakeReport($projNum,$projYN,$reportDisplay,$projCat,$projSCnum,$projDENRnum,$Center,$budgCode,$comp,$projsup,$manager,$fundMan,$YearFundC,$YearFundF,$fullname,$dist,$county,$section,$park,$projName,$active,$startDate,$endDate,$status,$percentCom,$statusPer,$comments,$commentsI,$dateadded,$brucefy,$proj_man,$secondCounty,$res_proj,$partfyn,$femayn,$fema_proj_num,$mult_proj,$partfid,$amt,$credit);}			break;			case "comp":// First get the allocated funds in an array			$select="DISTINCT comp, sum(funds.credit) AS creditFROM partf_projects LEFT  JOIN funds ON partf_projects.projNum = funds.projNum$whereGROUP  BY comp";$sql = "SELECT $select";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$num=mysqli_num_rows($result);while($row=mysqli_fetch_array($result)){extract($row);$arrayCom[]=$comp;$arrayCredit[]=$credit;}// Next get the payments in an array			$select="DISTINCT comp, sum(partf_payments.amount) as amtFROM partf_projects LEFT JOIN partf_payments on partf_projects.projNum=partf_payments.proj_num$whereGROUP  BY comp";$sql = "SELECT $select";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");while($row=mysqli_fetch_array($result)){extract($row);$arrayAmt[]=$amt;}for($i=0;$i<$num;$i++){// now output values$amt=$arrayAmt[$i];$credit=$arrayCredit[$i];$comp=$arrayCom[$i];makeReport($projNum,$projYN,$reportDisplay,$projCat,$projSCnum,$projDENRnum,$Center,$budgCode,$comp,$projsup,$manager,$fundMan,$YearFundC,$YearFundF,$fullname,$dist,$county,$section,$park,$projName,$active,$startDate,$endDate,$status,$percentCom,$statusPer,$comments,$commentsI,$dateadded,$brucefy,$proj_man,$secondCounty,$res_proj,$partfyn,$femayn,$fema_proj_num,$mult_proj,$partfid,$amt,$credit);}			break;			default:$select="DISTINCT partf_projects.*, sum(partf_payments.amount) as amt,".$fldPARTF.".creditFrom partf_projects LEFT JOIN partf_payments on partf_projects.projNum=partf_payments.proj_numLEFT JOIN $fldPARTF on partf_projects.projNum=".$fldPARTF.".projNum$whereGROUP BY partf_payments.proj_numORDER BY $s";	$sql = "SELECT $select";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$num=mysqli_num_rows($result);while($row=mysqli_fetch_array($result)){extract($row);// don't send $partf_approv_num use funds.credit insteadmakeReport($projNum,$projYN,$reportDisplay,$projCat,$projSCnum,$projDENRnum,$Center,$budgCode,$comp,$projsup,$manager,$fundMan,$YearFundC,$YearFundF,$fullname,$dist,$county,$section,$park,$projName,$active,$startDate,$endDate,$status,$percentCom,$statusPer,$comments,$commentsI,$dateadded,$brucefy,$proj_man,$secondCounty,$res_proj,$partfyn,$femayn,$fema_proj_num,$mult_proj,$partfid,$amt,$credit);}	}	echo " n = $num<br>";echo "$sql"; //exit;// ***************** FUNCTIONS **************function sortCol($fld1,$fld2){$sort=$fld1; if($fld2){$sort=$sort.",".$fld2;}echo "<a href='conReport.php?s=$sort'>Sort<br></a>";}function sumCol($fld){echo "<a href='conReport.php?g=$fld'>Group<br></a>";}function formatMoney($fm){$value=number_format($fm,2);return $value;}function makeReport($projNum,$projYN,$reportDisplay,$projCat,$projSCnum,$projDENRnum,$Center,$budgCode,$comp,$projsup,$manager,$fundMan,$YearFundC,$YearFundF,$fullname,$dist,$county,$section,$park,$projName,$active,$startDate,$endDate,$status,$percentCom,$statusPer,$comments,$commentsI,$dateadded,$brucefy,$proj_man,$secondCounty,$res_proj,$partfyn,$femayn,$fema_proj_num,$mult_proj,$partfid,$amt,$credit){$statusPer=$status."-".$percentCom;$dif=($credit-$amt);if($dif<0){$tb="<font color='red'>";$te="</font>";}else{$tb="";$te="";}$dif=formatMoney($credit-$amt);$div_app_amt=formatMoney($credit);if($amt){$amt="(".formatMoney($amt).")";}else{$amt="";}$projNumLink="<a href='partf.php?partfid=$partfid'>$projNum</a>";$postLink="<a href='editFunds.php?proj_in=$projNum&post=1'>$div_app_amt</a>";$Center=strtoupper($Center);$park=strtoupper($park);echo "<tr><td align='center'>$projNumLink</td><td align='center'>$YearFundC</td><td>$Center</td><td>$budgCode</td><td>$comp</td><td>$proj_man</td><td align='center'>$YearFundF</td><td>$park</td><td>$dist</td><td>$county</td><td>$projName</td><td align='right'>$postLink</td><td align='right'>$amt</td><td align='right'>$tb$dif$te</td><td align='center'>$startDate</td><td align='center'>$endDate</td><td>$statusPer</td><td>$comments</td></tr>";}echo "</table>";?>