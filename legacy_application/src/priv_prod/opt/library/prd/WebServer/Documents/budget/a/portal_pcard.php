<?php//These are placed outside of the webserver directory for security//include("../../include/authEEID.inc"); // used to authenticate usersinclude("../../include/connectBUDGET.inc");// database connection parametersinclude("menu.php");?><script language='JavaScript'>function confirmLink(){ bConfirm=confirm('Are you sure you want to delete this record?') return (bConfirm);}</script><?php//echo "<pre>";print_r($_REQUEST);echo "</pre>";//exit;//print_r($_SERVER);exit;//$k=urldecode($_SERVER[QUERY_STRING]);extract($_REQUEST);//********** SET Variables **********$dbName="budget";// DATABASE NAME//$dbTable="table name";// TABLE NAME should be passed from URL// Get beginning and ending dates for tableswitch($dbTable){case "exp_rev";$dateFld="acctdate";break;case "pcard";$dateFld="datenew";break;case "vendor_payments";$dateFld="datenew";break;}$sql="SELECT min( $dateFld )  AS minDate, max( $dateFld )  AS maxDateFROM `$dbTable`";$result = mysqli_query($connection, $sql); if($result){$row=mysqli_fetch_array($result);extract($row);$rangeOfDates=" which has records starting on $minDate and ending $maxDate.";}// FIELD NAMES are stored in $fieldArray// FIELD TYPES and SIZES are stored in $fieldType$sql = "SHOW COLUMNS FROM $dbTable";//echo "$sql";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$numFlds=mysqli_num_rows($result);while ($row=mysqli_fetch_assoc($result)){extract($row);$fieldArray[]=$row[Field];$fieldType[]=$row[Type];}$recordIDfld=$fieldArray[$numFlds-1];makeUpdateFields($fieldArray);// MAKE FIELD=VALUE FOR ADD/UPDATEfor($dk=0;$dk<count($fieldType);$dk++){$varD=substr($fieldType[$dk],0,7);if($varD=="decimal"){$fieldDecimal[]=$dk;}if($varD=="varchar"){$size=substr(substr($fieldType[$dk],8,7),0,-1);if($size>30){$size=30;}$fieldSize[]=$size;}else{$fieldSize[]=12;}}//print_r($fieldSize);//exit;// Find number fieldsfor($dk=0;$dk<count($fieldDecimal);$dk++){$t=$fieldDecimal[$dk];$varE[$fieldArray[$t]]=$fieldDecimal[$dk];}//print_r($varE);//exit;  //$varE = Any field(s) defined as Decimal //**** Process any Delete ******if($deleteRecord=="Delete"){//print_r($_REQUEST);exit;$query = "DELETE FROM $dbTable where $recordIDfld='$deleteRecordID'";//echo "$query";exit;$result = mysqli_query($connection, $query) or die ("Couldn't execute query Delete. $query");header("Location: portal.php?dbTable=$dbTable");exit;} //**** Process any Update or Add ******if($submit=="Update"){//echo "<pre>";print_r($_REQUEST);echo "</pre>";exit;$v=${$lastFld};$arr1=explode(",",$updateFields);for($j=0;$j<count($arr1);$j++){$arr2=explode("=",$arr1[$j]);$arr3[]=$arr2[0];}for($j=0;$j<count($arr1);$j++){$val1=$_REQUEST[$arr3[$j]];$newQuery[$arr3[$j]]=$val1;}$arrKeys=array_keys($newQuery);$queryString=$arrKeys[0]."='".$newQuery[$arrKeys[0]]."'";for($j=1;$j<count($arrKeys);$j++){$queryString.=", ".$arrKeys[$j]."='".$newQuery[$arrKeys[$j]]."'";}//echo "<pre>";print_r($arrKeys);print_r($newQuery);echo "</pre>$queryString<br>";exit;//print_r($newQuery);exit;$query = "Update $dbTable set $queryStringwhere $lastFld='$v'";//echo "$query";exit;$result = mysqli_query($connection, $query) or die ("Couldn't execute query Update. $query");header("Location: portal.php?dbTable=$dbTable&$lastFld=$v");exit;}//**** Process any Add ******if($submit=="Add"){$arr1=explode(",",$updateFields);for($j=0;$j<count($arr1);$j++){$arr2=explode("=",$arr1[$j]);$arr3[]=$arr2[0];}for($j=0;$j<count($arr1);$j++){$val1=$_REQUEST[$arr3[$j]];// Kludge for Budget increase/decrease// Would like to learn how to use JavaScript to negate number in inc_dec.phpif($plusMinus=="dec" and $arr3[$j]=="park_req"){$val1=-$val1;}$newQuery[$arr3[$j]]=$val1;}$arrKeys=array_keys($newQuery);$queryString=$arrKeys[0]."='".$newQuery[$arrKeys[0]]."'";for($j=1;$j<count($arrKeys);$j++){$queryString.=", ".$arrKeys[$j]."='".$newQuery[$arrKeys[$j]]."'";}//echo "<pre>";print_r($arrKeys);print_r($newQuery);echo "</pre>$queryString<br>";//print_r($queryString);exit;$query = "INSERT INTO $dbTable set $queryString";$result = mysqli_query($connection, $query) or die ("Couldn't execute query Update. $query");$v=mysql_insert_id();if($difFile){header("Location: portalReport.php?dbReport=Center&center=$center&submit=Submit&rccYN=Y");}else{header("Location: portal.php?dbTable=$dbTable&$recordIDfld=$v");}exit;}//**** Prepare To Find, Update OR Delete******if($lastFld){//print_r($_REQUEST);exit;$formType="Update";$passSQLedit=urlencode($passSQL);$addDeleteButton="<td><form><input type='hidden' name='passSQL' value='$passSQLedit'><input type='hidden' name='$lastFld' value='$var'><input type='hidden' name='deleteRecordID' value='$var'><input type='submit' name='deleteRecord' value='Delete' onClick='return confirmLink()'></form></td>";$sql0 = "SELECT * from $dbTable where $lastFld='$var'";$result = mysqli_query($connection, $sql0) or die ("Couldn't execute query 0. $sql0");$row=mysqli_fetch_array($result);extract($row);}else{if($addRecord=="Add a Record"){$formType="Add";}if($addRecord==""){$formType="Find";$addAddButton="<td><input type='hidden' name='dbTable' value='$dbTable'><input type='hidden' name='recordIDfld' value='$recordIDfld'><input type='submit' name='addRecord' value='Add a Record'></form></td>";}}//if($cat1_4){$catCheck="checked";}$newCKBX=array_unique($ckbx);sort($newCKBX);//print_r($newCKBX);//EXIT;$caseField1=$newCKBX[0];$caseField2=$newCKBX[1];$caseField3=$newCKBX[2];//$caseField4=$newCKBX[3];//$caseField5=$newCKBX[4];switch ($groupBy1) {		case "$caseField1":			$va3="";$va2="";$va1="";			$va1 = "checked";			break;			case "$caseField2":			$va3="";$va2="";$va1="";			$va2="checked";			break;			case "$caseField3":			$va3="";$va2="";$va1="";			$va3 ="checked";			break;	}switch ($groupBy2) {		case "$caseField1":			$vb3="";$vb2="";$vb1="";			$vb1 = "checked";			break;			case "$caseField2":			$vb3="";$vb2="";$vb1="";			$vb2="checked";			break;			case "$caseField3":			$vb3="";$vb2="";$vb1="";			$vb3 ="checked";			break;	}switch ($groupBy3) {		case "$caseField1":			$vc3="";$vc2="";$vc1="";			$vc1 = "checked";			break;			case "$caseField2":			$vc3="";$vc2="";$vc1="";			$vc2="checked";			break;			case "$caseField3":			$vc3="";$vc2="";$vc1="";			$vc3 ="checked";			break;		}function pullDown($m){global $like;$menu1=array("Like","Range","Not");if($like[$m]=="Like"){$like[$m]=1;}if($like[$m]=="Range"){$like[$m]=2;}if($like[$m]=="Not"){$like[$m]=3;}echo "<select name=\"like[$m]\"><option selected></option>";for ($n=0;$n<count($menu1);$n++){$con=$n+1;if($con==$like[$m]){$s="selected";}else{$s="value";}echo "<option $s='$con'>$menu1[$n]\n";       }  echo "</select>";}// Used \" instead of ' because of lastname or vendor name containing '//echo "<form action=\"portal.php\" method=\"post\">";echo "<form action=\"portal.php\"";// Used to debugecho "<table><tr><td colspan='3'>You are working with table <font color=\"blue\">$dbTable</font>$rangeOfDates</td></tr><tr><td>$fieldArray[0]:"; pullDown(0); echo "<input type=\"text\" name=\"$fieldArray[0]\" size=\"$fieldSize[0]\" value=\"${$fieldArray[0]}\"</td></tr><tr><td>$fieldArray[1]:"; pullDown(1); echo " <input type=\"text\" name=\"$fieldArray[1]\" size=\"$fieldSize[1]\" value=\"${$fieldArray[1]}\"></td>";// lastnamefor($i=2;$i<4;$i++){echo "<td>$fieldArray[$i]:  "; pullDown($i); echo "<input type=\"text\" name=\"$fieldArray[$i]\" size=\"$fieldSize[$i]\" value=\"${$fieldArray[$i]}\"></td>";}echo "<td></tr>";echo "<tr>";for($i=4;$i<7;$i++){echo "<td>$fieldArray[$i]:  "; pullDown($i); echo "<input type=\"text\" name=\"$fieldArray[$i]\" size=\"$fieldSize[$i]\" value=\"${$fieldArray[$i]}\"></td>";}echo "</tr>";// companyecho "<tr>";for($i=7;$i<10;$i++){echo "<td>$fieldArray[$i]:  "; pullDown($i); echo "<input type=\"text\" name=\"$fieldArray[$i]\" size=\"$fieldSize[$i]\" value=\"${$fieldArray[$i]}\"></td>";}echo "</tr><tr>";// amt$j=1;for($i=10;$i<23;$i++){if($fieldArray[$i]){$f=fmod($j,4);if($f==0){$tagB="<tr><td>";$tagE="</td></tr>";$j++;}else{$tagB="<td>";$tagE="</td>";$j++;}echo "$tagB $fieldArray[$i]:  "; pullDown($i); echo "<input type=\"text\" name=\"$fieldArray[$i]\" size=\"$fieldSize[$i]\" value=\"${$fieldArray[$i]}\">$tagE";}}echo "</table>";// Select GroupBy FieldsmakeGroupBySelect($fieldArray,$ckbx);// GroupBy radiosif($caseField1){echo "<table><tr><td>Group by:</td>";$radio1="groupBy1";makeGroupBy1($radio1,$caseField1,$caseField2,$caseField3,$va3,$va2,$va1,$ckbx);echo "</tr></table>";}if($caseField2){echo "<table><tr><td>Group by:</td>";$radio1="groupBy2";makeGroupBy2($radio1,$caseField1,$caseField2,$caseField3,$vb3,$vb2,$vb1,$ckbx);echo "</tr></table>";}if($caseField3){echo "<table><tr><td>Group by:</td>";$radio1="groupBy3";makeGroupBy3($radio1,$caseField1,$caseField2,$caseField3,$vc3,$vc2,$vc1,$ckbx);echo "</tr></table>";}echo "<table><tr><td><input type='hidden' name='dbTable' value='$dbTable'><input type='hidden' name='passSQL' value='$passSQLedit'><input type='hidden' name='lastFld' value='$lastFld'><input type='hidden' name='recordIDfld' value='$lastFld'><input type='hidden' name='$lastFld' value='$var'><input type='submit' name='submit' value='$formType'></form>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><form action='portal.php'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type='hidden' name='dbTable' value='$dbTable'><input type='submit' name='' value='Reset'></form</td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$addAddButton&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$addDeleteButton</tr></table>";  // ***** Pick display function and set sql statement$co=count($_REQUEST); //print_r($_REQUEST);echo "c=$co";exit;//$table="eedata0405";$from="*";// Default - gets used if not Group By// ******* Group By Variables*******// *** Make list of Fields to pass to GroupBy and Function portalHeader$passFields=$fieldArray[0];for($pf=1;$pf<count($fieldArray);$pf++){$passFields.=",".$fieldArray[$pf];}if($groupBy1!=""){$gb1_1=$caseField1;$groupBy=$ckbx[0];}else{$gb1_1="";}if($groupBy2!=""){$gb1_2=$caseField2;}else{$gb1_2="";}if($groupBy3!=""){$gb1_3=$caseField3;}else{$gb1_3="";}if($sumBy){$decimalKeys=array_keys($varE);$countKeys=count($decimalKeys);$fld0Dec=$decimalKeys[0];$fld1Dec=$decimalKeys[1];$fld2Dec=$decimalKeys[2];//echo "s1=$sumBy";//exit;if($fld1Dec){$sumBy="sum($fld1Dec) as sumFld1,";}if($fld0Dec){if($fld1Dec){$sumBy.="sum($fld0Dec) as sumFld0,(sum($fld1Dec) - sum($fld0Dec)) as sumFld2,";$totHeader=1;}else{$sumBy="sum($fld0Dec) as sumFld0,";$totHeader=1;}}if($fld2Dec){$sumBy.="sum($fld2Dec) as sumFld2,";}//echo "s=$sumBy";exit;}//elseif($sumBy==1){$sumBy="count($groupBy1) as countFld1,";$countHeader=1;if($groupBy2){$sumBy.="count($groupBy2) as countFld2,";$countHeader=2;}}//echo "<br>s2=$groupBy1 $groupBy2<br>";//exit;//echo "<br>s2=$sumBy";//exit;if($groupBy1!="" AND $sumBy!=""){//echo "hello";exit;// ************ GroupBy 1$from="$sumBy $passFields";$g="Group by $groupBy1";// ************ GroupBy 2// $from not used since all fields are referenced in groupBy1switch ($groupBy2) {		case "$gb1_1":			$g.=",$gb1_1";			break;			case "$gb1_2":			$g.=",$gb1_2";			break;			case "$gb1_3":			$g.=",$gb1_3";			break;			default:			$g="";	}// ************ GroupBy 3switch ($groupBy3) {		case "$gb1_1":			$g.=",$gb1_1";			break;			case "$gb1_2":			$g.=",$gb1_2";			break;			case "$gb1_3":			$g.=",$gb1_3";			break;			default:			$g="";	}}// end if $groupBy1 not blank// Remove any blank "," from $gwhile (substr($g,-1,1)==","){$g=substr($g,0,-1);}$from.=" From $dbTable";// ********* Assign passed Values by Fieldfor($j=0;$j<count($fieldArray);$j++){$passVal[$j]=${$fieldArray[$j]};}// ********* Where **********if($co>0){$where=" WHERE 1";}else{exit;}/*if($cat1_4){$where.=" and category >= '1' and category <= '4'";}else{if($category!=""){$where.=" and category = '$category'";}}*///                     **************************         Create WHERE statementfor($k=0;$k<count($fieldArray);$k++){if($passVal[$k]!=""){$dbFld=$fieldArray[$k];$dbVal=addslashes($passVal[$k]);if($like[$k]==""){$where.=" and $dbFld = '$dbVal'";}if($like[$k]==1){$where.=" and $dbFld like '%$dbVal%'";}if($like[$k]==2){$rangeDate=explode("*",$dbVal);if($rangeDate[0]!=""&&$rangeDate[1]==""){$where.=" and $dbFld='$rangeDate[0]'";}else{$where.=" and $dbFld>='$rangeDate[0]' and $dbFld<='$rangeDate[1]'";}}if($like[$k]=="3"){$where.=" and $dbFld != '$dbVal'";}}// order by $dbFld}// end for loopif($where==" WHERE 1"){exit;}if($where==" WHERE 1"&&$g=='Group by '&&$passSQL==''){exit;}if($g=="Group by ,,"){$g="";}$sql1 = "SELECT $from $where $g";if($passSQL){$sql1=urldecode($passSQL);}echo "$sql1<br>";//echo "<pre>";print_r($fieldArray);echo "</pre>";//exit;if($sql1){// ********** This displays the result **********include_once("portalFunctions.php");$passSQL=urlencode($sql1);getDecimalFields($varE);portalHeader($passSQL,$passFields,$countKeys,$sumBy,$totHeader,$countHeader);// Make Header$result = mysqli_query($connection, $sql1) or die ("Couldn't execute query. $sql1");$num=mysqli_num_rows($result);//echo "n=$num";if($num>1000){$sql1 = "SELECT $from $where $g limit 1000";$result = mysqli_query($connection, $sql1) or die ("Couldn't execute query. $sql1");echo "<font color='red'>$num</font> records were found. However, only the first <font color='red'>1000</font> are being displayed. Let Tom Howard know if you need to view more than 1000 at a time.<br>";}else{echo "$num <font color='green'>$z Items:$currPark</font><hr>";}// Access Levels are not used for this page/*// Park Level accessif($var==$park){$accessLevel="2";}else{$accessLevel="1";}// District wide accessif($_SESSION[itrak][level]=="2"){include_once("../../include/parkcodesDiv.inc");$a="array";$b="$var";$distArray=${$a.$b};if(in_array($park,$distArray)){$accessLevel="2";}else{$accessLevel="1";}}// System wide accessif($_SESSION[itrak][level]=="3"){$accessLevel="2";}*/// **********  using portalFunctions.php//print_r($varE);//exit;$decimalValues=array_values($varE);//print_r($decimalValues);//exit;$accessLevel=1;switch($accessLevel){	case "1":while ($row=mysqli_fetch_array($result)){//extract($row);//print_r($row);//exit;itemShow($row,$passSQL,$dbTable,$sumBy,$varE,$decimalValues);}	break;	case "2":while ($row=mysqli_fetch_array($result)){extract($row);itemEdit($invoice,$pe,$description,$debit,$credit,$sys,$acct,$center,$fund,$acctdate,$whid);}	break;	default:	echo "Access denied";exit;	}// end Switch$total1=number_format($total1,2);$fld0Tot=number_format($fld0Tot,2);$fld1Tot=number_format($fld1Tot,2);$fld2Tot=number_format($fld2Tot,2);//$timegivenTot=number_format($timegivenTot,0);if(!$g){echo "$fld0Dec = <font color='blue'>$fld0Tot&nbsp;&nbsp;&nbsp;</font>";if($fld1Dec){echo "$fld1Dec = <font color='teal'>$fld1Tot&nbsp;&nbsp;&nbsp;</font>";}if($fld2Dec){echo "$fld2Dec = <font color='purple'>$fld2Tot</font>";}}if($g){echo "<font color='purple'>[$g]</font>";}echo "</table></body></html>";}// **************  FUNCTIONS *******************function makeGroupBy1($radio1,$caseField1,$caseField2,$caseField3,$va3,$va2,$va1,$ckbx) {$z=count($ckbx);if($z>0){echo "<td><input type='radio' name='$radio1' value='$caseField1' $va1>$caseField1</td>";}if($z>1){echo "<td><input type='radio' name='$radio1' value='$caseField2' $va2>$caseField2</td>";}if($z>2){echo "<td><input type='radio' name='$radio1' value='$caseField3' $va3>$caseField3</td>";}echo "<td><input type='checkbox' name='sumBy' value='1'>Sum By</td>";}function makeGroupBy2($radio1,$caseField1,$caseField2,$caseField3,$vb3,$vb2,$vb1,$ckbx) {$z=count($ckbx);if($z>0){echo "<td><input type='radio' name='$radio1' value='$caseField1' $vb1>$caseField1</td>";}if($z>1){echo "<td><input type='radio' name='$radio1' value='$caseField2' $vb2>$caseField2</td>";}if($z>2){echo "<td><input type='radio' name='$radio1' value='$caseField3' $vb3>$caseField3</td>";}}function makeGroupBy3($radio1,$caseField1,$caseField2,$caseField3,$vc3,$vc2,$vc1,$ckbx) {$z=count($ckbx);if($z>0){echo "<td><input type='radio' name='$radio1' value='$caseField1' $vc1>$caseField1</td>";}if($z>1){echo "<td><input type='radio' name='$radio1' value='$caseField2' $vc2>$caseField2</td>";}if($z>2){echo "<td><input type='radio' name='$radio1' value='$caseField3' $vc3>$caseField3</td>";}}function makeUpdateFields($fieldArray){global $updateFields;for($i=0;$i<count($fieldArray);$i++){if($i!=0){$updateFields.=",".$fieldArray[$i]."=$".$fieldArray[$i];}else{$updateFields.=$fieldArray[$i]."=$".$fieldArray[$i];}}// end for}// end makeUpdateFields// Make Group By selection checkboxesfunction makeGroupBySelect($fieldArray,$ckbx){global $updateFields;echo "<table>";for($i=0;$i<count($fieldArray);$i++){$t=fmod($i,6);$name="ckbx[".$i."]";if($ckbx[$i]==$fieldArray[$i]){$c="checked";}else{$c="";}echo "<td><input type='checkbox' name='$name' value='$fieldArray[$i]' $c>$fieldArray[$i]</td>";if($i!=0 and $t==0){echo "<tr></tr>";}}// end forecho "</table>";}// end makeGroupBySelect?>