<?php$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/connectROOT.inc"); // connection parametersmysql_select_db($database, $connection); // databaseinclude("../../../include/authBUDGET.inc");extract($_REQUEST);$cy=$f_year;$pos=strpos($center,"-");if($pos){$center=explode("-",$center);$center=$center[2];}// Update purchase price, ordered and paid_in_full fields of equipment_request_3if($submit=="Update"){//print_r($ordered);while($a=current($ordered)){$en=key($ordered); $pp=str_replace(",","",$purchase_priceA[$en]); $query = "UPDATE equipment_request_3 set ordered='$ordered[$en]',paid_in_full='$paid_in_full[$en]', purchase_price='$pp' where er_num='$en'";//echo "<br>$query";exit;    $result = @MYSQL_QUERY($query,$connection);next($ordered);}header("Location:equip_balances?center=$center&f_year=$cy&m=1");exit;}// Display Query Resultsinclude_once("../../../include/parkcountyRCC.inc");if($_SESSION[budget][level<2]){$center=$_SESSION[budget][centerSess];}$query = "select parkcode from centerwhere 1 and center='$center'"; $result = @MYSQL_QUERY($query,$connection);$row=mysql_fetch_array($result);extract($row); $f_year=$_SESSION[budget][fy]; $query = "truncate table park_equipment_balances";    $result = @MYSQL_QUERY($query,$connection);$query = "insert into park_equipment_balances(er_num,approved,expenses,purchase_price,excess_shortage)select er_num,sum(request_amount),'','',''from equipment_request_3where 1 and park='$parkcode' and division_approved='y'and f_year='$cy'and acct like '534%'group by er_num;"; $result = @MYSQL_QUERY($query,$connection);//echo "$query<br>1<br>";$query = "insert into park_equipment_balances(er_num,approved,expenses,purchase_price,excess_shortage)select equipment_payments.er_num, '', sum(amount),'',''from equipment_paymentsleft join center on equipment_payments.center=center.centerwhere 1 and center.parkcode='$parkcode' and equipment_payments.f_year='$cy'group by equipment_payments.er_num";  $result = @MYSQL_QUERY($query,$connection);//echo "$query<br>2<br>";$query = "insert into park_equipment_balances(er_num,approved,expenses,purchase_price,excess_shortage)select er_num,'','',sum(purchase_price),''from equipment_request_3where 1 and park='$parkcode' and division_approved='y'and f_year='$cy'group by er_num";  $result = @MYSQL_QUERY($query,$connection);//echo "$query<br>3<br>";$query = "insert into park_equipment_balances(er_num,approved,expenses,purchase_price,excess_shortage)select er_num,'','','',sum(request_amount-purchase_price) as 'excess_shortage'from equipment_request_3where 1 and park='$parkcode'and division_approved='y'and f_year='$cy'and ordered='y'group by er_num";  $result = @MYSQL_QUERY($query,$connection);//echo "$query<br>4<br>";/*select query for equipment*/$sql="select park, equipment_description, equipment_request_3.acct as 'NCAS_Account',funding_source,park_equipment_balances.er_num, sum(approved) as 'approved', sum(park_equipment_balances.purchase_price) as 'purchase_price', sum(excess_shortage) as 'excess_shortage', ordered,paid_in_fullfrom park_equipment_balancesleft join equipment_request_3 on park_equipment_balances.er_num=equipment_request_3.er_numwhere 1 and park_equipment_balances.er_num != 'na'group by park_equipment_balances.er_num;";//echo "$sql<br>";exit;//if($showSQL=="1"){echo "$sql<br>";//exit;}$varQuery=$_SERVER[QUERY_STRING];if($rep==""){if($m==1){$message="<tr><td colspan='9' align='right'><font color='purple'>Update has been made.</font></td></tr>";}echo "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='equip_balances.php?$varQuery&rep=excel'>Excel Export</a>";}$goBack="<tr><td colspan='10' align='center'><font size='+1'><a href='center_level_budgets.php?center=$center&f_year=$cy'>Return</a></font> to <font color='green'>Park Budget</font></td></tr>";echo "<form><table border='1' align='center'>$goBack$message<tr>";$header="<th>park</th><th>equipment<br>description</th><th>NCAS<br>Account</th><th>Funding<br>Source</th><th>er_num</th><th>approved</th><th>purchase<br>price</th><th>excess<br>shortage</th><th>ordered</th><th>paid_in_full</th>";echo "$header</tr>";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");//$num=mysql_num_rows($result);while($row=mysql_fetch_array($result)){extract($row);$tot_approve+=$approved;$tot_purchase+=$purchase_price;$tot_excess_short+=$excess_shortage;$approved=numFormat($approved);$purchase_price=numFormat($purchase_price);$excess_shortage=numFormat($excess_shortage);if($ordered=='n'){$ckON="checked";$ckOY="";}else{$ckOY="checked";$ckON="";}$orderRadio="<font color='green'>Y</font><input type='radio' name='ordered[$er_num]' value='y'$ckOY><font color='red'>N</font><input type='radio' name='ordered[$er_num]' value='n'$ckON>";if($paid_in_full=='n'){$ckPN="checked";$ckPY="";}else{$ckPY="checked";$ckPN="";}$orderPaid="<font color='green'>Y</font><input type='radio' name='paid_in_full[$er_num]' value='y'$ckPY><font color='red'>N</font><input type='radio' name='paid_in_full[$er_num]' value='n'$ckPN>";$body ="<tr><td align='center'>$park</td><td align='left'>$equipment_description</td><td align='left'>$NCAS_Account</td><td align='left'>$funding_source</td><td align='center'>$er_num</td><td align='right'>$approved</td><td align='right'><input type='text' name='purchase_priceA[$er_num]' value='$purchase_price' size='10'></td><td align='right'>$excess_shortage</td><td align='center'>$orderRadio</td><td align='center'>$orderPaid</td></tr>";echo "$body";}$tot_approve=numFormat($tot_approve);$tot_purchase=numFormat($tot_purchase);$tot_excess_short=numFormat($tot_excess_short);echo "<tr><td><input type='hidden' name='center' value='$center'></td><td><input type='hidden' name='f_year' value='$cy'></td><td colspan='4' align='right'>$tot_approve</td><td align='right'>$tot_purchase</td><td align='right'>$tot_excess_short</td><td colspan='2' align='center'><input type='submit' name='submit' value='Update'></td></tr>";echo "</table></form></body></html>";function numFormat($nf){$nf=number_format($nf,2);return $nf;}?>