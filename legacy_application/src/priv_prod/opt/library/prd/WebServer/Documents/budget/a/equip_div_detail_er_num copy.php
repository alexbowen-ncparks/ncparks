<?php$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/connectROOT.inc"); // connection parametersmysql_select_db($database, $connection); // databaseinclude("../../../include/authBUDGET.inc");extract($_REQUEST);//echo "<pre>"; print_r($_SESSION); echo "</pre>"; // exit;$level=$_SESSION['budget']['level'];// Construct Query to be passed to Excel Exportforeach($_REQUEST as $k => $v){if($v and $k!="PHPSESSID"){$varQuery.=$k."=".$v."&";}}$passQuery=$varQuery;   $varQuery.="rep=excel";    if($rep=="excel"){header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment; filename=equipment_order_status.xls');}if($level==2){//include_once("../a/park_budget_menu.php");unset($menuArray);include_once("../../../include/parkRCC.inc");//if($today>=$Lev2range[1] and $today<=$Lev2range[0]){}else{$noUpdate=1;}$distCode=$_SESSION['budget']['select'];//echo "<table align='center'><form action=\"op_exp_approval.php\">";switch($distCode){case "EADI":$distCode="east";break;case "NODI":$distCode="north";break;case "SODI":$distCode="south";break;case "WEDI":$distCode="west";break;}$D=$distCode."-NCAS";$DP=$distCode."-PARK";$array1=array($D,$DP);$where="where dist='$distCode' and section='operations' and fund='1280'";$sql="SELECT section,parkcode,center as varCenter from center $where order by section,parkcode,center";$result = mysql_query($sql) or die ("Couldn't execute query 1. $sql");while ($row=mysql_fetch_array($result)){extract($row);$pc[]=$parkcode;$c[]=$varCenter;$sec[]=$section;}if($rep==""){echo "<table align='center'><form><tr>";echo "<td><select name=\"center\"><option selected>Select Center</option>";for ($n=0;$n<count($c);$n++){$con=$c[$n];if($center==$con){$s="selected";}else{$s="value";}		echo "<option $s='$con'>$sec[$n]-$pc[$n]-$c[$n]\n";       }   echo "</select>  FY <input type='text' name='f_year' value='$f_year' size='5' READONLY> <input type='submit' name='submit' value='Submit'></td></form></tr>";}if($center==""){exit;}}if($level==1){	$centercode=$_SESSION['budget']['select'];	$centerS=$_SESSION['budget']['centerSess'];}//if($submit!="Submit"){exit;}include("../~f_year.php");$sql=" TRUNCATE TABLE equipment_division_detail_by_er_num; ";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br /><br />";}$sql="INSERT INTO equipment_division_detail_by_er_num( er_num, center,funds_allocated, ordered_amount, unordered_amount, ordered_count, unordered_count, budget ) SELECT er_num, pay_center,sum( unit_quantity*unit_cost ) , '', '', '', '', '' FROM equipment_request_3 WHERE 1 AND f_year = '$f_year' AND division_approved = 'y' and ncas_account like '534%' GROUP BY er_num;";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br /><br />";}$sql="INSERT INTO equipment_division_detail_by_er_num( er_num, center,funds_allocated, ordered_amount, unordered_amount, ordered_count, unordered_count, budget ) SELECT er_num, pay_center,'', sum( ordered_amount ) , '', '', '', '' FROM equipment_request_3 WHERE 1 AND f_year = '$f_year' AND division_approved = 'y' AND order_complete = 'y' and ncas_account like '534%' GROUP BY er_num;";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br /><br />";}$sql="INSERT INTO equipment_division_detail_by_er_num( er_num, center,funds_allocated, ordered_amount, unordered_amount, ordered_count, unordered_count, budget ) SELECT er_num,pay_center, '', '', sum( unit_quantity*unit_cost ) , '', '', '' FROM equipment_request_3 WHERE 1 AND f_year = '$f_year' AND division_approved = 'y' AND order_complete = 'n' and ncas_account like '534%' GROUP BY er_num;";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br /><br />";}$sql="INSERT INTO equipment_division_detail_by_er_num( er_num, center,funds_allocated, ordered_amount, unordered_amount, ordered_count, unordered_count, budget ) SELECT er_num,pay_center, '', '', '', count( id ) , '', '' FROM equipment_request_3 WHERE 1 AND f_year = '$f_year' AND division_approved = 'y' AND order_complete = 'y' and ncas_account like '534%' GROUP BY er_num;";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br /><br />";}$sql="INSERT INTO equipment_division_detail_by_er_num( er_num, center,funds_allocated, ordered_amount, unordered_amount, ordered_count, unordered_count, budget ) SELECT er_num,pay_center, '', '', '', '', count( id ) , '' FROM equipment_request_3 WHERE 1 AND f_year = '$f_year' AND division_approved = 'y' AND order_complete = 'n' and ncas_account like '534%' GROUP BY er_num;";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br /><br />";}$sql="INSERT INTO equipment_division_detail_by_er_num( er_num, center,funds_allocated, ordered_amount, unordered_amount, ordered_count, unordered_count, budget ) SELECT er_num,pay_center, '', '', '', '', '', sum( unit_quantity*unit_cost ) FROM equipment_request_3 WHERE 1 AND f_year = '$f_year' AND division_approved = 'y' AND ncas_account like '534%' GROUP BY er_num;";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br /><br />";}$sql="update equipment_division_detail_by_er_num,equipment_request_3set equipment_division_detail_by_er_num.equipment_description=equipment_request_3.equipment_descriptionwhere equipment_division_detail_by_er_num.er_num=equipment_request_3.er_num;";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br /><br />";}$sql="truncate table equipment_division_detail_by_er_num2;";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br /><br />";}$sql="insert into equipment_division_detail_by_er_num2(center,parkcode,er_num,equipment_description,ordered_amount,unordered_amount,total_allocated,payments)SELECT equipment_division_detail_by_er_num.center,center.parkcode, equipment_division_detail_by_er_num.er_num, equipment_division_detail_by_er_num.equipment_description,sum( ordered_amount ) AS 'ordered_amount', sum( unordered_amount ) AS 'unordered_amount' , sum(ordered_amount+unordered_amount) as 'total_allocated','' FROM equipment_division_detail_by_er_num left join center on equipment_division_detail_by_er_num.center=center.center WHERE 1 GROUP BY equipment_division_detail_by_er_num.er_num order by er_num;";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br /><br />";}$sql="truncate table equipment_payments_calculation1;";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br /><br />";}$sql="insert into equipment_payments_calculation1(er_num,payments,source)selecter_num,sum(ncas_invoice_amount),'cvip'from cid_vendor_invoice_paymentswhere 1and er_num != ''and ncas_credit !='x'group by er_num;";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br /><br />";}$sql="insert into equipment_payments_calculation1(er_num,payments,source)selecter_num,-sum(ncas_invoice_amount),'cvip'from cid_vendor_invoice_paymentswhere 1and er_num != ''and ncas_credit ='x'group by er_num;";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br /><br />";}$sql="insert into equipment_payments_calculation1(er_num,payments,source)selectequipnum,sum(amount),'pcu'from pcard_unreconciledwhere 1and equipnum != ''group by equipnum;";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br /><br />";}$sql="truncate table equipment_payments_calculation2;";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br /><br />";}$sql="insert into equipment_payments_calculation2(er_num,payments)select er_num,sum(payments)from equipment_payments_calculation1where 1group by er_num;";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br /><br />";}$sql="update equipment_division_detail_by_er_num2,equipment_payments_calculation2set equipment_division_detail_by_er_num2.payments=equipment_payments_calculation2.paymentswhere equipment_division_detail_by_er_num2.er_num=equipment_payments_calculation2.er_num;";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br /><br />";}echo "<table border='1'>";if($rep==""){echo "<tr><td colspan='14'>";echo "<a href='equip_div_detail_er_num.php?$varQuery&rep=excel'>Excel Export</a>";//echo "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Report Date: <font color='red'>$today</font>&nbsp;&nbsp;&nbsp; $t</td></tr>";}$sql="select center.section,center.dist as 'district',equipment_division_detail_by_er_num2.parkcode,equipment_division_detail_by_er_num2.center,equipment_division_detail_by_er_num2.er_num,equipment_division_detail_by_er_num2.equipment_description,equipment_division_detail_by_er_num2.ordered_amount,equipment_division_detail_by_er_num2.unordered_amount,equipment_division_detail_by_er_num2.total_allocated,equipment_request_3.order_complete,equipment_division_detail_by_er_num2.paymentsfrom equipment_division_detail_by_er_num2left join equipment_request_3 on equipment_division_detail_by_er_num2.er_num=equipment_request_3.er_numleft join center on equipment_division_detail_by_er_num2.center=center.centerwhere 1and equipment_division_detail_by_er_num2.center='$center'order by parkcode;";if($showSQL=="1"){echo "<br /><br />$sql<br /><br />";}//echo "$sql<br /><br />";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");$num=mysql_num_rows($result);while($row=mysql_fetch_assoc($result)){$b[]=$row;}// end while$includeArray=array("parkcode","er_num","equipment_description","ordered_amount","unordered_amount","total_allocated","order_complete","payments");foreach($b[0] as $k=>$v){	if(!in_array($k,$includeArray)){continue;}		$headerArray[]=$k;		$header.="<th>$k</th>";		}//echo "<pre>";print_r($headerArray);echo "</pre>";exit;$decimalFlds=array("ordered_amount","unordered_amount","total_allocated","payments");if($rep==""){echo "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color='red'>$num records returned.</font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Close this window when done.</td></tr>";}if($rep=="excel"){echo "<tr>$header</tr>";}$yy=10;echo "<tr>";	for($i=0;$i<count($b);$i++){	if(fmod($i,$yy)==0 and $rep==""){echo "<tr>$header</tr><tr><td></td></tr>";}if($b[$i]['order_complete']=="y"){$bc=" bgcolor='beige'";}else{$bc=" bgcolor='white'";}echo "<tr$bc>";	for($j=0;$j<count($headerArray);$j++){		$var=$b[$i][$headerArray[$j]];		$fieldName=$headerArray[$j];		$totArray[$headerArray[$j]]+=$var;	$a="<td>";		if(in_array($headerArray[$j],$decimalFlds)){			$a="<td align='right'>";			$var=numFormat($var);}				if($var=="0.00"){$var="-";}		if($fieldName=="payments" AND $var!="-"){		$er_num=$b[$i]['er_num'];		$var="<a href='/budget/aDiv/er_display.php?er_num=$er_num' target='_blank'>$var</a>";}						echo "$a$var</td>";	}	echo "</tr>";	}// Totalsecho "<tr>";	for($j=0;$j<count($headerArray);$j++){	if(!in_array($headerArray[$j],$decimalFlds)){echo "<td></td>";continue;}	if($totArray[$headerArray[$j]]){		$var=$totArray[$headerArray[$j]];		if(in_array($headerArray[$j],$decimalFlds)){$var=numFormat($var);}			echo "<td align='right'><b>$var</b></td>";}}echo "</tr>";echo "</table>";echo "</body></html>";function numFormat($nf){$nf=number_format($nf,2);return $nf;}?>