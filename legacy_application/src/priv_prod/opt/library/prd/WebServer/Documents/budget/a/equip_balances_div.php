<?php$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/iConnect.inc"); // connection parametersmysqli_select_db($connection, $database); // databaseinclude("../../../include/authBUDGET.inc");//print_r($_SESSION);print_r($_REQUEST);extract($_REQUEST);if($rep==""){include_once("../menu.php");}$cy=$f_year;$pos=strpos($center,"-");if($pos){$center=explode("-",$center);$center=$center[2];}// Update purchase price, ordered and paid_in_full fields of equipment_request_3if($submit=="Update"){//print_r($ordered);while($a=current($ordered)){$en=key($ordered); $pp=str_replace(",","",$purchase_priceA[$en]); $query = "UPDATE equipment_request_3 set ordered='$ordered[$en]',paid_in_full='$paid_in_full[$en]', purchase_price='$pp' where er_num='$en'";//echo "<br>$query";exit;    $result = @mysqli_query($connection, $query,$connection);next($ordered);}//header("Location:equip_balances?center=$center&f_year=$cy&m=1");exit;}// Display Query Resultsinclude_once("../../../include/parkcountyRCC.inc");if($_SESSION[budget][level<2]){$center=$_SESSION[budget][centerSess];}/*$query1 = "select parkcode from centerwhere 1 and center='$center'"; $result = @mysqli_query($connection, $query1,$connection);$row=mysqli_fetch_array($result);extract($row); */ //$f_year=$_SESSION[budget][fy];/* Get most recent FY from act3. This will determine whether INSERTS are needed  */ $query = "SELECT max(f_year) as checkFY from `equipment_request_3`"; $result = @mysqli_query($connection, $query,$connection); $row=mysqli_fetch_array($result);extract($row); //if($f_year!=$checkFY){ $query = "truncate table park_equipment_balances_div";    $result = @mysqli_query($connection, $query,$connection);$query = "insert into park_equipment_balances_div(er_num,approved,expenses,purchase_price,excess_shortage)select er_num,sum(request_amount),'','',''from equipment_request_3where 1 and division_approved='y'and f_year='$cy'group by er_num;"; $result = @mysqli_query($connection, $query,$connection);echo "$query<br>1<br>";$query = "insert into park_equipment_balances_div(er_num,approved,expenses,purchase_price,excess_shortage)select equipment_payments.er_num, '', sum(amount),'',''from equipment_paymentsleft join center on equipment_payments.center=center.centerwhere 1 and equipment_payments.f_year='$cy'group by equipment_payments.er_num";  $result = @mysqli_query($connection, $query,$connection);echo "$query<br>2<br>";$query = "insert into park_equipment_balances_div(er_num,approved,expenses,purchase_price,excess_shortage)select er_num,'','',sum(purchase_price),''from equipment_request_3where 1 and division_approved='y'and f_year='$cy'group by er_num";  $result = @mysqli_query($connection, $query,$connection);echo "$query<br>3<br>";$query = "insert into park_equipment_balances_div(er_num,approved,expenses,purchase_price,excess_shortage)select er_num,'','','',sum(request_amount-purchase_price) as 'excess_shortage'from equipment_request_3where 1 and division_approved='y'and f_year='$cy'and ordered='y'and purchase_price>0group by er_num";  $result = @mysqli_query($connection, $query,$connection);echo "$query<br>4<br>";//}if($parkPass){$where="and park='$parkPass'";}/*select query for equipment*/$sql="select park, equipment_description, equipment_request_3.acct as 'NCAS_Account',funding_source,park_equipment_balances_div.er_num, sum(approved) as 'approved', sum(park_equipment_balances_div.purchase_price) as 'purchase_price', sum(excess_shortage) as 'excess_shortage', ordered,paid_in_fullfrom park_equipment_balances_divleft join equipment_request_3 on park_equipment_balances_div.er_num=equipment_request_3.er_numwhere 1 and park_equipment_balances_div.er_num != 'na'$wheregroup by park_equipment_balances_div.er_numorder by park,ordered,paid_in_full";echo "$sql<br>";//exit;//if($showSQL=="1"){echo "$sql<br>";//exit;}$varQuery=$_SERVER[QUERY_STRING];if($rep==""){$query = "SELECT distinct park from equipment_request_3 order by park";    $result = @mysqli_query($connection, $query,$connection);    while($row=mysqli_fetch_array($result)){    $parkArray[]=strtoupper($row[0]);    	}    	// Menu 1echo "<table><tr><td><form>Parkcode: <select name=\"ref\" onChange=\"MM_jumpMenu('parent',this,0)\"><option selected></option>";$s="value";foreach($parkArray as $k => $v){		echo "<option $s='equip_balances_div.php?f_year=0607&parkPass=$v'>$v\n";       }   echo "</select></form></td>";//  print_r($parkArray);   if($m==1){$message="<td colspan='9' align='right'><font color='purple'>Update has been made.</font></td></tr>";}echo "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='equip_balances_div.php?$varQuery&rep=excel'>Excel Export</a></td>";   echo "</tr></table>";//$goBack="<tr><td colspan='10' align='center'><font size='+1'><a href='center_level_budgets.php?center=$center&f_year=$cy'>Return</a></font> to <font color='green'>Park Budget</font></td></tr>";}if($rep=="excel"){header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment; filename=Equipment_Balances.xls');}echo "<form><table border='1' align='center'>$goBack$message<tr>";$header="<th>park</th><th>equipment<br>description</th><th>NCAS<br>Account</th><th>Funding<br>Source</th><th>er_num</th><th>approved</th><th>purchase<br>price</th><th>excess<br>shortage</th><th>&nbsp;&nbsp;ordered&nbsp;&nbsp;</th><th>paid_in_full</th>";echo "$header</tr>";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");//$num=mysqli_num_rows($result);while($row=mysqli_fetch_array($result)){extract($row);$tot_approve+=$approved;$tot_purchase+=$purchase_price;$tot_excess_short+=$excess_shortage;$approved=numFormat($approved);$purchase_price=numFormat($purchase_price);$excess_shortage=numFormat($excess_shortage);/*if($ordered=='n'){$ckON="checked";$ckOY="";}else{$ckOY="checked";$ckON="";}$orderRadio="<font color='green'>Y</font><input type='radio' name='ordered[$er_num]' value='y'$ckOY><font color='red'>N</font><input type='radio' name='ordered[$er_num]' value='n'$ckON>";if($paid_in_full=='n'){$ckPN="checked";$ckPY="";}else{$ckPY="checked";$ckPN="";}$orderPaid="<font color='green'>Y</font><input type='radio' name='paid_in_full[$er_num]' value='y'$ckPY><font color='red'>N</font><input type='radio' name='paid_in_full[$er_num]' value='n'$ckPN>";*//*echo "<td align='right'><input type='text' name='purchase_priceA[$er_num]' value='$purchase_price' size='10'></td>";*//*echo "<td align='center'>$orderRadio</td><td align='center'>$orderPaid</td>";*/$body ="<tr><td align='center'>$park</td><td align='left'>$equipment_description</td><td align='center'>$NCAS_Account</td><td align='center'>$funding_source</td><td align='center'>$er_num</td><td align='right'>$approved</td><td align='right'>$purchase_price</td><td align='right'>$excess_shortage</td><td align='right'>$ordered</td><td align='right'>$paid_in_full</td></tr>";echo "$body";}$tot_approve=numFormat($tot_approve);$tot_purchase=numFormat($tot_purchase);$tot_excess_short=numFormat($tot_excess_short);echo "<tr><td><input type='hidden' name='center' value='$center'></td><td><input type='hidden' name='f_year' value='$cy'></td><td colspan='4' align='right'>$tot_approve</td><td align='right'>$tot_purchase</td><td align='right'>$tot_excess_short</td>";//echo "<td colspan='2' align='center'><input type='submit' name='submit' value='Update'></td>";echo "</tr>";echo "</table></form></body></html>";function numFormat($nf){$nf=number_format($nf,2);return $nf;}?>