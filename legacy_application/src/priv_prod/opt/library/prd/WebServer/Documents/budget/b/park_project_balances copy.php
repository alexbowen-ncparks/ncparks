<?php//session_start();include("../../../include/authBUDGET.inc");//echo "<pre>";print_r($_SESSION);echo "</pre>";//exit;$dbTable="partf_payments";$file="park_project_balances.php";$fileMenu="park_project_balances_menu.php";//echo "<pre>";print_r($_REQUEST);echo "</pre>";//exit;//$level=$_SESSION[budget][level];// now set in authBUDGET.incextract($_REQUEST);$distPark=strtoupper($parkcode);$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/connectROOT.inc"); // connection parametersmysql_select_db($database, $connection); // database// ******** Display Expenses Sub by Center ***********if($expense=="1"){$sql="SELECT proj_num, center, datenew, invoice, vendorname, pcard_vendor, pcard_name, account, coa.park_acct_desc AS  'acct_desc', amount, purch_descr_input AS  'purch_desc'FROM partf_paymentsLEFT  JOIN coa ON partf_payments.account = coa.ncasnumWHERE proj_num =  '$projnum'ORDER  BY  `center` , datenew DESC";$result = mysql_query($sql) or die ("Couldn't execute query 0. $sql");//if($showSQL=="1"){echo "$sql<br><br>";}echo "<table align='center' border='1'><tr><th>Project Number</th><th>Center</th><th>Date</th><th>Invoice</th><th>Vendor Name</th><th>Pcard Vendor</th><th>Pcard name</th><th>Account</th><th>Account Desc.</th><th>Amount</th><th>Purchase Desc.</th></tr>";$i=0;while($row=mysql_fetch_array($result)){extract($row);$amountF=number_format($amount,2);if($i!=0 AND $ckCenter!=$center){$subCenterF=number_format($subCenter,2);echo "<tr><td colspan='9' align='right'><b>Subtotal for Center $ckCenter:</b></td><td  align='right'>$subCenterF</td></tr>";$subCenter="";echo "<tr><td>$proj_num</td><td>$center</td><td>$datenew</td><td>$invoice</td><td>$vendorname</td><td>$pcard_vendor</td><td>$pcard_name</td><td>$account</td><td>$acct_desc</td><td align='right'>$amountF</td><td>$purch_desc</td></tr>";}else{echo "<tr><td>$proj_num</td><td>$center</td><td>$datenew</td><td>$invoice</td><td>$vendorname</td><td>$pcard_vendor</td><td>$pcard_name</td><td>$account</td><td>$acct_desc</td><td align='right'>$amountF</td><td>$purch_desc</td></tr>";}$i++;$ckCenter=$center;$subCenter=$subCenter+$amount;$total=$total+$amount;}// end while$subCenterF=number_format($subCenter,2);$totalF=number_format($total,2);echo "<tr><td colspan='9' align='right'><b>Subtotal for Center $ckCenter:</b></td><td  align='right'>$subCenterF</td></tr><tr><td colspan='9' align='right'><b>Grand Total:</b></td><td  align='right'>$totalF</td></tr>";echo "<tr><td colspan='11' align='center'>Click your browser's back button to return to Project Balances.</td></table>";exit;}// ******** Edit/Update Status ***********if($submit=="Update"){$query="UPDATE `partf_projects` set statusper='$statusPer' WHERE projnum='$projnum'";//echo "$query";exit;$result = mysql_query($query) or die ("Couldn't execute query 0. $query");if($cen){header("Location: /budget/b/prtf_center_budget_a.php?center=$cen&submit=Submit");}else{header("Location: park_project_balances.php?parkcode=$park");}}if($status=="1"){$s_array=array("OH","IP","FI","NS","CA","TR");$sql="SELECT * FROM `partf_projects` WHERE projnum='$projnum'";$result = mysql_query($sql) or die ("Couldn't execute query 0. $sql");$row=mysql_fetch_array($result);extract($row);echo "<form action='park_project_balances.php'><table align='center' border='1'><tr><th>Project Number</th><th>Park</th><th>Project Name</th><th>Project Status</th></tr><tr><td align='center'>$projNum</td><td>$park</td><td>$projName</td><td align='center'><select name='statusPer'>\n";for($i=0;$i<count($s_array);$i++){ if($statusPer==$s_array[$i]){$v="selected";}else{$v="value";}     echo "<option $v='$s_array[$i]'>$s_array[$i]\n";}echo "</select></td></tr><tr><td colspan='4' align='center'><input type='hidden' name='park' value='$park'><input type='hidden' name='projnum' value='$projnum'><input type='hidden' name='cen' value='$cen'><input type='submit' name='submit' value='Update'></table></form>";exit;}// **************  Show Results ***************// Get most recent date from Exp_Rev$sql="SELECT DATE_FORMAT(max(datenew),'Report Date: %c/%e/%y') as maxDate FROM `partf_payments` WHERE 1";$result = mysql_query($sql) or die ("Couldn't execute query 0. $sql");$row=mysql_fetch_array($result);extract($row);if($rep=="excel"){header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment; filename=prtf_center_budget.xls');}// ******** Show Results ***********if($rep==""){$varQuery=$_SERVER[QUERY_STRING];include("$fileMenu");if($varQuery){echo "<a href='$file?$varQuery&rep=excel'>Excel Export</a>";}}$WHERE="where 1 and projyn='y'";// Determine accessif($level>2){$WHERE.=" and park='$parkcode'";}if($level==2){include_once("../../../include/parkRCC.inc");$parkList=$_SESSION[budget][select];// Get district$da=${"array".$parkList};// print_r($da);exit;if(in_array($parkList,$da)){$parkcode=strtoupper($parkcode);if(in_array($parkcode,$da)){$WHERE.=" and park='$parkcode'";}else{echo "<br>No access for $parkcode";exit;}}else{echo "<br><br>You do not have access privileges for this database [$db] report at $level $posTitle. Contact Tom Howard tom.howard@ncmail.net if you wish to gain access.<br>park_project_balances.php<br>budget.php<br>dist=$parkList $distPark";exit;}}if($level==1){$parkcode=strtoupper($parkcode);$parkcodePass=$parkcode;$a=array("prtf_center_budget","park_project_balances");if(is_array($_SESSION[budget][report])){$b0=$_SESSION[budget][report][0]; $b1=$_SESSION[budget][report][1];}else{$b0=$_SESSION[budget][report];}if(in_array($b0,$a) or in_array($b1,$a)){//Workaround for NERI/MOJEif($_SESSION[budget][select]=="NERI" and ($parkcode=="NERI" or $parkcode=="MOJE")){// pass parkcode}else{$temp=$_SESSION[budget][tempID];$parkcode=$_SESSION[budget][select];if($_SESSION[budget][manager]){$parkcode=$parkcodePass;}}//$access="and partf_projects.park='$parkcode'";$WHERE.=" and park='$parkcode'";}else{$rep=$_SESSION[budget][report];echo "You do not have access privileges for this database [$db] report at $level $posTitle. Contact Tom Howard tom.howard@ncmail.net if you wish to gain access.<br><br>budget.php<br>";print_r($a);print_r($_SESSION[budget][report]);exit;}}if($parkcode!=""){if($statusFilter!=""){$statusA=explode(",",$statusFilter);for($sf=0;$sf<count($statusA);$sf++){if($sf==0){$whereSF="and (statusper='$statusA[$sf]'";}$whereSF.=" OR statusper='$statusA[$sf]'";}$whereSF.=")";} $query = "update partf_projectsset project_center_year_type=concat(projnum,'-',center,'-',yearfundf,'-',projcat)where 1";    $result = @MYSQL_QUERY($query,$connection);if($showSQL=="1"){echo "<br><br>$query<br><br>";}     $query = "truncate table park_project_balances";    $result = @MYSQL_QUERY($query,$connection);if($showSQL=="1"){echo "$query<br><br>";} $query = "insert into park_project_balances(projnum,approved,expenses)select projnum,sum(div_app_amt),''from partf_projects$WHEREgroup by projnum;";  $result = @MYSQL_QUERY($query,$connection);if($showSQL=="1"){echo "$query<br><br>";} $af=mysql_affected_rows();if($af==0){echo "No project found for $query";exit;}//echo "<br>$query<br>"; $query = "insert into park_project_balances(projnum,approved,expenses)select proj_num, '', sum(amount)from partf_paymentsleft join partf_projects on partf_payments.proj_num=partf_projects.projnum$WHEREgroup by partf_payments.proj_num";   $result = @MYSQL_QUERY($query,$connection);if($showSQL=="1"){echo "$query<br><br>";} $query = "select park,projname,partf_projects.project_center_year_type, sum(approved) as 'approved', sum(expenses) as 'expenses',sum(approved-expenses) as 'balance', statusper as 'status',partf_projects.projnumfrom park_project_balancesleft join partf_projects on park_project_balances.projnum=partf_projects.projnumwhere 1 $whereSFgroup by park_project_balances.projnumorder by partf_projects.center,partf_projects.projnum";   $result = @MYSQL_QUERY($query,$connection);if($showSQL=="1"){echo "$query<br><br>";}   //echo "<tr><td colspan='9'>$query</td></tr>";echo "<table border='1' cellpadding='3' align='center'>";echo "<tr><td colspan='9' align='center'>Park Project Balances using PARTF_Payments <font color='red'>$maxDate</font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type='button' value='Status Codes' onclick=\"return popitup('terminology.php')\"></td></tr><tr><th>park</th><th>projname</th><th>project<br>center<br>year<br>type</th><th align='right'>approved</th>";//echo "<th align='right'>pm_allocation</th>";echo "<th align='right'>expenses</th><th align='right'>balance</th><th>status</th>";echo "</tr>";while($row = mysql_fetch_array($result)){extract($row);$approvedF=number_format($approved,2);//$pm_link="<a href='prtf_pm_allocation.php?projnum=$projnum'>".number_format($pm_allocation,2)."</a>";$expensesF=number_format($expenses,2);$balanceF=number_format($balance,2);$manager=strtolower($manager);$park=strtoupper($park);$project_center_year_type=strtolower($project_center_year_type);echo "<tr>";echo "<td>$park</td><td>$projname</td><td>$project_center_year_type</td><td align='right'>$approvedF</td>";$expense_link="<a href='park_project_balances.php?projnum=$projnum&expense=1'>".$expensesF."</a>";echo "<td align='right'>$expense_link</td>";if($balance<0){$color="red";}else{$color="black";}echo "<td align='right'><font color='$color'>$balanceF</font></td>";if($level>3){$status_link="<a href='park_project_balances.php?projnum=$projnum&status=1'>".$status."</a>";}else{$t=explode("-",$project_center_year_type);if($t[3]=="mm"||$t[3]=="tm"||$t[3]=="er"||$t[3]=="de"){$status_link="<a href='park_project_balances.php?projnum=$projnum&status=1'>".$status."</a>";}else{$status_link="$status";}}echo "<td align='center'>$status_link</td>";echo "</tr>";$total_approved=$total_approved+$approved;$total_pm=$total_pm+$pm_allocation;$total_expenses=$total_expenses+$expenses;$total_balance=$total_balance+$balance;}// end while$total_approved=number_format($total_approved,2);$total_pm=number_format($total_pm,2);$total_expenses=number_format($total_expenses,2);$total_balance=number_format($total_balance,2);echo "<tr><td colspan='4' align='right'><b>$total_approved</b></td>";//echo "<td align='right'><b>$total_pm</b></td>";echo "<td align='right'><b>$total_expenses</b></td><td align='right'><b>$total_balance</b></td></tr></table>";}// end ifecho "</div></body></html>";?>