<?phpinclude("../../include/connectBUDGET.inc");// database connection parametersextract($_REQUEST);if($rep==""){$year=date("Y");$month=date("m")-1;$fullMonth=date("F", mktime(0,0,0,$month,1,$year));$month=str_pad(date("m")-1,2,"0",STR_PAD_LEFT);if(!$start){$start=$year.$month."01";}$cont="true";$test=27;while(($test<=32)&&($cont)){$cont=checkdate($month,$test,$year);if(!$cont){$lastday=$test-1;} $test++;}if(!$end){$end=$year.$month.$lastday;}include_once("menu.php");if($allRecords=="all"){$ck1="checked";}else{$ck2="checked";}echo "<div align='center'><form action='ReportPARTF.php'><table><tr><td><input type='radio' name='allRecords' value='all' $ck1><b>All Records</b></td><td><input type='radio' name='allRecords' value='partf' $ck2><b>PARTF Report</b>&nbsp;&nbsp;</td><td>Start Date (yyyymmdd): <input type='text' name='start' size='10' value='$start'></td><td>End Date (yyyymmdd): <input type='text' name='end' size='10' value='$end'></td>";if(!$reportMonth){$reportMonth=$month.", ".$year;}echo "<td>Current Report Month: <input type='text' name='reportMonth' size='15' value='$reportMonth'>";echo "<input type='submit' name='submit' value='Find'></form></td></tr></table><form></div>";}if($submit==""){exit;}// ************ A lot happens HERE partf_fund_total.php ***********include_once("partf_fund_total.php");if($allRecords=="all"){$where="where datePost!=''";$fldPARTF="tempPARTF_all";}else{$where="where reportDisplay='Y' and datePost!=''";$fldPARTF="tempPARTF_all";}//*********** SWITCH ***************	switch ($g) {		case "county":$select="DISTINCT partf_projects.county, sum(partf_payments.amount) as amtFrom partf_projects LEFT JOIN partf_payments on partf_projects.projNum=partf_payments.charg_proj_num$whereGROUP BY countyORDER BY county";	$sql = "SELECT $select";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$num=mysqli_num_rows($result);while($row=mysqli_fetch_array($result)){extract($row);// don't send $partf_approv_num use funds.credit insteadmakeReport($projNum,$projYN,$reportDisplay,$projCat,$projSCnum,$projDENRnum,$Center,$budgCode,$comp,$projsup,$manager,$fundMan,$YearFundC,$YearFundF,$fullname,$dist,$county,$section,$fullname,$projName,$active,$startDate,$endDate,$statusProj,$percentCom,$statusPer,$comments,$commentsI,$dateadded,$brucefy,$proj_man,$secondCounty,$res_proj,$partfyn,$femayn,$fema_proj_num,$mult_proj,$bond_fund,$state_appro,$reserve_proj,$design,$construction,$partfid,$amt,$credit);}			break;			case "dist":$select="DISTINCT partf_projects.dist, sum(partf_payments.amount) as amtFrom partf_projects LEFT JOIN partf_payments on partf_projects.projNum=partf_payments.charg_proj_num$whereGROUP BY distORDER BY dist";	$sql = "SELECT $select";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$num=mysqli_num_rows($result);while($row=mysqli_fetch_array($result)){extract($row);// don't send $partf_approv_num use funds.credit insteadmakeReport($projNum,$projYN,$reportDisplay,$projCat,$projSCnum,$projDENRnum,$Center,$budgCode,$comp,$projsup,$manager,$fundMan,$YearFundC,$YearFundF,$fullname,$dist,$county,$section,$fullname,$projName,$active,$startDate,$endDate,$statusProj,$percentCom,$statusPer,$comments,$commentsI,$dateadded,$brucefy,$proj_man,$secondCounty,$res_proj,$partfyn,$femayn,$fema_proj_num,$mult_proj,$bond_fund,$state_appro,$reserve_proj,$design,$construction,$partfid,$amt,$credit);}			break;			case "park":$select="DISTINCT partf_projects.park, sum(partf_payments.amount) as amtFrom partf_projects LEFT JOIN partf_payments on partf_projects.projNum=partf_payments.charg_proj_num$whereGROUP BY parkORDER BY park";	$sql = "SELECT $select";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$num=mysqli_num_rows($result);while($row=mysqli_fetch_array($result)){extract($row);// don't send $partf_approv_num use funds.credit insteadmakeReport($projNum,$projYN,$reportDisplay,$projCat,$projSCnum,$projDENRnum,$Center,$budgCode,$comp,$projsup,$manager,$fundMan,$YearFundC,$YearFundF,$fullname,$dist,$county,$section,$fullname,$projName,$active,$startDate,$endDate,$statusProj,$percentCom,$statusPer,$comments,$commentsI,$dateadded,$brucefy,$proj_man,$secondCounty,$res_proj,$partfyn,$femayn,$fema_proj_num,$mult_proj,$bond_fund,$state_appro,$reserve_proj,$design,$construction,$partfid,$amt,$credit);}			break;			case "Center":$select="DISTINCT partf_projects.Center, sum(partf_payments.amount) as amt,funds.creditFrom partf_projects LEFT JOIN partf_payments on partf_projects.projNum=partf_payments.charg_proj_numLEFT JOIN funds on partf_projects.projNum=funds.projNum$whereGROUP BY CenterORDER BY Center";	$sql = "SELECT $select";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$num=mysqli_num_rows($result);while($row=mysqli_fetch_array($result)){extract($row);// don't send $partf_approv_num use funds.credit insteadmakeReport($projNum,$projYN,$reportDisplay,$projCat,$projSCnum,$projDENRnum,$Center,$budgCode,$comp,$projsup,$manager,$fundMan,$YearFundC,$YearFundF,$fullname,$dist,$county,$section,$fullname,$projName,$active,$startDate,$endDate,$statusProj,$percentCom,$statusPer,$comments,$commentsI,$dateadded,$brucefy,$proj_man,$secondCounty,$res_proj,$partfyn,$femayn,$fema_proj_num,$mult_proj,$bond_fund,$state_appro,$reserve_proj,$design,$construction,$partfid,$amt,$credit);}			break;			case "comp":// First get the allocated funds in an array$where="where reportDisplay='Y'";			$select="DISTINCT comp, sum(funds.credit) AS creditFROM partf_projects LEFT JOIN funds ON partf_projects.projNum = funds.projNum$whereGROUP  BY comp";$sql = "SELECT $select";//echo "$sql";exit;$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$num=mysqli_num_rows($result);while($row=mysqli_fetch_array($result)){extract($row);$arrayCom[]=$comp;$arrayCredit[]=$credit;}// Next get the payments in an array$where="where reportDisplay='Y' and datePost!=''";			$select="DISTINCT comp, sum(partf_payments.amount) as amtFROM partf_projects LEFT JOIN partf_payments on partf_projects.projNum=partf_payments.charg_proj_num$whereGROUP  BY comp";$sql = "SELECT $select";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");while($row=mysqli_fetch_array($result)){extract($row);$arrayAmt[]=$amt;}for($i=0;$i<$num;$i++){// now output values$amt=$arrayAmt[$i];$credit=$arrayCredit[$i];$comp=$arrayCom[$i];makeReport($projNum,$projYN,$reportDisplay,$projCat,$projSCnum,$projDENRnum,$Center,$budgCode,$comp,$projsup,$manager,$fundMan,$YearFundC,$YearFundF,$fullname,$dist,$county,$section,$fullname,$projName,$active,$startDate,$endDate,$statusProj,$percentCom,$statusPer,$comments,$commentsI,$dateadded,$brucefy,$proj_man,$secondCounty,$res_proj,$partfyn,$femayn,$fema_proj_num,$mult_proj,$bond_fund,$state_appro,$reserve_proj,$design,$construction,$partfid,$amt,$credit);}			break;			default:// *******************************************************// Get Info for All Account and creditif($sort){$orderby="ORDER BY $sort";}else{$orderby="ORDER BY comp,budgecode DESC,partf_projects.Center";}$orderby="ORDER BY comp,YearFundC DESC,partf_projects.Center";//echo "<pre>";print_r($_REQUEST);//print_r($_SESSION);echo "</pre>";//echo "s=$s";//exit;if($allRecords=="all"){$select="partf_projects.projNum,".$fldPARTF.".credit,YearFundC,Center,budgCode,comp,proj_man,YearFundF,fullname,dist,county,projName,startDate,endDate,design,construction,statusPer,commentsFrom partf_projects LEFT JOIN $fldPARTF on partf_projects.projNum=".$fldPARTF.".projNumGROUP BY partf_projects.projNum$orderby";}else{$select="partf_projects.projNum,".$fldPARTF.".credit,YearFundC,Center,budgCode,comp,proj_man,YearFundF,fullname,dist,county,projName,startDate,endDate,design,construction,statusPer,commentsFrom partf_projects LEFT JOIN $fldPARTF on partf_projects.projNum=".$fldPARTF.".projNumwhere reportDisplay='Y' GROUP BY partf_projects.projNum$orderby";}$sql = "SELECT $select";$passSQL=$sql;if($rep==""){echo "$sql";//exit;}$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$num=mysqli_num_rows($result);while($row=mysqli_fetch_array($result)){extract($row);$arrayAllCredits[$projNum]=$credit;$tempVal=strlen($credit);// Length of name (used in PDF)if($tempVal>$Creditwidth){$Creditwidth=$tempVal;}$arrayYearFundC[$projNum]=$YearFundC;$arrayCenter[$projNum]=$Center;$arraybudgCode[$projNum]=$budgCode;$arraycomp[$projNum]=$comp;$arrayproj_man[$projNum]=$proj_man;$arrayYearFundF[$projNum]=$YearFundF;$arraypark[$projNum]=$fullname;$tempVal=strlen($fullname);// Length of name (used in PDF)if($tempVal>$Parkwidth){$Parkwidth=$tempVal;}$arraydist[$projNum]=$dist;$arraycounty[$projNum]=$county;$tempVal=strlen($dist.", ".$county);// Length of name (used in PDF)if($tempVal>$DCwidth){$DCwidth=$tempVal;}$test=strlen($projName);if($test>34){$projName=substr($projName,0,34).".";}$arrayprojName[$projNum]=$projName;$tempVal=strlen($projName);// Length of name (used in PDF)if($tempVal>$PNwidth){$PNwidth=$tempVal;}$arraystartDate[$projNum]=$startDate;$arrayendDate[$projNum]=$endDate;$arraystatusDesign[$projNum]=$design;$arraystatusConstruct[$projNum]=$construction;$arraystatusPer[$projNum]=$statusPer;$arraycomments[$projNum]=$comments;}//echo "$sql<pre>";print_r($arraystatusDesign);print_r($arraystatusConstruct);echo "</pre>";exit;$sql = "SELECT sum( amount ) as cumAmountTotFROM `partf_payments`where datenew<='$end'";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$row=mysqli_fetch_array($result);extract($row);// Get ALL payments (only project numbers with payments are returned)// Need to merge with All Accounts credit// Added query just above which may have eliminated the need for this query?$select="partf_projects.projNum, sum(partf_payments.amount) as amtFrom partf_projects LEFT JOIN partf_payments on partf_projects.projNum=partf_payments.charg_proj_num$whereGROUP BY partf_projects.projNum$orderby";$sql = "SELECT $select";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$num=mysqli_num_rows($result);while($row=mysqli_fetch_array($result)){extract($row);$arrayAllPayments[$projNum]=$amt;$tempVal=strlen($amt);// Length of name (used in PDF)if($tempVal>$PFwidth){$PFwidth=$tempVal;}}//echo "$sql<pre>";print_r($arrayAllPayments);echo "</pre>";exit;// Get SOME payments for date range (only project numbers with payments are returned)// Need to merge with All Accounts creditif($start){$ce="Current Activity ($start - $end)";$where=$where." and datenew>='$start' ";}if($end){$where=$where." and datenew<='$end' ";}$select="partf_projects.*, sum(partf_payments.amount) as amtFrom partf_projects LEFT JOIN partf_payments on partf_projects.projNum=partf_payments.charg_proj_num$whereGROUP BY partf_projects.projNum$orderby";$sql = "SELECT $select";if($rep==""){echo "<br><br>$sql<br>";//exit;}$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");//$num=mysqli_num_rows($result);while($row=mysqli_fetch_array($result)){extract($row);$arraySomePayments[$projNum]=$amt;$tempVal=strlen($amt);// Length of name (used in PDF)if($tempVal>$Expensewidth){$Expensewidth=$tempVal;}// don't send $partf_approv_num use funds.credit instead}// end while//echo "$sql<pre>";print_r($arraySomePayments);echo "</pre>";exit;	}// end Switch$year=substr($end,0,4);$month=substr($end,4,2);$day=substr($end,6,2);$thruDate=strtoupper(date("F d, Y",mktime("0","0","0",$month,$day,$year)));if($rep=="pdf"){include("reports/DPR_pdf.php");}else {include("reports/displayDDP.php");}?>