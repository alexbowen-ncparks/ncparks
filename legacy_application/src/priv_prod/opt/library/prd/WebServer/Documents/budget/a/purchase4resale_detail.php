<?phpinclude("../../../include/authBUDGET.inc");$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/iConnect.inc"); // connection parametersmysqli_select_db($connection, $database); // database// Get most recent date from Exp_Rev$sql="SELECT DATE_FORMAT(max(acctdate),'Report Date: %c/%e/%y') as maxDate FROM `exp_rev` WHERE 1";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 0. $sql");$row=mysqli_fetch_array($result);extract($row);if($rep=="excel"){header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment; filename=purchase4resale_detail.xls');}//print_r($_SESSION);//EXIT;// *********** Level > 2 ************if($_SESSION[budget][level]>2){//print_r($_REQUEST);EXIT;$sql="SELECT  DISTINCT section FROM  `center`";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 1. $sql");while ($row=mysqli_fetch_array($result)){extract($row);$sectArray1[]="sect-x-".$section;$sectArray2[]=ucfirst($section)."(ALL)-NCAS#";}$scopeArray=array("east-dist-NCAS"=>"Budget-purchase4resale Operations(East)","north-dist-NCAS"=>"Budget-purchase4resale Operations(North)","south-dist-NCAS"=>"Budget-purchase4resale Operations(South)","west-dist-NCAS"=>"Budget-purchase4resale Operations(West)","oper-stwd-NCAS"=>"Budget-purchase4resale Operations(Stwd)","oper-all-NCAS"=>"Budget-purchase4resale Operations(ALL)","cons-all-NCAS"=>"Budget-purchase4resale Construction(ALL)","plad-all-NCAS"=>"Budget-purchase4resale Planning&Admin(ALL)","div-all-NCAS"=>"Budget-purchase4resale total-Division");if($rep==""){include_once("../menu.php");echo "<table><form action=\"purchase4resale_detail.php\">";// Menu 1echo "<td>Scope: <select name=\"scopeMenu\"><option selected></option>";while (list($key,$val)=each($scopeArray)){		echo "<option value='$key'>$val\n";       }    echo "</select></td>";// Menu 2$sql="SELECT section,parkcode,center as varCenter from center where fund='1280' order by section,parkcode,center";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 1. $sql");while ($row=mysqli_fetch_array($result)){extract($row);$pc[]=$parkcode;$c[]=$varCenter;$sec[]=$section;}echo "<td><select name=\"center\"><option selected>Select Center</option>";$s="value";for ($n=0;$n<count($c);$n++){$con=$c[$n];		echo "<option $s='$con'>$sec[$n]-$pc[$n]-$c[$n]\n";       }   echo "</select><input type='submit' name='submit' value='Submit'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type='checkbox' name='showSQL' value='1'>Show SQL</form></td></tr></table>";}$groupBy="GROUP  BY pfr.ncasnum, pfr.center";if($scopeMenu){// *********** Set Scopelist($dist_sect,$scope,$orderByToggle)=explode("-",$scopeMenu);if($orderByToggle=="NCAS"){$GroupByToggle="x";$orderBy="ORDER BY pfr.ncasnum,center.dist,center.parkcode";if($scope=="dist"){$limitWhere=" AND center.dist='$dist_sect' AND center.section='operations'";}if($scope=="all"){$limitWhere=" AND center.section='operations'";$orderBy="ORDER BY pfr.ncasnum,center.dist,center.parkcode";if($dist_sect=="div"){$differentSQL="SELECT center.section, center.dist, center.parkcode, pfr.center,  - sum( pfr.spent0203 )  AS spent0203,  - sum( pfr.spent0304 )  AS spent0304,  - sum( pfr.spent0405 )  AS  'spent0405',  - sum( pfr.spent0506 )  AS  'spent0506', sum( pfr.spent0405 - pfr.spent0506 )  AS  'Excess_Shortage'FROM  `pfr` LEFT  JOIN center ON pfr.center = center.centerLEFT  JOIN coa ON pfr.ncasnum = coa.ncasnumWHERE 1  AND ( coa.acct_group =  'revenue-purchase4resale' OR coa.acct_group =  'supplies-purchase4resale' )GROUP  BY pfr.centerORDER  BY center.section, center.dist, center.parkcode";}}if($scope=="stwd"){$limitWhere=" AND center.dist='stwd' AND center.section='operations'";}}else{$orderBy="ORDER BY center.parkcode,pfr.ncasnum";}}else{// *********** Set Center$whichCenter="AND center.center='$center'";$orderBy="ORDER BY pfr.ncasnum";}if($dist_sect=="cons"){$limitWhere="AND (section = 'construction')";}if($dist_sect=="plad"){$limitWhere="AND (section != 'operations' and section != 'construction')";$whichCenter="";if($orderByToggle=="x"){$orderBy="ORDER BY pfr.ncasnum,center.section";}else{$orderBy="ORDER BY center.parkcode,pfr.ncasnum";}}if($dist_sect=="OPERrev"||$dist_sect=="PLADrev"||$dist_sect=="CONSrev"){// move to another file for ALL Revision queriesinclude("revisions.php");exit;}if($center==""){exit;}}// end Level > 2// ************* Level 2 *****************if($_SESSION[budget][level] == 2){//print_r($_REQUEST);EXIT;if($rep==""){include_once("../menu.php");include_once("../../../include/parkRCC.inc");$distCode=$_SESSION[budget][select];echo "<table><form action=\"purchase4resale_detail.php\">";switch($distCode){case "EADI":$distCode="east";break;case "NODI":$distCode="north";break;case "SODI":$distCode="south";break;case "WEDI":$distCode="west";break;}$D=$distCode."-NCAS";$DP=$distCode."-PARK";$array1=array($D,$DP);// Menu 1echo "<td>Scope: <select name=\"scopeMenu\"><option selected></option>";$s="value";for ($n=0;$n<count($array1);$n++){$con=$array1[$n];		echo "<option $s='$con'>$array1[$n]\n";       }   echo "</select></td>";   $parkList=$_SESSION[budget][select];$da=${"array".$parkList}; //print_r($da);exit;while (list($key,$val)=each($da)){$parkList=$parkList.",".$val;}$where="where FIND_IN_SET(center.parkCode,'$parkList')>''";// Menu 2$sql="SELECT section,parkcode,center as varCenter from center $where order by section,parkcode,center";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 1. $sql");while ($row=mysqli_fetch_array($result)){extract($row);$pc[]=$parkcode;$c[]=$varCenter;$sec[]=$section;}echo "<td><select name=\"center\"><option selected>Select Center</option>";$s="value";for ($n=0;$n<count($c);$n++){$con=$c[$n];		echo "<option $s='$con'>$sec[$n]-$pc[$n]-$c[$n]\n";       }   echo "</select><input type='submit' name='submit' value='Submit'></form></td></tr></table>";}// *********** Set Scopelist($dist_sect,$orderByToggle)=explode("-",$scopeMenu);if($orderByToggle=="NCAS"){$GroupByToggle="x";$orderBy="ORDER BY pfr.ncasnum,center.dist,center.parkcode";if($dist_sect!="sect"){$limitWhere=" AND center.section='operations'";}}else{$orderBy="ORDER BY center.parkcode";}if($scopeMenu){list($dist_sect,$orderByToggle,$sect)=explode("-",$scopeMenu);if($dist_sect=="sect"){$whichCenter="AND center.section='$sect'";}else{$whichCenter="AND center.dist='$dist_sect'";}}else{$whichCenter="AND center.center='$center'";}if($center==""){exit;}}// end Level = 2// *********** Level 1 ************if($_SESSION[budget][level]==1){if($rep==""){include_once("../menu.php");}include_once("../../../include/parkcountyRCC.inc");include_once("subDist.php");$groupBy="GROUP  BY pfr.ncasnum, pfr.center";}// end Level = 1// *********** Check Level **************if($_SESSION[budget][level]==2){list($dist_sect,$orderByToggle)=explode("-",$scopeMenu);switch($dist_sect){case "east":$distCode="EADI";break;case "north":$distCode="NODI";break;case "south":$distCode="SODI";break;case "west":$distCode="WEDI";break;}if($_SESSION[budget][select]!=$distCode){echo "$distCodeAccess denied";exit;}}$sql="SELECT pfr.ncasnum, coa.park_acct_desc AS  'description', center.section, center.dist, center.parkcode, pfr.center, sum( pfr.spent0203 )  AS spent0203, sum( pfr.spent0304 )  AS spent0304, sum( pfr.spent0405 )  AS  'spent0405', sum( pfr.parkinc0506 + pfr.distinc0506 )  AS  'inc0506', (round(sum( pfr.parkinc0506 + pfr.distinc0506 )  / sum( pfr.spent0405 +  '.01'  )*100)) as 'inc0506_perc', sum( pfr.spent0405 + pfr.parkinc0506 + pfr.distinc0506 )  AS  'request0506', sum( pfr.spent0506 )  AS  'spent0506', sum( pfr.spent0405 + pfr.parkinc0506 + pfr.distinc0506 - pfr.spent0506 )  AS  'available'FROM  `pfr`LEFT  JOIN center ON pfr.center = center.centerLEFT  JOIN coa ON pfr.ncasnum = coa.ncasnumWHERE 1  AND ( coa.acct_group =  'revenue-purchase4resale' OR coa.acct_group =  'supplies-purchase4resale' ) $whichCenter $limitWhere$groupBy$orderBy";// *******************************************************************// Switch SQL  if($dist_sect=="div"){$sql=$differentSQL;}//echo "$sql<br>";exit;if($showSQL=="1"){echo "$sql<br>";//exit;}$varQuery=$_SERVER[QUERY_STRING];$title=$scopeArray[$scopeMenu]." ".$maxDate;if($center!="Select Center"){$title="Budget-purchase4resale - Center: ".$center;}if($rep==""){echo "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='purchase4resale_detail.php?$varQuery&rep=excel&title=$title'>Excel Export</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$title<br>";if($dist_sect!="div"){echo "<table border='1'><tr><th>NCAS#</th><th>DESCRIPTION</th><th>SECTION</th><th>DIST</th><th>PARK</th><th>CENTER</th><th>Spent 0203</th><th>Spent 0304</th><th>Spent 0405</th><th>Increase<br>Decrease</th><th>Percent<br>Inc_Dec</th><th>0506 Req</th><th>0506 Spent</th><th>Available</th></tr>";}else{echo "<table border='1'><tr><th>SECTION</th><th>DIST</th><th>PARK</th><th>CENTER</th><th>CF0203</th><th>CF0304</th><th>CF0405</th><th>CF0506</th><th>Excess/Shortage</th></tr>";}}// rep==""else{if($dist_sect!="div"){echo "<table border='1'><tr><th colspan='8'>$title</th></tr><tr><th>NCAS#</th><th>DESCRIPTION</th><th>SECTION</th><th>DIST</th><th>PARK</th><th>CENTER</th><th>Spent 0203</th><th>Spent 0304</th><th>Spent 0405</th><th>Increase<br>Decrease</th><th>Percent<br>Inc_Dec</th><th>0506 Req</th><th>0506 Spent</th><th>Available</th></tr>";}else{echo "<table border='1'><tr><th colspan='8'>$title</th></tr><tr><th>SECTION</th><th>DIST</th><th>PARK</th><th>CENTER</th><th>CF0203</th><th>CF0304</th><th>CF0405</th><th>CF0506</th><th>Excess/Shortage</th></tr>";}}if($GroupByToggle=="x"){$checkField="ncasnum";}else{$checkField="parkcode";}//if($rep=="excel"){//echo "x=$dist_sect";exit;//}$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");//$num=mysqli_num_rows($result);//while($row=mysqli_fetch_array($result)){//extract($row);if($dist_sect!="div"){include("Inc_pur_4_resale_default.php");}else{include("Inc_pur_4_resale_Division.php");}?> 