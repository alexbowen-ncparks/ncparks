<?php$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/iConnect.inc"); // connection parametersmysqli_select_db($connection, $database); // databaseinclude("../../../include/authBUDGET.inc");extract($_REQUEST);//print_r($_SESSION);EXIT;//print_r($_REQUEST);//EXIT;// Get most recent date from Exp_Rev$sql="SELECT DATE_FORMAT(max(acctdate),'Report Date: %c/%e/%y') as maxDate FROM `exp_rev` WHERE 1";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 0. $sql");$row=mysqli_fetch_array($result);extract($row);if($rep=="excel"){header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment; filename=Budget_Revenue.xls');}$groupBy="GROUP  BY revenue.ncasnum, revenue.center";// *********** Level > 2 ************if($_SESSION[budget][level]>2){//print_r($_REQUEST);EXIT;$sql="SELECT  DISTINCT section FROM  `center`";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 1. $sql");while ($row=mysqli_fetch_array($result)){extract($row);$sectArray1[]="sect-x-".$section;$sectArray2[]=$section."-NCAS#";$sectArray3[]="sect-y-".$section;$sectArray4[]=$section."-PARK";}if($rep==""){include_once("../menu.php");echo "<table><form action=\"budget_rev_detail.php\">";$array1=array("east-x","north-x","south-x","west-x","east","north","south","west");$array2=array("EADI-NCAS#","NODI-NCAS#","SODI-NCAS#","WEDI-NCAS#","EADI-PARK","NODI-PARK","SODI-PARK","WEDI-PARK");$menuArray1=array_merge($array1,$sectArray1);$menuArray1=array_merge($menuArray1,$sectArray3);$menuArray2=array_merge($array2,$sectArray2);$menuArray2=array_merge($menuArray2,$sectArray4);// Menu 1echo "<td>Scope: <select name=\"scopeMenu\"><option selected></option>";$s="value";for ($n=0;$n<count($menuArray2);$n++){$con=$menuArray1[$n];		echo "<option $s='$con'>$menuArray2[$n]\n";       }echo "<option $s='div-x'>Budget-Revenues total-Division\n";   echo "</select></td>";// Menu 2$sql="SELECT section,parkcode,center as varCenter from center where fund='1280' order by section,parkcode,center";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 1. $sql");while ($row=mysqli_fetch_array($result)){extract($row);$pc[]=$parkcode;$c[]=$varCenter;$sec[]=$section;}echo "<td><select name=\"center\"><option selected>Select Center</option>";$s="value";for ($n=0;$n<count($c);$n++){$con=$c[$n];		echo "<option $s='$con'>$sec[$n]-$pc[$n]-$c[$n]\n";       }   echo "</select><input type='submit' name='submit' value='Submit'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type='checkbox' name='showSQL' value='1'>Show SQL</form></td></tr></table>";}// *********** Set Scopelist($dist_sect,$orderByToggle)=explode("-",$scopeMenu);if($orderByToggle=="x" || $orderByToggle=="NCAS"){$GroupByToggle="x";$orderBy="ORDER BY revenue.ncasnum,center.dist,center.parkcode";if($dist_sect!="sect"){$limitWhere=" AND center.section='operations'";}}else{$orderBy="ORDER BY center.parkcode,revenue.ncasnum";}if($scopeMenu){list($dist_sect,$orderByToggle,$sect)=explode("-",$scopeMenu);if($dist_sect=="sect"){$whichCenter="AND center.section='$sect'";}else{$whichCenter="AND center.dist='$dist_sect'";}}else{$whichCenter="AND center.center='$center'";$orderBy="ORDER BY revenue.ncasnum";}if($dist_sect=="div"){$whichCenter="";$orderBy="ORDER BY center.section, center.dist, center.parkcode";$groupBy="GROUP  BY revenue.center";$differentSQL="SELECT center.section, center.dist, center.parkcode, revenue.center,  - sum( revenue.spent0203 )  AS spent0203,  - sum( revenue.spent0304 )  AS spent0304,  - sum( revenue.spent0405 )  AS  'spent0405',  - sum( revenue.spent0506 )  AS  'spent0506', sum( revenue.spent0405 - revenue.spent0506 )  AS  'Excess_Shortage'FROM  `revenue` LEFT  JOIN center ON revenue.center = center.centerLEFT  JOIN coa ON revenue.ncasnum = coa.ncasnumWHERE 1  AND (coa.acct_group =  'revenue-other' or coa.acct_group = 'revenue-purchase4resale')$groupBy$orderBy";}if($center==""){exit;}}// end Level > 2// ************* Level 2 *****************if($_SESSION[budget][level] == 2){//print_r($_REQUEST);EXIT;if($rep==""){include_once("../menu.php");include_once("../../../include/parkRCC.inc");$distCode=$_SESSION[budget][select];echo "<table><form action=\"budget_rev_detail.php\">";switch($distCode){case "EADI":$distCode="east";break;case "NODI":$distCode="north";break;case "SODI":$distCode="south";break;case "WEDI":$distCode="west";break;}$D=$distCode."-NCAS";$DP=$distCode."-PARK";$array1=array($D,$DP);// Menu 1echo "<td>Scope: <select name=\"scopeMenu\"><option selected></option>";$s="value";for ($n=0;$n<count($array1);$n++){$con=$array1[$n];		echo "<option $s='$con'>$array1[$n]\n";       }   echo "</select></td>";   $parkList=$_SESSION[budget][select];$da=${"array".$parkList}; //print_r($da);exit;while (list($key,$val)=each($da)){$parkList=$parkList.",".$val;}$where="where FIND_IN_SET(center.parkCode,'$parkList')>''";// Menu 2$sql="SELECT section,parkcode,center as varCenter from center $where order by section,parkcode,center";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 1. $sql");while ($row=mysqli_fetch_array($result)){extract($row);$pc[]=$parkcode;$c[]=$varCenter;$sec[]=$section;}echo "<td><select name=\"center\"><option selected>Select Center</option>";$s="value";for ($n=0;$n<count($c);$n++){$con=$c[$n];		echo "<option $s='$con'>$sec[$n]-$pc[$n]-$c[$n]\n";       }   echo "</select><input type='submit' name='submit' value='Submit'></form></td></tr></table>";}// *********** Set Scopelist($dist_sect,$orderByToggle)=explode("-",$scopeMenu);if($orderByToggle=="NCAS"){$GroupByToggle="x";$orderBy="ORDER BY revenue.ncasnum,center.dist,center.parkcode";if($dist_sect!="sect"){$limitWhere=" AND center.section='operations'";}}else{$orderBy="ORDER BY center.parkcode";}if($scopeMenu){list($dist_sect,$orderByToggle,$sect)=explode("-",$scopeMenu);if($dist_sect=="sect"){$whichCenter="AND center.section='$sect'";}else{$whichCenter="AND center.dist='$dist_sect'";}}else{$whichCenter="AND center.center='$center'";}if($center==""){exit;}}// end Level = 2// *********** Level 1 ************if($_SESSION[budget][level]==1){include_once("../menu.php");include_once("../../../include/parkcountyRCC.inc");include_once("subDist.php");}// end Level = 1// *********** Check Level **************if($_SESSION[budget][level]==2){list($dist_sect,$orderByToggle)=explode("-",$scopeMenu);switch($dist_sect){case "east":$distCode="EADI";break;case "north":$distCode="NODI";break;case "south":$distCode="SODI";break;case "west":$distCode="WEDI";break;}/*if($_SESSION[budget][select]!=$dist_sect){echo "$distCodeAccess denied $dist_sect";exit;}*/}$sql = "SELECT revenue.ncasnum, coa.park_acct_desc AS  'description', center.section, center.dist, center.parkcode, revenue.center, sum( revenue.spent0203 )  AS spent0203, sum( revenue.spent0304 )  AS spent0304, sum( revenue.spent0405 )  AS  'spent0405', sum( revenue.parkinc0506 + revenue.distinc0506 )  AS  'inc0506', ( round( sum( revenue.parkinc0506 + revenue.distinc0506 )  / sum( revenue.spent0405 +  '.01'  )  *100  )  ) AS  'inc0506_perc', sum( revenue.spent0405 + revenue.parkinc0506 + revenue.distinc0506 )  AS  'request_0506', sum( revenue.spent0506 )  AS  'spent0506', sum( revenue.spent0405 + revenue.parkinc0506 + revenue.distinc0506 - revenue.spent0506 )  AS  'available'FROM  `revenue`LEFT  JOIN center ON revenue.center = center.centerLEFT  JOIN coa ON revenue.ncasnum = coa.ncasnumWHERE 1  AND coa.acct_group =  'revenue-other'$whichCenter$groupBy$orderBy";// *******************************************************************// Switch SQL  if($dist_sect=="div"){$sql=$differentSQL;}//echo "$sql<br>";exit;if($showSQL=="1"){echo "$sql<br>";//exit;}$varQuery=$_SERVER[QUERY_STRING];if($GroupByToggle=="x"){$checkField="ncasnum";}else{$checkField="parkcode";}$title="Budget-Revenues ".$sect." ".$dist_sect." ".$maxDate;if($dist_sect=="div"){$title="Budget-Revenues total-Division - ".$maxDate;$checkField="center";}if($rep==""){echo "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='budget_rev_detail.php?$varQuery&rep=excel&title=$title'>Excel Export</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$title<br>";if($dist_sect!="div"){echo "<table border='1'><tr><th>NCAS#</th><th>DESCRIPTION</th><th>SECTION</th><th>DIST</th><th>PARK</th><th>CENTER</th><th>Spent 0203</th><th>Spent 0304</th><th>Spent 0405</th><th>Increase<br>Decrease</th><th>Percent<br>Inc_Dec</th><th>0506 Req</th><th>0506 Spent</th><th>Available</th></tr>";}else{echo "<table border='1'><tr><th>SECTION</th><th>DIST</th><th>PARK</th><th>CENTER</th><th>CF0203</th><th>CF0304</th><th>CF0405</th><th>CF0506</th><th>Excess/Shortage</th></tr>";}}// rep==""else{if($dist_sect!="div"){echo "<table border='1'><tr><th colspan='8'>$title</th></tr><tr><th>NCAS#</th><th>DESCRIPTION</th><th>SECTION</th><th>DIST</th><th>PARK</th><th>CENTER</th><th>Spent 0203</th><th>Spent 0304</th><th>Spent 0405</th><th>Increase<br>Decrease</th><th>Percent<br>Inc_Dec</th><th>0506 Req</th><th>0506 Spent</th><th>Available</th></tr>";}else{echo "<table border='1'><tr><th colspan='8'>$title</th></tr><tr><th>SECTION</th><th>DIST</th><th>PARK</th><th>CENTER</th><th>CF0203</th><th>CF0304</th><th>CF0405</th><th>CF0506</th><th>Excess/Shortage</th></tr>";}}if($GroupByToggle=="x"){$checkField="ncasnum";}else{$checkField="parkcode";}//if($rep=="excel"){//echo "x=$dist_sect";exit;//}$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");//$num=mysqli_num_rows($result);if($dist_sect!="div"){include("Inc_budget_rev_default.php");}else{include("Inc_budget_rev_Division.php");}?>