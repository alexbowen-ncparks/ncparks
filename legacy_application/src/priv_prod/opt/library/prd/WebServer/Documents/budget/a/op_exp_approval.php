<?php$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/iConnect.inc"); // connection parametersmysqli_select_db($connection, $database); // databaseinclude("../../../include/authBUDGET.inc");include("../../../include/activity.php");extract($_REQUEST);//echo "<pre>";print_r($_REQUEST);print_r($_SESSION);echo "</pre>";//exit;If($center=="Centers"){$rep="excel";}// Store Lev1 and Lev2 date ranges in filename on the server$today=date("Y-m-d");$filename = 'op_exp_app_dates.php';//include("op_exp_app_dates.php");$sql="Select start_date,end_date from budget_request_acceptable_dates where budget_group='operating_expenses' order by budget_group";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$row=mysqli_fetch_array($result);extract($row);$Lev1range=$start_date;$Lev2range=$end_date;//$Lev1range=explode("*",$lev1date);//$Lev2range=explode("*",$lev2date);// ******** Update ************if($submit=="Update"){if($center=="Centers"){echo "Updating must be done by individual centers.";exit;}//echo "<pre>";print_r($_POST); echo "</pre>"; exit;while(list($key,$val)=each($a_increase_justification)){$v1=$a_increase_justification[$key];$v2=$a_requested_increase[$key];$v3=$a_district_change[$key];$v4=$a_division_approved[$key];$v5=$a_division_change[$key];$v6=$a_district_approved[$key];if($allDistApp){$v6=$allDistApp;}if($allDivApp){$v4=$allDivApp;}$v2=str_replace(",","",$v2);$v3=str_replace(",","",$v3);$v5=str_replace(",","",$v5);$doThis="SET increase_justification='$v1', requested_increase='$v2',";if($v3){$doThis.="district_change='$v3',";}if($v4){$doThis.="division_approved='$v4',";}if($v5){$doThis.="division_change='$v5',";}if($v6){$doThis.="district_approved='$v6',";}    $doThis.="center='$center', acct='$key', f_year='$f_year'";    $sql = "REPLACE opexpense_request_3 $doThis";//echo "$sql<br />";//exit;$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");}// end while}// Construct Query to be passed to Excel Export$varQuery="submit=Submit&center=$center&f_year=$f_year";// workaround to extract just the center when resubmitting form with center// pulldown already has a selected value// not sure why only the center is not returned$pos=strpos($center,"-");if($pos){$findCenter=explode("-",$center);$center=$findCenter[2];}//echo "c=$center";// Creates the last 4 Fiscal Years - Used in queriesif($f_year==""){include("../~f_year.php");}else{$yx=substr($f_year,0,2);$year2="20".$yx;$year3=$year2+1;}$y0=substr($year2-3,2,4);$y1=substr($year2-2,2,4);$py3=$y0.$y1;$y2=substr($year2-1,2,4);$py2=$y1.$y2;$y3=substr($year2,2,4);$py1=$y2.$y3;$y4=substr($year3,2,4);$cy=$y3.$y4;// Get most recent date from Exp_Rev$sql="SELECT DATE_FORMAT(max(acctdate),'Report Date: %c/%e/%Y') as maxDate, DATE_FORMAT(max(acctdate),'%Y%m%d') as maxDate1 FROM `exp_rev` WHERE 1";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 0. $sql");$row=mysqli_fetch_array($result);extract($row);if($rep=="excel"){header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment; filename=Operating_Expense_Approval.xls');}// *********** Level > 2 ************if($_SESSION[budget][level]>2){//print_r($_REQUEST);EXIT;if($rep==""){include_once("../menu.php");If($level<4){$roFY="READONLY";}echo "<table align='center'><form action=\"op_exp_approval.php\">";// Menu 2$sql="SELECT section,parkcode,center as varCenter from center where fund='1280' order by section,parkcode,center";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 1. $sql");while ($row=mysqli_fetch_array($result)){extract($row);$pc[]=$parkcode;$c[]=$varCenter;$sec[]=$section;}echo "<td><select name=\"center\"><option selected>Select Center</option>";for ($n=0;$n<count($c);$n++){if($center==$c[$n]){$s="selected";}else{$s="value";}$con=$c[$n];		echo "<option $s='$con'>$sec[$n]-$pc[$n]-$c[$n]</option>\n";       }   echo "</select> FY <input type='hidden' name='m' value='$m'><input type='text' name='f_year' value='$f_year' size='5'$roFY> <input type='submit' name='submit' value='Submit'>";echo "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type='checkbox' name='showSQL' value='1'>Show SQL";echo "</form></td></tr></table>";}if($center==""){exit;}}// end Level > 2// ************* Level 2 *****************if($_SESSION['budget']['level'] == 2){ //exit;//print_r($_REQUEST);EXIT;if($rep==""){include_once("../menu.php");include_once("../../../include/parkRCC.inc");if($today>=$Lev1range and $today<=$Lev2range){}else{$noUpdate=1;}$distCode=$_SESSION['budget']['select'];echo "<table align='center'><form action=\"op_exp_approval.php\">";switch($distCode){case "EADI":$distCode="east";break;case "NODI":$distCode="north";break;case "SODI":$distCode="south";break;case "WEDI":$distCode="west";break;}$D=$distCode."-NCAS";$DP=$distCode."-PARK";$array1=array($D,$DP);$where="where dist='$distCode' and section='operations' and fund='1280'";$sql="SELECT section,parkcode,center as varCenter from center $where order by section,parkcode,center";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 1. $sql");while ($row=mysqli_fetch_array($result)){extract($row);$pc[]=$parkcode;$c[]=$varCenter;$sec[]=$section;}echo "<table align='center'><form><tr>";echo "<td><select name=\"center\"><option selected>Select Center</option>";for ($n=0;$n<count($c);$n++){$con=$c[$n];if($center==$con){$s="selected";}else{$s="value";}		echo "<option $s='$con'>$sec[$n]-$pc[$n]-$c[$n]\n";       }   echo "</select>  FY <input type='text' name='f_year' value='$f_year' size='5' READONLY> <input type='submit' name='submit' value='Submit'></td></form></tr></table>";}if($center==""){exit;}$distCenter=in_array($center,$c); //echo "d=$distCenter";if(!$distCenter){exit;}}// end Level = 2// *********** Level 1 ************if($_SESSION[budget][level]==1){ //exit;if($rep==""){//echo "<pre>";print_r($_SESSION);print_r($_REQUEST);echo "</pre>";include_once("../menu.php");// Kludge to allow NERI to also work with MOJE$S=$_SESSION[budget][centerSess];if($S=="12802859"||$S=="12802857"){$file0=$_SERVER[PHP_SELF];$file=$file0."?center=$center&m=1&submit=Submit&parkcode=";$daCode=array("NERI","MOJE"); //print_r($daCode);exit;$daCenter=array("12802859","12802857"); //print_r($daCenter);exit;	if($parkcode=="MOJE" OR $center=="12802857"){	$center="12802857"; $parkcode="MOJE";	$_SESSION[budget][centerSess]="12802857";	}	else	{	$center="12802859"; $parkcode="NERI";	$_SESSION[budget][centerSess]="12802859";}// onChange=\"MM_jumpMenu('parent',this,0)\"echo "<tr><td><form><select name=\"center\"><option selected>Select Center</option>";//$s="value";for ($n=0;$n<count($daCode);$n++){$con1=$daCenter[$n];if($parkcode==$daCode[$n]){$s="selected";}else{$s="value";}		echo "<option $s='$con1'>$daCode[$n]-$daCenter[$n]\n";       }   echo "</select></td></tr></table>";}if($today>=$Lev1range and $today<=$Lev2range){}else{$noUpdate=1;}echo "<table align='center'><form action=\"op_exp_approval.php\"><tr>";   echo "<td> FY <input type='text' name='f_year' value='$f_year' size='5' READONLY> <input type='submit' name='submit' value='Submit'></form></td>";}include_once("../../../include/parkcountyRCC.inc");//include_once("subDist.php");$center=$_SESSION['budget']['centerSess'];}// end Level = 1/* ********************* Start Queries ********** *//* Get most recent FY from act3. This will determine whether INSERTS are needed  *///$showSQL=1;//if($submit=="Submit"){ $query = "SELECT max(f_year) as checkFY from `act3`"; $result = @mysqli_query($connection, $query,$connection); $row=mysqli_fetch_array($result);extract($row); if($f_year!=$checkFY){echo "Table act3 is presently populated with data from $checkFY and <b>NOT</b> $f_year";exit;}     $query = "truncate table opexpense_request_3_form;";    $result = @mysqli_query($connection, $query,$connection);if($showSQL=="1"){echo "$query<br><br>";}/*inserts from opexpense_request_3 table */ $query = "insert into opexpense_request_3_form(center,ncasnum,amount_py1,amount_py2,amount_py3,increase_justification,requested_increase,district_change,division_change,division_approved,district_approved) select center,acct,'','','',increase_justification,requested_increase,district_change,division_change,division_approved,district_approved from opexpense_request_3 where 1 and f_year='$f_year';"; $result = @mysqli_query($connection, $query,$connection);if($showSQL=="1"){echo "$query<br><br>";}/*inserts from act3 table */ $query = "insert into opexpense_request_3_form(center,ncasnum,amount_py1,amount_py2,amount_py3,increase_justification,requested_increase,district_change,division_change,division_approved,district_approved) select center,ncasnum,sum(amount_py1),sum(amount_py2), sum(amount_py3),'','','','','','' from act3 where 1 group by center,ncasnum;"; $result = @mysqli_query($connection, $query,$connection);if($showSQL=="1"){echo "$query<br><br>";}//}// end if submitif($center!="Centers"){$whereFilter="and opexpense_request_3_form.center='$center'";$GROUP="group by opexpense_request_3_form.ncasnum,center";}else{$ORDER="Order by center";$GROUP="group by center,opexpense_request_3_form.ncasnum";}/*select query for center budgets*/$sql="select center.parkcode,opexpense_request_3_form.center,dist as 'district',section,opexpense_request_3_form.ncasnum, coa.park_acct_desc,opexpense_request_3_form.increase_justification, sum(opexpense_request_3_form.requested_increase) as 'requested_increase', sum(opexpense_request_3_form.district_change) as 'district_change',sum(division_change) as 'division_change', sum(requested_increase+district_change+division_change) as 'approved_increase', sum(amount_py1) as 'last_year',sum(amount_py1+requested_increase+district_change+division_change) as 'requested_budget', (round((sum(requested_increase+district_change+division_change)/sum(amount_py1+.001)*100),1)) as 'percent_increase',division_approved,district_approved from opexpense_request_3_form left join coa on opexpense_request_3_form.ncasnum=coa.ncasnum left join center on opexpense_request_3_form.center=center.center WHERE 1 AND coa.budget_group = 'operating_expenses' AND coa.track_rcc =  'y'$whereFilter$GROUP$ORDER";//echo "$sql<br>";//exit;if($showSQL=="1"){echo "$sql<br>";}//$varQuery=$_SERVER[QUERY_STRING];if($rep==""){// ******** Menu 0 *************   Reports$setQuery="center=$center&f_year=$f_year";if($level==1){$s=$start_date;$f=$end_date;}if($level==2){$s=$start_date;$f=$end_date;}if($level<3){$t="All requests MUST be made from <font color='red'>$s to $f</font>.";}echo "<table><tr><td><a href='op_exp_approval.php?$varQuery&rep=excel'>Excel Export</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Report Date: <font color='red'>$today</font>&nbsp;&nbsp;&nbsp; $t</td></tr></table>";}echo "<table border='1' align='center'>";if($level>1){$wid2=" width='105'";}if($level>3){$wid3=" width='105'";}$header="<tr><th>Park</th><th>NCASnum</th><th>Acct<br>Description</th><th>Change<br>Justification</th><th>Requested<br>Change</th><th>District<br>Change</th><th$wid2>District<br>Approved</th><th>Division<br>Change</th><th$wid3>Division<br>Approved</th><th>Total<br>Change</th><th>Last<br>Year</th><th>Requested<br>Budget</th><th>Percent<br>Change</th></tr>";if($rep==""){echo "<form name='frm' method='POST'>";}else{echo "$header";}$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");//$num=mysqli_num_rows($result);$yy=10;$i=0;while($row=mysqli_fetch_array($result)){extract($row); $jj++;$k=$ncasnum;$inc_tot+=$requested_increase;$dist_tot+=$district_change;$div_tot+=$division_change;$approv_tot+=$approved_increase;$lastyear_tot+=$last_year;$request_tot+=$requested_budget;$requested_increase=numFormat($requested_increase);$district_change=numFormat($district_change);$division_change=numFormat($division_change);$approved_increase=numFormat($approved_increase);$last_year=numFormat($last_year);$requested_budget=numFormat($requested_budget);if(fmod($i,$yy)==0 and $rep==""){echo "<tr>$header</tr>";}$i++;echo "<tr><td align='center'>$parkcode</td>";echo "<td align='center'>$ncasnum</td><td align='left'>$park_acct_desc</td>";if($rep==""){$distRO=" READONLY";if($level==1 and $district_approved=="u"){$distRO="";}if($level>1 and $division_approved=="u"){$distRO="";}if($level==1 and ($district_approved=="u"||$district_approved=="")){$distRO="";}echo "<td align='right'><textarea name='a_increase_justification[$k]' col='4' rows='2'$distRO>$increase_justification</textarea></td>";echo "<td align='right'><input type='text' name='a_requested_increase[$k]' value='$requested_increase' size='10'$distRO></td>";}else{echo "<td align='right'>$increase_justification</td>";echo "<td align='right'>$requested_increase</td>";}If($level>1 and $rep==""){echo "<td align='right'><input type='text' name='a_district_change[$k]' value='$district_change' size='10'></td>";$ckY=""; $ckN="";$ckU="";if($district_approved=="y"){$ckY="checked";}//if($district_approved=="n"){$ckN="checked";}if($district_approved=="u"){$ckU="checked";}//<font color='red'> N</font><input type='radio' name='a_district_approved[$k]' value='n'$ckN>echo "<td align='center'><font color='green'>Y</font><input type='radio' name='a_district_approved[$k]' value='y'$ckY><font color='blue'> U</font><input type='radio' name='a_district_approved[$k]' value='u'$ckU></td>";}else{echo "<td align='right'>$district_change<input type='hidden' name='a_district_change[$k]' value='$district_change'></td>";echo "<td align='center'>$district_approved<input type='hidden' name='a_district_approved[$k]' value='$district_approved'></td>";}If($level>3 and $rep==""){echo "<td align='right'><input type='text' name='a_division_change[$k]' value='$division_change' size='10'></td>";$ckY=""; $ckN="";$ckU="";if($division_approved=="y"){$ckY="checked";}//if($division_approved=="n"){$ckN="checked";}if($division_approved=="u"){$ckU="checked";}//<font color='red'> N</font><input type='radio' name='a_division_approved[$k]'  id='no$jj' value='n'$ckN>echo "<td align='right'><font color='green'>Y</font><input type='radio' name='a_division_approved[$k]' id='yes$jj' value='y'$ckY><font color='blue'> U</font><input type='radio' name='a_division_approved[$k]'  id='un$jj' value='u'$ckU></td>";}else{echo "<td align='right'>$division_change<input type='hidden' name='a_division_change[$k]' value='$division_change'></td>";echo "<td align='center'>$division_approved<input type='hidden' name='a_division_approved[$k]' value='$division_approved'></td>";}echo "<td align='right'>$approved_increase</td><td align='right'>$last_year</td><td align='right'>$requested_budget</td><td align='right'>$percent_increase</td>";echo "</tr>";}// end while$percent_inc=(round(($approv_tot/$lastyear_tot),4)*100)."%";$inc_tot=numFormat($inc_tot);$dist_tot=numFormat($dist_tot);$div_tot=numFormat($div_tot);$approv_tot=numFormat($approv_tot);$lastyear_tot=numFormat($lastyear_tot);$request_tot=numFormat($request_tot);echo "<tr><td colspan='5' align='right'>$inc_tot</td><td align='right'>$dist_tot</td><td align='right'></td><td align='right'>$div_tot</td><td align='right'></td><td align='right'>$approv_tot</td><td align='right'>$lastyear_tot</td><td align='right'>$request_tot</td><td align='center'>$percent_inc</td></tr>";if(!$noUpdate){//&nbsp;&nbsp; No-<input type='radio' name='allDistApp' value='n'>if($level>1){$AllDistYes="<td colspan='4' align='right'>Set <font color='red'>ALL</font> District Approved to: Yes-<input type='radio' name='allDistApp' value='y'>&nbsp;&nbsp; U-<input type='radio' name='allDistApp' value='u'></td>";}//&nbsp;&nbsp; No-<input type='radio' name='allDivApp' value='n'>if($level>3){$AllDivYes="<td colspan='3' align='right'>Set <font color='red'>ALL</font> Division Approved to: <br />Yes-<input type='radio' name='allDivApp' value='y'>&nbsp;&nbsp; U-<input type='radio' name='allDivApp' value='u'></td>";}echo "<tr>$AllDistYes$AllDivYes<td colspan='3' align='center'><input type='hidden' name='m' value='$m'><input type='hidden' name='center' value='$center'><input type='hidden' name='f_year' value='$f_year'><input type='submit' name='submit' value='Update'></td></tr>";}echo "</table></form></body></html>";function numFormat($nf){$nf=number_format($nf,2);return $nf;}?>