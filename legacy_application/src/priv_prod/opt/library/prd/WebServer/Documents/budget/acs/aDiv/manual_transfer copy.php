<?php$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/connectROOT.inc"); // connection parametersmysql_select_db($database, $connection); // databaseinclude("../../../include/authBUDGET.inc");extract($_REQUEST);//echo "<pre>";print_r($_REQUEST);print_r($_SESSION);echo "</pre>";//exit;/*// Construct Query to be passed to Excel Exportforeach($_REQUEST as $k => $v){if($v and $k!="PHPSESSID"){$varQuery.=$k."=".$v."&";}}$passQuery=$varQuery;*/if($submit=="Update"){//echo "<pre>";print_r($_REQUEST);echo "</pre>";//exit;$updateThese=array("center","ncas_number","allocation_amount","justification","approved");foreach($_REQUEST as $k=>$v){$key=key($v);$value=$_REQUEST[$k][$key];if(in_array($k,$updateThese)){foreach($v as $kid=>$vid){$query1="UPDATE manual_allocations_3 SET $k='$vid' where id='$kid'";//echo "$query1<br>";$result = mysql_query($query1) or die ("Couldn't execute query Update. $query1");		}// end foreach $v	} // end if in_array} // end foreach REQUEST//	exit;// Get values to send back to form$sql="SELECT allocation_number,manual_allocations_3.center,parkCode,ncas_number,park_acct_desc, allocation_amount,justification,approved,idfrom manual_allocations_3LEFT JOIN center on center.center=manual_allocations_3.centerLEFT JOIN coa on coa.ncasNum=manual_allocations_3.ncas_numberwhere allocation_number='$allocation_number' order by id";$resultTransfer = mysql_query($sql) or die ("Couldn't execute query 2. $sql");//echo "$sql";exit;}if($submit=="Submit"){$query1="INSERT INTO manual_allocations_3 SET allocation_number='$allocation_number', allocation_date='$allocation_date', f_year='$f_year' ";for($j=1;$j<=count($center);$j++){$query=$query1;	$query.=", center='$center[$j]'";	$query.=", ncas_number='$ncas_number[$j]'";		$v1=str_replace(",","",$allocation_amount[$j]);	$query.=", allocation_amount='$v1'";		$just=addslashes($justification[$j]);	$query.=", justification='$just'";		$app=$approved[$j];	$query.=", approved='$app'";//echo "$query<br><br>";if($center[$j]!=""){$result = mysql_query($query) or die ("Couldn't execute query 1. $sql");}	}// Get values to send back to form$sql="SELECT allocation_number,manual_allocations_3.center,parkCode,ncas_number,park_acct_desc, allocation_amount,justification,approved,idfrom manual_allocations_3LEFT JOIN center on center.center=manual_allocations_3.centerLEFT JOIN coa on coa.ncasNum=manual_allocations_3.ncas_numberwhere allocation_number='$allocation_number' order by id";$resultTransfer = mysql_query($sql) or die ("Couldn't execute query 1. $sql");}// *********** Level > 4 ************if($_SESSION[budget][level]>4){//print_r($_REQUEST);EXIT;if($rep==""){include_once("../menu.php");// Make f_yearif($f_year==""){$testMonth=date(n);if($testMonth >0 and $testMonth<8){$year2=date(Y)-1;}if($testMonth >7){$year2=date(Y);}$yearNext=$year2+1;$yx=substr($year2,2,2);$year3=$yearNext;$yy=substr($year3,2,2);$f_year=$yx.$yy;}if($showSQL==1){$p="method='POST'";}echo "<hr><table align='center'><form action='$PHP_SELF' $p><tr>";// Menu 0 is just for display - value is not passed to any query$sql="SELECT section,parkcode,center as varCenter from center where fund='1280' order by section,parkcode,center";$result = mysql_query($sql) or die ("Couldn't execute query 1. $sql");while ($row=mysql_fetch_array($result)){extract($row);$pc[]=$parkcode;$c[]=$varCenter;$sec[]=$section;}$cen=explode("-",$centerList);if($cen[2]){$cent=$cen[2];}else{$cent=$centerList;}echo "<td align='center'>Center List<br><select name=\"centerList\"><option selected></option>";for ($n=0;$n<count($c);$n++){if($cent==$c[$n]){$s="selected";}else{$s="value";}$con=$c[$n];		echo "<option $s='$con'>$sec[$n]-$pc[$n]-$c[$n]</option>\n";       }   echo "</select></td>";   // Menu 1$sql="select (max(allocation_number)+1) as maxAllo from manual_allocations_3 where 1";$result = mysql_query($sql) or die ("Couldn't execute query 1. $sql");$row=mysql_fetch_array($result);$allocation_number_menu=$row[maxAllo];echo "<td align='center'>Allocation Number<br><input type='text' name='allocation_number' value='$allocation_number_menu' size='12' READONLY></td>";$today=date(Ymd);echo "<td align='center'>Allocation Date<br><input type='text' name='allocation_date' value='$today' size='12' READONLY></td>";echo "<td align='center'>Fiscal Year<br><input type='text' name='f_year' value='$f_year' size='12' READONLY></td>";echo "<td align='center'>Lines needed: <br><input type='text' name='lines' value='' size='3'></td>";   echo "<td><input type='submit' name='submit' value='Show_Form'>";echo "</form></td></tr></table>";}}// end Level > 4if($submit!="Show_Form" and !$resultTransfer){exit;}// ********* Create Entry Form ***************if($resultTransfer){echo "<form method='POST'><table border='1'>";echo "<tr><th></th><th>Allocation #</th><th>Center</th><th>Center Name</th><th>ncas_number</th><th>NCAS Description</th><th>allocation_amount</th><th>Justification</th><th>Approved</th><th>ID</th><tr>";$i=1;while ($row=mysql_fetch_assoc($resultTransfer)){// ASSOC arrayecho "<tr><td align='center'>$i</td>";foreach($row as $key=>$val){$name=$key."[$row[id]]";if($key!="id"){echo "<td><input type='text' name='$name' value='$val'></td>";}else{echo "<td>$val</td>";}}// end foreachecho "</tr>";$i++;}// end while   echo "<tr>   <td colspan='8' align='center'><input type='hidden' name='allocation_number' value='$allocation_number'><input type='submit' name='submit' value='Update'></td></tr></form></table></form></body></html>";}else{echo "<form method='POST'><table border='1'>";echo "<tr><th></th><th>Center</th><th>ncas_number</th><th>allocation_amount</th><th>Justification</th><th>Approved</th><tr>";$cen=explode("-",$centerList);if($cen[2]){$cent=$cen[2];}else{$cent=$centerList;}for($i=1;$i<=$lines;$i++){echo "<tr><td align='center'>$i</td><td><input type='text' name='center[$i]' value='$cent' size='10'></td><td><input type='text' name='ncas_number[$i]' size='12'></td><td><input type='text' name='allocation_amount[$i]' size='15'></td><td><input type='text' name='justification[$i]' size='45'></td><td><input type='radio' name='approved[$i]' value='y' checked>Y<input type='radio' name='approved[$i]' value='n'>N</td></tr>";}   echo "<tr>   <td><input type='hidden' name='allocation_number' value='$allocation_number'></td>   <td><input type='hidden' name='allocation_date' value='$today'></td>   <td><input type='hidden' name='f_year' value='$f_year'></td>   <td align='center'><input type='submit' name='submit' value='Submit'></td></tr></form></table></form></body></html>";}?>