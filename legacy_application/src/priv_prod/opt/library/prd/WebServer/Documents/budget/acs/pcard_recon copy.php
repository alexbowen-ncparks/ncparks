<?phpinclude("../../../include/authBUDGET.inc");// start_session and gets $level//echo "<pre>";print_r($_SESSION);echo "</pre>";//exit;//echo "<pre>";print_r($_SERVER);echo "</pre>";//exit;//echo "<pre>";print_r($_REQUEST);echo "</pre>";//exit;$file="pcard_recon.php";$fileMenu="pcard_recon_menu.php";$varQuery=$_SERVER[QUERY_STRING]."&m=$m";if($varQueryPass){$varQuery=$varQueryPass;}// ECHO "v=$varQuery";//exit;// ECHO "$_SERVER[QUERY_STRING]";//exit;//$reportHeader=explode("&",$_SERVER[QUERY_STRING]);//print_r($reportHeader);// **** Allow processing assistant access to all centersif($level<5){if($_SESSION['budget']['select']=="ARCH"){$level=3;}}//extract($_REQUEST);if($admin_num){$parkcode=$admin_num;}// *************$distPark=strtoupper($parkcode);$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/connectROOT.inc"); // connection parametersmysql_select_db($database, $connection); // database// ******** Edit/Update Status ***********if($submit=="Update"){//echo "<pre>";print_r($arrayLocation);echo "</pre>";//echo "<pre>";print_r($arrayTransID);echo "</pre>"; exit;$today=date("Y-m-d");for($i=0;$i<count($arrayTransID);$i++){$id=$arrayTransID[$i];if(!$budget_ok[$id]){$updateBudget_OK="";}else{$updateBudget_OK=",budget_ok='$budget_ok[$id]'";if($budget_ok[$id]=="Y"){$updateBudget_OK.=",budget2controllers='$today'";}else{$updateBudget_OK.=",budget2controllers=''";}}$testCenter="center_".$id;$center[$id]=$_REQUEST[$testCenter];$testNCAS="ncasnum_".$id; //echo "$testNCAS<br>";$ncasnum[$id]=$_REQUEST[$testNCAS]; //echo "$ncasnum[$id]<br>";$testEquipNum="equipnum_".$id;$equipnum[$id]=$_REQUEST[$testEquipNum];if($item_purchased[$id]!="" AND $ncasnum[$id]!="" AND $center[$id]!=""){$updatepark_recondate=", park_recondate='$today'";}else{$updatepark_recondate=", park_recondate=''";}$testProjNum="projnum_".$id;if($arrayLocation[$i]=="1629"||$arrayLocation[$i]=="1669"){$projnum[$id]=$_REQUEST[$testProjNum];if($center[$id]!="" AND $projnum[$id]!=""){$updatepark_recondate=",park_recondate='$today'";}else{$updatepark_recondate=", park_recondate=''";}}else{$check1616Center=substr($center[$id],0,4);if($check1616Center!="1280" AND $check1616Center!="2803"){$center[$id]="INCORRECT";$m=1;}}// format a correct NCAS number$ck_ncasnum=$ncasnum[$id];$ck_ncasnum=str_replace("-","",$ck_ncasnum);if(strlen($ck_ncasnum)==4 || strlen($ck_ncasnum)==7){$ck_ncasnum="53".$ck_ncasnum;}// Verify the NCAS number$ckSelect="SELECT coaid FROM `coa` WHERE ncasNum ='$ck_ncasnum' and valid_div='y'";//echo "$ckSelect";exit;$result1 = mysql_query($ckSelect);$valid=mysql_num_rows($result1);if($valid!=1 AND $ck_ncasnum!=""){$e1="bogus";$ck_ncasnum="bogus";}// PA Approval Number$pa_number=""; $re_number="";if($pa_re_number[$id]!=""){	$pare=explode("*",$pa_re_number[$id]);	$pa_number=$pare[1];	$re_number=$pare[2];		}// Check for equip number$find="4";// force $find to be a string and not an integer$nn=strpos($ck_ncasnum,$find);// value of 0 means first char = 4$ncas_fund=substr($center[$id],0,4);$prefix=substr($ck_ncasnum,0,2);if((!$equipnum[$id] OR $equipnum[$id]=="needed") AND $nn==2 AND ($ncas_fund=="1280" OR $ncas_fund=="1932") AND $prefix=="53"){$e2="1";$equipnum[$id]="needed";}IF($center[$id]=="2803"){$updateCompany=", company='1612'";} else{$updateCompany="";}$item_pur=addslashes($item_purchased[$id]);$query="UPDATE `pcard_unreconciled` set ncas_description='',item_purchased='$item_pur', ncasnum='$ck_ncasnum', center='$center[$id]', projnum='$projnum[$id]', equipnum='$equipnum[$id]', pa_number='$pa_number', re_number='$re_number'$updatepark_recondate $updateBudget_OK $updateCompanyWHERE id='$id'";	//	echo "$query<br>";exit;$result = mysql_query($query) or die ("Couldn't execute query 0. $query");}// end for$query="update pcard_unreconciled,coa set pcard_unreconciled.ncas_description=coa.park_acct_desc where pcard_unreconciled.ncasnum=coa.ncasnum";//echo "$query<br>";//exit;$result = mysql_query($query) or die ("Couldn't execute query 0. $query"); // ECHO "v=$varQuery";exit;if($e1){$addE1="&e1=$e1";}if($e2){$addE2="&e2=$e2";}//if($pe){$PA_num_error="&pe=$pe";}//$PA_num_error$msg2="&msg2=Success";header("Location: pcard_recon.php?$varQuery$addE1$addE2$msg2");exit;}// **************  Show Results ***************$sql = "SELECT DISTINCT ncas_account as OK_accountFROM `pa_approval_exceptions` WHERE 1";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");while($row=mysql_fetch_array($result)){$approved_accounts[]=strtoupper($row['OK_account']);}//echo "<pre>";print_r($approved_accounts);print_r($_REQUEST);echo "</pre>";exit;// Determine accessif($level>2 AND $parkcode!="all"){$WHERE.=" where pcard_unreconciled.admin_num='$parkcode'";}if($level==2){include_once("../../../include/parkcodesDiv.inc");$parkList=$_SESSION[budget][select];// Get districtif(!$parkcode){$parkcode=$parkList;}$da=${"array".$parkList}; //print_r($da);exit;if(in_array($parkList,$da)){$parkcode=strtoupper($parkcode);if(in_array($parkcode,$da)){$WHERE.=" where pcard_unreconciled.admin_num='$parkcode'";}else{echo "<br>No access for $parkcode";exit;}}else{echo "<br><br>You do not have access privileges for this database [$db] report at $level $posTitle. Contact Tom Howard tom.howard@ncmail.net if you wish to gain access.<br>park_project_balances.php<br>budget.php<br>dist=$parkList $distPark";exit;}}if($level==1){$parkcode=strtoupper($parkcode);$parkSession=$_SESSION[budget][select];$WHERE.=" where pcard_unreconciled.admin_num='$parkSession'";//Workaround for NERI/MOJEif($_SESSION[budget][select]=="NERI" and ($parkcode=="NERI" or $parkcode=="MOJE")){$WHERE=" where pcard_unreconciled.admin_num='$parkcode'";}}if($WHERE==""){if($admin_num=="all"){$passAdmin_num="all";$WHERE="WHERE 1";}else{$rep=$_SESSION[budget][report];echo "You do not have access privileges for this database [$db] report $rep at level $level $posTitle. Contact Tom Howard tom.howard@ncmail.net if you wish to gain access.<br><br>budget.php<br>";print_r($a);print_r($_SESSION['budget']['report']);exit;}}// ******** Show Results ***********// Parse any PA Approval Number errorsif($rep==""){$varQuery=$_SERVER['QUERY_STRING'];include("$fileMenu");if($e1){$msg="<font color='red'> WARNING: Invalid NCAS number. Correct any <font color='green'>bogus</font> ncasnum.</font>";}if($e2){$msg.=" <font color='red' size='+1'> WARNING: Your Equipment Item requires an Equipment Request Number.</font><br />Please Select the Approved Equip Button where <font color='green'>equipnum is \"needed\"</font>. Thanks";}// Excel linkif($submit=="Find"){echo "<tr><td><a href='pcard_recon.php?$varQuery&rep=excel'>Excel</a> Export </td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$msg</td></tr>";}}if($rep=="excel"){header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment; filename=pcard_recon_all.xls');$forceText="pc-";}//echo "hello=$admin_num";exit;if($submit=="Find"||$submit=="Produce_Page_to_Print"){// another name for parkcodeif($cardholder){$WHERE.=" AND pcard_unreconciled.cardholder='$cardholder'";$passCardholder="$cardholder";}/*if($reconcilStatus){$WHERE.=" and pcard_unreconciled.reconciled='$reconcilStatus'";$passCardholder="$cardholder";}*/if($report_type){if($report_type=="1656-Travel"){$loc="1656";}else{$loc=$report_type;}$WHERE.=" and pcard_unreconciled.location='$loc'";$passCardholder="$cardholder";}if($report_type){$newPage="target='_blank'"; $query = "SELECT  ncasNum FROM coaWHERE budget_group =  'TRAVEL' AND valid_div =  'y'and left(ncasNum,6)>='532700'ORDER  BY ncasNum";//echo "$query<br><br>";   $result = @MYSQL_QUERY($query,$connection);while($row = mysql_fetch_assoc($result)){$ncas_a.=$row[ncasNum].",";}$ncas_a=trim($ncas_a,",");//echo "$ncas_a<br>";if($report_type=="1656-Travel"){$findNCAS=" and FIND_IN_SET(ncasNum,'$ncas_a')>0";}else{$findNCAS=" and FIND_IN_SET(ncasNum,'$ncas_a')<1";}}//if($_SESSION['budget']['tempID']=="Howard6319"){$limit="limit 500";}$sql = "SELECT concat( center_code, '*', pa_number, '*', re_number ) as app, concat( pa_number, '*', re_number ) as app_menuFROM approved_reWHERE 1 ORDER BY center_code, pa_number$limit";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");while($row=mysql_fetch_array($result)){$APPROVAL[]=strtoupper($row['app']);$APPROVAL_menu[]=strtoupper($row['app_menu']);}echo "<html><body>";echo "<table border='1' cellpadding='3' align='center'>";if($rep==""){echo "<form action='pcard_recon.php' name='pcardForm' method='POST'$newPage>";} $query = "SELECT pcard_unreconciled.admin_num,pcard_unreconciled.cardholder,pcard_unreconciled.pcard_num,pcard_unreconciled.location,pcard_unreconciled.transid_new AS 'transid',pcard_unreconciled.transdate_new AS 'transdate',pcard_unreconciled.vendor_name,pcard_unreconciled.amount,pcard_unreconciled.item_purchased,pcard_unreconciled.company,pcard_unreconciled.ncasnum,pcard_unreconciled.ncas_description,pcard_unreconciled.center,pcard_unreconciled.projnum,pcard_unreconciled.equipnum,pcard_unreconciled.pa_number,pcard_unreconciled.re_number,pcard_unreconciled.xtnd_rundate_new,pcard_unreconciled.report_date,pcard_unreconciled.park_recondate,pcard_unreconciled.budget_ok,pcard_unreconciled.budget2controllers,pcard_unreconciled.reconcilement_date,pcard_unreconciled.center as pc_center,pcard_unreconciled.id as pc_idFROM pcard_unreconciled$WHERE and xtnd_rundate_new>='$xtnd_start' and xtnd_rundate_new<='$xtnd_end'$findNCASorder by admin_num,cardholder,transid_new,amount";   $result = @MYSQL_QUERY($query,$connection);   //echo "$query<br>";exit;$num=mysql_num_rows($result);if($level>3){$cr="<a href='pcard_recon_bo.php?$varQuery'>Controller Report</a>";}if($num>1){$s="s";}$numHeader="<font color='purple'>$num</font> record$s. <font color='green'>$msg2</font>&nbsp;&nbsp;&nbsp;&nbsp;$cr";if($showReportHeader and $rep==""){echo "$showReportHeader";}if($m==1 and $rep==""){echo "<tr><td colspan='16' align='center'><blink><font color='magenta'>An incorrect Center was entered. Please make the correction.</font></blink></td></tr>";}if($report_type==""){if($level<3){$header="<tr><th>admin #</th><th>card<br>holder</th><th>pcard number</th><th>location</th><th>transid</th><th>&nbsp;&nbsp;transdate&nbsp;</th><th>vendor&nbsp;name</th><th>amount</th><th>item purchased</th><th>ncasnum</th><th>ncas_description</th><th>center</th><th>projnum</th><th>equipnum</th><th>pa_number</th><th>park_recondate</th></tr>";if($rep==""){echo "$numHeader";}echo "1 $header"; include("pcard_recon_L1.php");}if($level>2){$header="<tr><th>admin #</th><th>card<br>holder</th><th>pcard number</th><th>location</th><th>transid</th><th>&nbsp;&nbsp;transdate&nbsp;</th><th>vendor&nbsp;name</th><th>amount</th><th>item purchased</th><th>company</th><th>ncasnum</th><th>ncas_description</th><th>&nbsp;&nbsp;&nbsp;center&nbsp;&nbsp;&nbsp;</th><th>projnum</th><th>equipnum</th><th>pa_number</th><th>&nbsp;&nbsp;xtnd_date&nbsp;</th><th>report_date</th><th>park_recondate</th><th>budget_ok</th><th>budget<br>2controllers</th><th>reconcilement<br>date</th></tr>";if($rep==""){echo "$numHeader";}echo "$header";	//if($_SESSION['budget']['tempID']=="Howard6319"){	//include("pcard_recon_L5.php");}else{include("pcard_recon_L3.php");		//}}}// end display Formelse{$header="<tr><th>admin #</th><th>card<br>holder</th><th>pcard number</th><th>location</th><th>transid</th><th>&nbsp;&nbsp;transdate&nbsp;</th><th>vendor&nbsp;name</th><th>amount</th><th>item purchased</th><th>ncas_description</th><th>company</th><th>ncasnum</th><th>&nbsp;&nbsp;&nbsp;center&nbsp;&nbsp;&nbsp;</th><th>pa number</th><th>re number</th></tr>";echo "$numHeader $header";include("pcard_recon_controller.php");}// end else = Reportecho "</div></body></html>";}?>