<?php$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/iConnect.inc"); // connection parametersmysqli_select_db($connection, $database); // databaseinclude("../../../include/authBUDGET.inc");extract($_REQUEST);//print_r($_SESSION);EXIT;// Get most recent date from Exp_Rev$sql="SELECT DATE_FORMAT(max(acctdate),'Report Date: %c/%e/%y') as maxDate FROM `exp_rev` WHERE 1";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 0. $sql");$row=mysqli_fetch_array($result);extract($row);if($rep=="excel"){header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment; filename=Budget_equip_detail.xls');}// *********** Level > 2 ************if($_SESSION[budget][level]>2){//print_r($_REQUEST);EXIT;$sql="SELECT  DISTINCT section FROM  `center`";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 1. $sql");while ($row=mysqli_fetch_array($result)){extract($row);$sectArray1[]="sect-x-".$section;$sectArray2[]=$section."-NCAS#";$sectArray3[]="sect-y-".$section;$sectArray4[]=$section."-PARK";}if($rep==""){include_once("../menu.php");echo "<table><form action=\"budget_equip_detail.php\">";$array1=array("east-x","north-x","south-x","west-x","east","north","south","west");$array2=array("EADI-NCAS#","NODI-NCAS#","SODI-NCAS#","WEDI-NCAS#","EADI-PARK","NODI-PARK","SODI-PARK","WEDI-PARK");$menuArray1=array_merge($array1,$sectArray1);$menuArray1=array_merge($menuArray1,$sectArray3);$menuArray2=array_merge($array2,$sectArray2);$menuArray2=array_merge($menuArray2,$sectArray4);// Menu 1echo "<td>Scope: <select name=\"scopeMenu\"><option selected></option>";$s="value";for ($n=0;$n<count($menuArray2);$n++){$con=$menuArray1[$n];		echo "<option $s='$con'>$menuArray2[$n]\n";       }   echo "</select></td>";// Menu 2$sql="SELECT section,parkcode,center as varCenter from center where fund='1280' order by section,parkcode,center";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 1. $sql");while ($row=mysqli_fetch_array($result)){extract($row);$pc[]=$parkcode;$c[]=$varCenter;$sec[]=$section;}echo "<td><select name=\"center\"><option selected>Select Center</option>";$s="value";for ($n=0;$n<count($c);$n++){$con=$c[$n];		echo "<option $s='$con'>$sec[$n]-$pc[$n]-$c[$n]\n";       }   echo "</select><input type='submit' name='submit' value='Submit'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type='checkbox' name='showSQL' value='1'>Show SQL</form></td></tr></table>";}// *********** Set Scopelist($dist_sect,$orderByToggle)=explode("-",$scopeMenu);if($orderByToggle=="x" || $orderByToggle=="NCAS"){$GroupByToggle="x";$orderBy="ORDER BY equipexp.ncasnum,center.dist,center.parkcode";if($dist_sect!="sect"){$limitWhere=" AND center.section='operations'";}}else{$orderBy="ORDER BY center.parkcode,equipexp.ncasnum";}if($scopeMenu){list($dist_sect,$orderByToggle,$sect)=explode("-",$scopeMenu);if($dist_sect=="sect"){$whichCenter="AND center.section='$sect'";}else{$whichCenter="AND center.dist='$dist_sect'";}}else{$whichCenter="AND center.center='$center'";$orderBy="ORDER BY equipexp.ncasnum";}if($center==""){exit;}}// end Level > 2// ************* Level 2 *****************if($_SESSION[budget][level] == 2){//print_r($_REQUEST);EXIT;if($rep==""){include_once("../menu.php");include_once("../../../include/parkRCC.inc");$distCode=$_SESSION[budget][select];$distCheck=$_SESSION[budget][select];echo "<table><form action=\"budget_equip_detail.php\">";switch($distCode){case "EADI":$distCode="east";break;case "NODI":$distCode="north";break;case "SODI":$distCode="south";break;case "WEDI":$distCode="west";break;}$D=$distCode."-NCAS";$DP=$distCode."-PARK";$array1=array($D,$DP);// Menu 1echo "<td>Scope: <select name=\"scopeMenu\"><option selected></option>";$s="value";for ($n=0;$n<count($array1);$n++){$con=$array1[$n];		echo "<option $s='$con'>$array1[$n]\n";       }   echo "</select></td>";   $parkList=$_SESSION[budget][select];$da=${"array".$parkList}; //print_r($da);exit;while (list($key,$val)=each($da)){$parkList=$parkList.",".$val;}$where="where FIND_IN_SET(center.parkCode,'$parkList')>''";// Menu 2$sql="SELECT section,parkcode,center as varCenter from center $where order by section,parkcode,center";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 1. $sql");while ($row=mysqli_fetch_array($result)){extract($row);$pc[]=$parkcode;$c[]=$varCenter;$sec[]=$section;}echo "<td><select name=\"center\"><option selected>Select Center</option>";$s="value";for ($n=0;$n<count($c);$n++){$con=$c[$n];		echo "<option $s='$con'>$sec[$n]-$pc[$n]-$c[$n]\n";       }   echo "</select>   <input type='hidden' name='distCheck' value='$distCode'>   <input type='submit' name='submit' value='Submit'></form></td></tr></table>";}// *********** Set Scopelist($dist_sect,$orderByToggle)=explode("-",$scopeMenu);if($orderByToggle=="NCAS"){$GroupByToggle="x";$orderBy="ORDER BY equipexp.ncasnum,center.dist,center.parkcode";if($dist_sect!="sect"){$limitWhere=" AND center.section='operations'";}}else{$orderBy="ORDER BY center.parkcode";}if($scopeMenu){list($dist_sect,$orderByToggle,$sect)=explode("-",$scopeMenu);if($dist_sect=="sect"){$whichCenter="AND center.section='$sect'";}else{$whichCenter="AND center.dist='$dist_sect'";}}else{$whichCenter="AND center.center='$center'";}if($center==""){exit;}}// end Level = 2// *********** Level 1 ************if($_SESSION[budget][level]==1){include_once("../menu.php");include_once("../../../include/parkcountyRCC.inc");include_once("subDist.php");}// end Level = 1// *********** Check Level **************if($_SESSION[budget][level]==2){list($dist_sect,$orderByToggle)=explode("-",$scopeMenu);switch($dist_sect){case "east":$distCode="EADI";break;case "north":$distCode="NODI";break;case "south":$distCode="SODI";break;case "west":$distCode="WEDI";break;}if($_SESSION[budget][select]!=$distCheck){$ds=$_SESSION[budget][select];echo "$distCode $ds $distCheckAccess denied";exit;}}$sql = "SELECT equipexp.ncasnum, coa.park_acct_desc AS description, center.section, center.dist, center.parkcode, equipexp.center,sum( equipexp.spent0203 )  AS spent0203, sum( equipexp.spent0304 )  AS spent0304, sum( equipexp.spent0405 )  AS spent0405, sum( equipexp.request0506 )  AS  request_0506, sum( equipexp.spent0506 )  AS  spent0506, sum( equipexp.request0506 - equipexp.spent0506 )  AS  availableFROM  `equipexp`LEFT  JOIN center ON equipexp.center = center.centerLEFT  JOIN coa ON equipexp.ncasnum = coa.ncasnumWHERE 1  AND coa.track_rcc =  'y' AND equipexp.ncasnumLIKE  '534%' $whichCenter $limitWhereGROUP  BY equipexp.ncasnum, equipexp.center$orderBy";if($showSQL=="1"){echo "$sql<br>";//exit;}$varQuery=$_SERVER[QUERY_STRING];if($rep==""){echo "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='budget_equp_detail.php?$varQuery&rep=excel'>Excel Export</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $maxDate<br>";}echo "<table border='1'><tr><th>NCAS#</th><th>DESCRIPTION</th><th>SECTION</th><th>DIST</th><th>PARK</th><th>CENTER</th><th>Spent 0203</th><th>Spent 0304</th><th>Spent 0405</th><th>Req 0506</th><th>Spent 0506</th><th>Available</th></tr>";if($GroupByToggle=="x"){$checkField="ncasnum";}else{$checkField="parkcode";}$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");//$num=mysqli_num_rows($result);while($row=mysqli_fetch_array($result)){extract($row);// Track Totals$spent0203tot=$spent0203tot+$spent0203;// 1$spent0304tot=$spent0304tot+$spent0304;//2$spent0405tot=$spent0405tot+$spent0405;//3$request_0506tot=$request_0506tot+$request_0506;//4$spent0506tot=$spent0506tot+$spent0506;//5$availabletot=$availabletot+$available;//6// Display SubTotalsif($check!="" AND $check!=$$checkField){$subspent0203totF=number_format($subspent0203tot,2);$subspent0304totF=number_format($subspent0304tot,2);$subspent0405totF=number_format($subspent0405tot,2);$subrequest_0506totF=number_format($subrequest_0506tot,2);$subspent0506totF=number_format($subspent0506tot,2);$subRemainingtotF=number_format($subRemainingtot,2);echo "<tr><td align='right' colspan='7'><b>$subspent0203totF</td><td align='right'><b>$subspent0304totF</b></td><td align='right'><b>$subspent0405totF</b></td><td align='right'><b>$subrequest_0506totF</b></td><td align='right'><b>$subspent0506totF</b></td><td align='right'><b>$subRemainingtotF</b></td></tr>";$subspent0203grand=$subspent0203grand+$subspent0203tot; $subspent0203tot="";$subspent0304grand=$subspent0304grand+$subspent0304tot; $subspent0304tot="";$subspent0405grand=$subspent0405grand+$subspent0405tot; $subspent0405tot="";$subspent0506grand=$subspent0506grand+$subspent0506tot; $subspent0506tot="";$subtotal_spent0506grand=$subtotal_spent0506grand+$subtotal_spent0506; $subtotal_spent0506="";$subrequest_0506grand=$subrequest_0506grand+$subrequest_0506tot; $subrequest_0506tot="";$subRemaininggrand=$subRemaininggrand+$subRemainingtot; $subRemainingtot="";//$countPerCent=0;}// Format for display$spent0203F=number_format($spent0203,2);$spent0304F=number_format($spent0304,2);$spent0405F=number_format($spent0405,2);$request_0506F=number_format($request_0506,2);$spent0506F=number_format($spent0506,2);$availableF=number_format($available,2);//$link0405="<a href='portal_ven_pay.php?dbTable=exp_rev&acct=$ncasnum&center=$center&f_year=0405' target='_blank'>$spent0405F</a>";//$link0506="<a href='portal_ven_pay.php?dbTable=exp_rev&acct=$ncasnum&center=$center&f_year=0506' target='_blank'>$spent0506F</a>";$linkRequest0506="<a href='budget_equip_drill_down.php?acct=$ncasnum&center=$center&f_year=0506' target='_blank'>$request_0506F</a>";$linkSpent0506="<a href='portal_ven_pay.php?dbTable=exp_rev&acct=$ncasnum&center=$center&f_year=0506' target='_blank'>$spent0506F</a>";$dist=strtoupper($dist);echo "<tr><td align='right'>$ncasnum</td><td align='right'>$description</td><td align='right'>$section</td><td align='center'>$dist</td><td align='center'>$parkcode</td><td align='right'>$center</td><td align='right'>$spent0203F</td><td align='right'>$spent0304F</td><td align='right'>$spent0405F</td><td align='right'>$linkRequest0506</td><td align='right'>$linkSpent0506</td><td align='right'>$availableF</td></tr>";// Track SubTotals// $subx is used to hold value for last subTotal$subspent0203tot=$subspent0203tot+$spent0203;$sub1=number_format($subspent0203tot,2);$subspent0304tot=$subspent0304tot+$spent0304;$sub2=number_format($subspent0304tot,2);$subspent0405tot=$subspent0405tot+$spent0405;$sub3=number_format($subspent0405tot,2);$subrequest_0506tot=$subrequest_0506tot+$request_0506;$sub7=number_format($subrequest_0506tot,2);$subspent0506tot=$subspent0506tot+$spent0506;$sub8=number_format($subspent0506tot,2);$subRemainingtot=$subRemainingtot+$available;$sub11=number_format($subRemainingtot,2);$check=$$checkField;	}// end while// Format and Display Totals$spent0203totF=number_format($spent0203tot,2);$spent0304totF=number_format($spent0304tot,2);$spent0405totF=number_format($spent0405tot,2);$request_0506totF=number_format($request_0506tot,2);$spent0506totF=number_format($spent0506tot,2);$availabletotF=number_format($availabletot,2);// Print Final SubTotalsecho "<tr><td align='right' colspan='7'><b>$sub1</td><td align='right'><b>$sub2</b></td><td align='right'><b>$sub3</b></td><td align='right'><b>$sub7</b></td><td align='right'><b>$sub8</b></td><td align='right'><b>$sub11</b></td></tr>";// Print Grand Totalsif($_SESSION[budget][level]>2){$addText="<br>Addition of displayed subtotals: ";$subspent0203grandF=number_format($subspent0203grand+$subspent0203tot,2);$subspent0304grandF=number_format($subspent0304grand+$subspent0304tot,2);$subspent0405grandF=number_format($subspent0405grand+$subspent0405tot,2);$subrequest_0506grandF=number_format($subrequest_0506grand+$subrequest_0506tot,2);$subspent0506grandF=number_format($subspent0506grand+$subspent0506tot,2);$subRemaininggrandF=number_format($subRemaininggrand+$subRemainingtot,2);echo "<tr><td align='right' colspan='7'>Grand Total: <b>$subspent0203grandF</b></td><td align='right'><b>$subspent0304grandF</b></td><td align='right'><b>$subspent0405grandF</b></td><td align='right'><b>$subrequest_0506grandF</b></td><td align='right'><b>$subspent0506grandF</b></td><td align='right'><b>$subRemaininggrandF</b></td></tr>";}echo "<tr><th>NCAS#</th><th>DESCRIPTION</th><th>SECTION</th><th>DIST</th><th>PARK</th><th>CENTER</th><th>Spent 0203</th><th>Spent 0304</th><th>Spent 0405</th><th>Req 0506</th><th>Spent 0506</th><th>Available</th></tr>";echo "</table></body></html>";?>