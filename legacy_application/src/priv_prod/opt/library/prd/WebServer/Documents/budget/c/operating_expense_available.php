<?php//These are placed outside of the webserver directory for security$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/iConnect.inc"); // connection parametersmysqli_select_db($connection, $database); // databasesession_start();extract($_REQUEST);$ckCenter=explode("-",$center);// parse $center when = sec-parkcode-centerif($ckCenter[2]){$center=$ckCenter[2];}// Construct Query to be passed to Excel Export$varQuery="submit=Submit&center=$center&budget_group=$budget_group&track_rcc=$track_rcc";//print_r($_SESSION);//EXIT;//print_r($_REQUEST);//EXIT;$level=$_SESSION[budget][level];$m="1";if($rep==""){include("../menu.php");}// Force Level 1 to automatically display reportif($level<2){$center=$_SESSION[budget][centerSess];$submit="Submit";}if($rep==""){// Display Formecho "<html><header></header<title></title><body><table align='center'><form method='POST' action='operating_expense_available.php'>";if($level==2){include("../../../include/parkcodesDiv.inc");$distCode=$_SESSION[budget][select];$menuList="array".$distCode; $distList=${$menuList};//print_r($arraySODI);print_r($distList);//exit;}if($level>1){echo "<tr><td colspan='3'>";$sql="SELECT section,parkcode as admin_num,center as varCenter from center where fund='1280' order by section,parkcode,center";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 1. $sql");while ($row=mysqli_fetch_array($result)){extract($row);$pc[]=$admin_num;$c[]=$varCenter;$sec[]=$section;if($section=="operations"){$distParks[]=$admin_num;$distC[]=$varCenter;$distSect[]=$section;}}if($level==2){// repopulate $sec $c and $pc for just a *** DISTRICT ***	foreach($distParks as $k=>$v){	if(in_array($v,$distList)){$pc2[]=$v;$c2[]=$distC[$k];$sec2[]=$distSect[$k];}	}$c=$c2;$pc=$pc2;$sec=$sec2;}   echo "<td><select name=\"center\"><option selected>Select Center</option>";for ($n=0;$n<count($c);$n++){if($center==$c[$n]){$s="selected";}else{$s="value";}$con=$c[$n];		echo "<option $s='$con'>$sec[$n]-$pc[$n]-$c[$n]</option>\n";       }   echo "</select></td>";}if($level>1){echo "<td>Show SQL <input type='checkbox' name='showSQL' value='x'></td>";echo "<td>$addCenter<input type='submit' name='submit' value='Submit'></td></form></tr>";}if($submit){if($center==""||$center=="Select Center"){echo "<font color='red'>You must select a Center.</font>";exit;}echo "<tr><td colspan='7'><a href='operating_expense_available.php?$varQuery&rep=excel'>Excel Export</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";}// if submitecho "</table>";}if($submit!=""){// Make f_yearif($f_year==""){$testMonth=date(n);if($testMonth >0 and $testMonth<8){$year2=date(Y)-1;}if($testMonth >7){$year2=date(Y);}$yearNext=$year2+1;$yx=substr($year2,2,2);$year3=$yearNext;$yy=substr($year3,2,2);$f_year=$yx.$yy;}$today_60=date("Ymd",mktime(0,0,0,date(m),date(d)-60,date(Y)));$sql="SELECT max(acctdate) as max from exp_rev where 1";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$row0=mysqli_fetch_array($result);extract($row0); $sql="truncate table available_funds;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL){echo "<br><br>$sql";}//exit;$sql="insert into available_funds(center,ncas_number,f_year,py_amount,allocation_amount,cy_actual,transfer_request) select center,act3.ncasnum,'$f_year',sum(amount_py1) as 'py_amount',sum(allocation_amount) as 'allocation_amount',sum(amount_cy) as 'amount_cy','' from act3 left join coa on act3.ncasnum=coa.ncasnum where 1 and coa.budget_group='operating_expenses' and coa.track_rcc='y' and coa.ncasnum != '531311' group by center,act3.ncasnum;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL){echo "<br><br>$sql";}//exit;$sql="insert into available_funds(center,ncas_number,f_year,py_amount,allocation_amount,cy_actual,transfer_request) select center, ncas_number,f_year,'','','',transfer_request from opexpense_transfers_3 where 1 and f_year='$f_year' and status='not_processed';";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL){echo "<br><br>$sql";}//exit;$sql="insert into available_funds(center,ncas_number,f_year,py_amount,allocation_amount,cy_actual,transfer_request,unposted_codesheet,unposted_pcard) select ncas_center,ncas_account,f_year,'','','','',sum(ncas_invoice_amount),''from cid_vendor_invoice_paymentsleft join coa on cid_vendor_invoice_payments.ncas_account=coa.ncasnumwhere 1and post2ncas!='y'and budget_group='operating_expenses'and coa.track_rcc='y'group by ncas_center,ncas_number;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL){echo "<br><br>$sql";}//exit;//and datesql >= '$today_60' and f_year='$f_year'$sql="insert into available_funds(center,ncas_number,f_year,py_amount,allocation_amount,cy_actual,transfer_request,unposted_codesheet,unposted_pcard) select center,ncasnum,'','','','','','',sum(amount)from pcard_unreconciledwhere 1and post2ncas=''group by center,ncasnum;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL){echo "<br><br>$sql";}//exit;$sql="select center.parkcode as 'center_code', available_funds.center, center.dist, center.section, available_funds.ncas_number, coa.park_acct_desc as 'acct_description', sum(py_amount+allocation_amount) as 'cy_budget', sum(cy_actual) as 'cy_actual', sum(py_amount+allocation_amount-cy_actual) as 'posted_balance', sum(unposted_codesheet) as 'unposted_codesheet',sum(unposted_pcard) as 'unposted_pcard', sum(py_amount+allocation_amount-cy_actual-unposted_codesheet-unposted_pcard) as 'available_balance' from available_funds left join coa on available_funds.ncas_number=coa.ncasnum left join center on available_funds.center=center.center where 1 and available_funds.center='$center' group by available_funds.center,available_funds.ncas_number;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL){echo "<br><br>$sql";}//exit;$num=mysqli_num_rows($result);if($rep=="excel"){header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment; filename=operating_expense_available.xls');}// Display Resultsecho "<html><header></header><title>Operating Expense Available</title><body><table border='1' align='center'><tr><td colspan='6' align='center'><font color='blue'>$num</font> records returned for Report Date: <font color='brown'>$max</font></td></tr>";/*<td colspan='4' align='center'><a href='/budget/c/transactions_unposted.php?budget_group=operating_expenses&track_rcc=y&submit=Submit'>Reconcile Unposted Transactions</a></td>";*/$header="<tr><th>center_code</th><th>center</th><th>dist</th><th>section</th><th>ncas_number</th><th>acct_description</th><th>cy_budget</th><th>cy_actual</th><th>posted_balance</th><th>unposted_codesheet</th><th>unposted_pcard</th><th>available_balance</th></tr>";echo "$header";while($row=mysqli_fetch_array($result)){extract($row); $cy_budgetTotal+=$cy_budget;$cy_actualTotal+=$cy_actual;$posted_balanceTotal+=$posted_balance;$unposted_codesheetTotal+=$unposted_codesheet;$unposted_pcardTotal+=$unposted_pcard;$available_balanceTotal+=$available_balance;$cy_budget=number_format($cy_budget,2);$cy_actual=number_format($cy_actual,2);$posted_balance=number_format($posted_balance,2);$unposted_codesheet=number_format($unposted_codesheet,2);$unposted_pcard=number_format($unposted_pcard,2);$available_balance=number_format($available_balance,2);echo "<tr><td align='center'>$center_code</td><td>$center</td><td>$dist</td><td>$section</td><td>$ncas_number</td><td>$acct_description</td><td align='right'>$cy_budget</td>";echo "<td align='right'><a href='tunnel_cy_actual.php?center=$center&acct=$ncas_number&cy_actual=$cy_actual' target='_blank'>$cy_actual</a></td>";if($posted_balance<0){$f1="<font color='red'>";$f2="</font>";}else{$f1="";$f2="";}echo "<td align='right'>$f1$posted_balance$f2</td>";if($unposted_codesheet!="0.00"){$uc="<a href='tunnel_unpost_codesheet.php?ncas_center=$center&ncas_account=$ncas_number'target='_blank'>$unposted_codesheet</a>";}else{$uc=$unposted_codesheet;}echo "<td align='right'>$uc</td>";if($unposted_pcard!="0.00"){$upc="<a href='pcard_unposted.php?m=trans_unpost&ncas_center=$center&ncas_number=$ncas_number' target='_blank'>$unposted_pcard</a>";}else{$upc=$unposted_pcard;}echo "<td align='right'>$upc</td>";if($available_balance<0){$f1="<font color='red'>";$f2="</font>";}else{$f1="";$f2="";}echo "<td align='right'>$f1$available_balance$f2</td></tr>";}$cy_budgetTotal=number_format($cy_budgetTotal,2);$cy_actualTotal=number_format($cy_actualTotal,2);$posted_balanceTotal=number_format($posted_balanceTotal,2);$unposted_codesheetTotal=number_format($unposted_codesheetTotal,2);$unposted_pcardTotal=number_format($unposted_pcardTotal,2);$available_balanceTotal=number_format($available_balanceTotal,2);echo "<tr><td colspan='6' align='right'><b>Totals:</b></td><td align='right'>$cy_budgetTotal</td><td align='right'>$cy_actualTotal</td><td align='right'>$posted_balanceTotal</td><td align='right'>$unposted_codesheetTotal</td><td align='right'>$unposted_pcardTotal</td>";if($available_balanceTotal<0){$f1="<font color='red'>";$f2="</font>";}else{$f1="";$f2="";}echo "<td align='right'>$f1$available_balanceTotal$f2</td></tr>";if($rep==""){echo "$header";}echo "</table></body></html>";}?>