<?php$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/connectROOT.inc"); // connection parametersmysql_select_db($database, $connection); // databaseinclude("../../../include/authBUDGET.inc");extract($_REQUEST);//echo "<pre>";print_r($_REQUEST);print_r($_SESSION);echo "</pre>";//exit;If($center=="Centers"){$rep="excel";}// Store Lev1 and Lev2 date ranges in filename on the server$today=date("Ymd");$filename = 'op_exp_app_dates.php';if($level>3 and $lev1form){include("op_exp_app_dates.php");$somecontent = "<?php \$lev1date=\"$lev1form\";\$lev2date=\"$lev2form\";?>";// Let's make sure the file exists and is writable first.if (is_writable($filename)) {  // The file pointer is at the start of the file and will  //replace any existing content.   if (!$handle = fopen($filename, 'w')) {     echo "Cannot open file ($filename)";     exit;  }   // Write $somecontent to our opened file.   if (fwrite($handle, $somecontent) === FALSE) {    echo "Cannot write to file ($filename)";    exit;  }   // echo "Success, wrote ($somecontent) to file ($filename)";     fclose($handle);//exit; } else {  echo "The file $filename is not writable"; }}include("op_exp_app_dates.php");$Lev1range=explode("*",$lev1date);$Lev2range=explode("*",$lev2date);// ******** Update ************if($submit=="Update"){if($center=="Centers"){echo "Updating must be done by individual centers.";exit;}while(list($key,$val)=each($a_increase_justification)){$v1=$a_increase_justification[$key];$v2=$a_requested_increase[$key];$v3=$a_district_change[$key];$v4=$a_division_approved[$key];$v5=$a_division_change[$key];//$k=explode("-",$key);$v2=str_replace(",","",$v2);$v3=str_replace(",","",$v3);$v5=str_replace(",","",$v5);$doThis="SET increase_justification='$v1', requested_increase='$v2', district_change='$v3', division_approved='$v4', division_change='$v5', center='$center', acct='$key', f_year='$f_year'";$sql = "REPLACE opexpense_request_3 $doThis";//echo "$sql";exit;$result = mysql_query($sql) or die ("Couldn't execute query. $sql");}// end while}// Construct Query to be passed to Excel Export$varQuery="submit=Submit&center=$center&f_year=$f_year";// workaround to extract just the center when resubmitting form with center// pulldown already has a selected value// not sure why only the center is not returned$pos=strpos($center,"-");if($pos){$findCenter=explode("-",$center);$center=$findCenter[2];}//echo "c=$center";// Creates the last 4 Fiscal Years - Used in queriesif($f_year==""){include("../~f_year.php");/*$testMonth=date(n);if($testMonth >0 and $testMonth<8){$year2=date(Y)-1;}if($testMonth >7){$year2=date(Y);}$yearNext=$year2+1;$yx=substr($year2,2,2);$year3=$yearNext;$yy=substr($year3,2,2);$f_year=$yx.$yy;*/}else{$yx=substr($f_year,0,2);$year2="20".$yx;$year3=$year2+1;}$y0=substr($year2-3,2,4);$y1=substr($year2-2,2,4);$py3=$y0.$y1;$y2=substr($year2-1,2,4);$py2=$y1.$y2;$y3=substr($year2,2,4);$py1=$y2.$y3;$y4=substr($year3,2,4);$cy=$y3.$y4;//echo "py3=$py3 py2=$py2 py1=$py1 cy=$cy <br><br>f_year=$f_year y2=$year2 y3=$year3 y4=$y4 y3=$y3 y2=$y2 y1=$y1<br><br>today=$today compare=$compare testMonth=$testMonth";//exit;//print_r($_SESSION);//EXIT;//print_r($_REQUEST);//EXIT;// Get most recent date from Exp_Rev$sql="SELECT DATE_FORMAT(max(acctdate),'Report Date: %c/%e/%Y') as maxDate, DATE_FORMAT(max(acctdate),'%Y%m%d') as maxDate1 FROM `exp_rev` WHERE 1";$result = mysql_query($sql) or die ("Couldn't execute query 0. $sql");$row=mysql_fetch_array($result);extract($row);if($rep=="excel"){header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment; filename=Operating_Expense_Approval.xls');}// *********** Level > 2 ************if($_SESSION[budget][level]>2){//print_r($_REQUEST);EXIT;if($rep==""){include_once("../menu.php");If($level<4){$roFY="READONLY";}echo "<table align='center'><form action=\"op_exp_approval.php\">";If($level>3){include("op_exp_app_dates.php");$lev1="Lev1 <input type='text' name='lev1form' value='$lev1date' size='17'>";$lev2="Lev2 <input type='text' name='lev2form' value='$lev2date' size='17'>";$pc[]="All";$c[]="Centers";$sec[]="Return";}// Menu 2$sql="SELECT section,parkcode,center as varCenter from center where fund='1280' order by section,parkcode,center";$result = mysql_query($sql) or die ("Couldn't execute query 1. $sql");while ($row=mysql_fetch_array($result)){extract($row);$pc[]=$parkcode;$c[]=$varCenter;$sec[]=$section;}echo "<td>$lev1 $lev2<select name=\"center\"><option selected>Select Center</option>";for ($n=0;$n<count($c);$n++){if($center==$c[$n]){$s="selected";}else{$s="value";}$con=$c[$n];		echo "<option $s='$con'>$sec[$n]-$pc[$n]-$c[$n]</option>\n";       }   echo "</select> FY <input type='hidden' name='m' value='$m'><input type='text' name='f_year' value='$f_year' size='5'$roFY> <input type='submit' name='submit' value='Submit'>";echo "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type='checkbox' name='showSQL' value='1'>Show SQL";echo "</form></td></tr></table>";}if($center==""){exit;}}// end Level > 2// ************* Level 2 *****************if($_SESSION[budget][level] == 2){ //exit;//print_r($_REQUEST);EXIT;if($rep==""){include_once("../menu.php");include_once("../../../include/parkRCC.inc");//if($today>=$Lev2range[1] and $today<=$Lev2range[0]){}else{$noUpdate=1;}$distCode=$_SESSION[budget][select];echo "<table align='center'><form action=\"op_exp_approval.php\">";switch($distCode){case "EADI":$distCode="east";break;case "NODI":$distCode="north";break;case "SODI":$distCode="south";break;case "WEDI":$distCode="west";break;}$D=$distCode."-NCAS";$DP=$distCode."-PARK";$array1=array($D,$DP);$where="where dist='$distCode' and section='operations' and fund='1280'";$sql="SELECT section,parkcode,center as varCenter from center $where order by section,parkcode,center";$result = mysql_query($sql) or die ("Couldn't execute query 1. $sql");while ($row=mysql_fetch_array($result)){extract($row);$pc[]=$parkcode;$c[]=$varCenter;$sec[]=$section;}echo "<table align='center'><form><tr>";echo "<td><select name=\"center\"><option selected>Select Center</option>";for ($n=0;$n<count($c);$n++){$con=$c[$n];if($center==$con){$s="selected";}else{$s="value";}		echo "<option $s='$con'>$sec[$n]-$pc[$n]-$c[$n]\n";       }   echo "</select>  FY <input type='text' name='f_year' value='$f_year' size='5' READONLY> <input type='submit' name='submit' value='Submit'></td></form></tr></table>";}if($center==""){exit;}}// end Level = 2// *********** Level 1 ************if($_SESSION[budget][level]==1){ //exit;if($rep==""){include_once("../menu.php");if($today>=$Lev1range[0] and $today<=$Lev1range[1]){}else{$noUpdate=1;}echo "<table align='center'><form action=\"op_exp_approval.php\"><tr>";   echo "<td> FY <input type='text' name='f_year' value='$f_year' size='5' READONLY> <input type='submit' name='submit' value='Submit'></form></td>";}include_once("../../../include/parkcountyRCC.inc");//include_once("subDist.php");$center=$_SESSION[budget][centerSess];}// end Level = 1/* ********************* Start Queries ********** *//* Get most recent FY from act3. This will determine whether INSERTS are needed  *///if($submit=="Submit"){ $query = "SELECT max(f_year) as checkFY from `act3`"; $result = @MYSQL_QUERY($query,$connection); $row=mysql_fetch_array($result);extract($row); if($f_year!=$checkFY){echo "Table act3 is presently populated with data from $checkFY and <b>NOT</b> $f_year";exit;}     $query = "truncate table opexpense_request_3_form;";    $result = @MYSQL_QUERY($query,$connection);if($showSQL=="1"){echo "$query<br><br>";}/*inserts from opexpense_request_3 table */ $query = "insert into opexpense_request_3_form(center,ncasnum,amount_py1,amount_py2,amount_py3,increase_justification,requested_increase,district_change,division_change,division_approved) select center,acct,'','','',increase_justification,requested_increase,district_change,division_change,division_approved from opexpense_request_3 where 1 and f_year='$f_year';"; $result = @MYSQL_QUERY($query,$connection);if($showSQL=="1"){echo "$query<br><br>";}/*inserts from act3 table */ $query = "insert into opexpense_request_3_form(center,ncasnum,amount_py1,amount_py2,amount_py3,increase_justification,requested_increase,district_change,division_change,division_approved) select center,ncasnum,sum(amount_py1),sum(amount_py2),sum(amount_py3),'','','','','' from act3 where 1 group by center,ncasnum;"; $result = @MYSQL_QUERY($query,$connection);if($showSQL=="1"){echo "$query<br><br>";}//}// end if submitif($center!="Centers"){$whereFilter="and opexpense_request_3_form.center='$center'";$GROUP="group by opexpense_request_3_form.ncasnum";}else{$ORDER="Order by center";$GROUP="group by center,opexpense_request_3_form.ncasnum";}/*select query for center budgets*/$sql="select center.parkcode,opexpense_request_3_form.center,dist as 'district',section,opexpense_request_3_form.ncasnum, coa.park_acct_desc,opexpense_request_3_form.increase_justification, sum(opexpense_request_3_form.requested_increase) as 'requested_increase', sum(opexpense_request_3_form.district_change) as 'district_change',sum(division_change) as 'division_change', sum(requested_increase+district_change+division_change) as 'approved_increase', sum(amount_py1) as 'last_year',sum(amount_py1+requested_increase+district_change+division_change) as 'requested_budget', (round((sum(requested_increase+district_change+division_change)/sum(amount_py1+.001)*100),1)) as 'percent_increase',division_approved from opexpense_request_3_form left join coa on opexpense_request_3_form.ncasnum=coa.ncasnum left join center on opexpense_request_3_form.center=center.center WHERE 1 AND coa.budget_group = 'operating_expenses' AND coa.track_rcc =  'y'$whereFilter$GROUP$ORDER";//echo "$sql<br>";//exit;if($showSQL=="1"){echo "$sql<br>";}//$varQuery=$_SERVER[QUERY_STRING];if($rep==""){// ******** Menu 0 *************   Reports$setQuery="center=$center&f_year=$f_year";if($level==1){$s=$Lev1range[0];$f=$Lev1range[1];}if($level==2){$s=$Lev2range[0];$f=$Lev2range[1];}if($level<3){$t="All requests MUST be made from <font color='red'>$s to $f</font>.";}echo "<table><tr><td><a href='op_exp_approval.php?$varQuery&rep=excel'>Excel Export</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$menuArray2[$scopeKey]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $maxDate&nbsp;&nbsp;&nbsp; $t</td></tr></table>";}echo "<table border='1' align='center'><tr>";$header="<th>Park</th><th>Center</th><th>Dist</th><th>Section</th><th>NCASnum</th><th>Acct<br>Description</th><th>Change<br>Justification</th><th>Requested<br>Change</th><th>District<br>Change</th><th>Division<br>Change</th><th>Total<br>Change</th><th>Last<br>Year</th><th>Requested<br>Budget</th><th>Percent<br>Change</th><th>Division<br>Approved</th>";echo "$header</tr><form method='POST'>";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");//$num=mysql_num_rows($result);while($row=mysql_fetch_array($result)){extract($row);$k=$ncasnum;$inc_tot+=$requested_increase;$dist_tot+=$district_change;$div_tot+=$division_change;$approv_tot+=$approved_increase;$lastyear_tot+=$last_year;$request_tot+=$requested_budget;$requested_increase=numFormat($requested_increase);$district_change=numFormat($district_change);$division_change=numFormat($division_change);$approved_increase=numFormat($approved_increase);$last_year=numFormat($last_year);$requested_budget=numFormat($requested_budget);echo "<tr><td align='center'>$parkcode</td><td align='center'>$center</td><td align='right'>$district</td><td align='right'>$section</td><td align='center'>$ncasnum</td><td align='left'>$park_acct_desc</td>";if($rep==""){echo "<td align='right'><textarea name='a_increase_justification[$k]' col='4' rows='2'>$increase_justification</textarea></td>";echo "<td align='right'><input type='text' name='a_requested_increase[$k]' value='$requested_increase' size='10'></td>";}else{echo "<td align='right'>$increase_justification</td>";echo "<td align='right'>$requested_increase</td>";}If($level>1 and $rep==""){echo "<td align='right'><input type='text' name='a_district_change[$k]' value='$district_change' size='10'></td>";}else{echo "<td align='right'>$district_change</td>";}If($level>3 and $rep==""){echo "<td align='right'><input type='text' name='a_division_change[$k]' value='$division_change' size='10'></td>";}else{echo "<td align='right'>$division_change</td>";}echo "<td align='right'>$approved_increase</td><td align='right'>$last_year</td><td align='right'>$requested_budget</td><td align='right'>$percent_increase</td>";If($level>3 and $rep==""){if($division_approved=="y"){$ckY="checked";$ckN="";}else{$ckN="checked";$ckY="";}echo "<td align='right'><font color='green'>Y</font><input type='radio' name='a_division_approved[$k]' value='y'$ckY> <font color='red'>N</font><input type='radio' name='a_division_approved[$k]' value='n'$ckN></td>";}else{if($division_approved==""){$division_approved="n";}echo "<td align='center'>$division_approved</td>";}echo "</tr>";}// end while$percent_inc=(round(($approv_tot/$lastyear_tot),4)*100)."%";$inc_tot=numFormat($inc_tot);$dist_tot=numFormat($dist_tot);$div_tot=numFormat($div_tot);$approv_tot=numFormat($approv_tot);$lastyear_tot=numFormat($lastyear_tot);$request_tot=numFormat($request_tot);echo "<tr><td colspan='8' align='right'>$inc_tot</td><td align='right'>$dist_tot</td><td align='right'>$div_tot</td><td align='right'>$approv_tot</td><td align='right'>$lastyear_tot</td><td align='right'>$request_tot</td><td align='center'>$percent_inc</td></tr>";if(!$noUpdate){echo "<tr><td colspan='14' align='center'><input type='hidden' name='m' value='$m'><input type='hidden' name='center' value='$center'><input type='hidden' name='f_year' value='$f_year'><input type='submit' name='submit' value='Update'></td></tr>";}echo "</table></form></body></html>";function numFormat($nf){$nf=number_format($nf,2);return $nf;}?>