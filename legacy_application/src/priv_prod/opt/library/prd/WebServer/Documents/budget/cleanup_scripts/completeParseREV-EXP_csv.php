<?php$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/iConnect.inc"); // connection parametersmysqli_select_db($connection, $database); // databaseextract($_REQUEST);session_start();$fy=$_SESSION['budget']['fy'];$p=$s+1;//$dbTable="exp_rev_test";$dbTable="exp_rev_fyear";//$hostURL="http://localhost";$hostURL="http://www.dpr.ncparks.gov";if($s=="1"){//   Delete ALL records where INVOICE is blank$sql =  "DELETE FROM  $dbTable where invoice=''";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");//exit;echo "<html><head><title></title><meta  HTTP-EQUIV=\"REFRESH\" content=\"5;  url=$hostURL/budget/cleanup_scripts/completeParseREV-EXP.php?s=2\"></head><body>Step $s of 8 completed.<br><br>Please wait while we perform step $p .</body></html>";exit;}// end s=1if($s=="2"){$action="Update records by finding appropriate ACCT number and adding it to each record.";$sql =  "SELECT fld1,whid FROM $dbTable where acct=''";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");while($row=mysqli_fetch_array($result)){extract($row);$pos=strpos($fld1,"ACCT");if($pos===false){$sql1 =  "UPDATE  $dbTable set acct='$var1' where whid='$whid'";$result1 = mysqli_query($connection, $sql1) or die ("Couldn't execute query. $sql1");}else{$var1=substr($fld1,$pos);$sql1 =  "UPDATE  $dbTable set acct='$var1' where whid='$whid'";$result1 = mysqli_query($connection, $sql1) or die ("Couldn't execute query. $sql1");}}//exit;echo "<html><head><title></title><meta  HTTP-EQUIV=\"REFRESH\" content=\"5;  url=$hostURL/budget/cleanup_scripts/completeParseREV-EXP.php?s=3\"></head><body>Step $s of 8 completed.<br>$action $fy<br>Please wait while we perform step $p.</body></html>";exit;}// end s=2if($s=="3"){//   Delete ALL records where DEBIT AND CREDIT are zero$sql =  "DELETE FROM  $dbTable where debit='0' and credit='0'";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");//exit;echo "<html><head><title></title><meta  HTTP-EQUIV=\"REFRESH\" content=\"5;  url=$hostURL/budget/cleanup_scripts/completeParseREV-EXP.php?s=4\"></head><body>Step $s of 8 completed.<br><br>Please wait while we perform step $p .</body></html>";exit;}if($s==4){//   Update records by parsing out center, fund and date from fld1$sql =  "SELECT fld1,whid FROM $dbTable where acctdate=''";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");while($row=mysqli_fetch_array($result)){extract($row);list($center,$fund,$date)=explode("\"\"",$fld1);$sql2 =  "UPDATE  $dbTable set center='$center',fund='$fund',acctdate='$date' where whid='$whid'";$result2 = mysqli_query($connection, $sql2) or die ("Couldn't execute query. $sql2");}//exit;echo "<html><head><title></title><meta  HTTP-EQUIV=\"REFRESH\" content=\"5;  url=$hostURL/budget/cleanup_scripts/completeParseREV-EXP.php?s=5\"></head><body>Step $s of 8 completed.<br><br>Please wait while we perform step $p .</body></html>";exit; }// end s=4if($s==5){//exit;//   Update records by removing quotes from acct, center,acctdate// Trimming pe and description, invoice$sql =  "SELECT invoice,pe,description,acct,center,acctdate,whid FROM $dbTable where fld1!=''";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");while($row=mysqli_fetch_array($result)){extract($row);//$invoice = substr($invoice,2);//$invoice = substr($invoice,0,-1);$invoice = addslashes(trim($invoice));//$pe = substr($pe,2);//$pe = substr($pe,0,-1);$pe = trim($pe);//$description = substr($description,2);//$description = substr($description,0,-1);$description = addslashes(trim($description));$center = substr($center,2);// removes first 2 chars$acctdate = trim(substr($acctdate,0,-1));// remove last char$acct = substr($acct,0,-1);$acct = str_replace("ACCT ", "", $acct);$sql2 =  "UPDATE  $dbTable set acct='$acct',center='$center',acctdate='$acctdate',pe='$pe' ,description='$description',invoice='$invoice'    where whid='$whid'";$result2 = mysqli_query($connection, $sql2) or die ("Couldn't execute query. $sql2");}//exit;echo "<html><head><title></title><meta  HTTP-EQUIV=\"REFRESH\" content=\"5;  url=$hostURL/budget/cleanup_scripts/completeParseREV-EXP.php?s=6\"></head><body>Step $s of 8 completed.<br><br>Please wait while we perform step $p .</body></html>";exit;}if($s==6){// Create db valid date$sql =  "UPDATE $dbTable SET acctdate= CONCAT(SUBSTRING_INDEX(acctdate,'/',-1),SUBSTRING_INDEX(acctdate,'/',1),SUBSTRING(SUBSTRING_INDEX(acctdate,'/',-2) from 1 for 2))where fld1!=''";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");//exit;echo "<html><head><title></title><meta  HTTP-EQUIV=\"REFRESH\" content=\"5;  url=$hostURL/budget/cleanup_scripts/completeParseREV-EXP.php?s=7\"></head><body>Step $s of 8 completed.<br><br>Please wait while we perform step $p.</body></html>";exit;}// end s=6if($s=="7"){//   Delete ALL records where ACCTDATE is not a date in decade of 2000$sql =  "DELETE FROM  $dbTable where acctdate not like '200%'";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql"); //exit;//   Update ALL new records with Fiscal Year$sql =  "UPDATE  $dbTable set f_year='$fy' where f_year =''";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql"); //exit;echo "<html><head><title></title><meta  HTTP-EQUIV=\"REFRESH\" content=\"5;  url=$hostURL/budget/cleanup_scripts/completeParseREV-EXP.php?s=8\"></head><body>Step $s of 8 completed.<br><br>Please wait while we perform step $p.</body></html>";exit;}// end s=7if($s==8){//   Set fld1 to blank so this script only runs on newly imported records next time$sql =  "UPDATE  $dbTable SET fld1=''";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$sql =  "OPTIMIZE  TABLE $dbTable";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");}// end s=8include("../menu.php"); echo "Parsing EXP_REV file completed."; ?>