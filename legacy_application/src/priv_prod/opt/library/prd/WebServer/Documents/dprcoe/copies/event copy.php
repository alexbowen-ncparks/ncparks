<?php extract ($_REQUEST);session_start();if(!$park){$park = $_SESSION['parkS'];}include("../../include/authCOE.inc");include("../../include/connectCOE.inc");include("../../include/parkcodes.inc");include("../../include/dist.inc");// Process inputif($Submit =="Add"){  $monthArray = range(1,12);if (in_array($month, $monthArray)){}else{$monthArrayName = array('','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec');$trans = array_flip($monthArrayName);$month = $trans[$month];}if(!$eid==""){$oldTitle=$title;$newdateBegin = date ("Y-m-d", mktime(0,0,0,$month,$day,$year));$sql = "SELECT * From event WHERE eid='$eid'";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");$row = mysql_fetch_array($result);extract($row); if($dateE==$newdateBegin AND $title==$oldTitle){$message = "<font color='red'>You have just entered an event with the SAME DATE and TITLE as the previous record. If this is NOT OK, View Entries and Delete the duplicate.</font>";}}$a=0;if ($enterBy == "" AND $enterBy1 == ""){$message="Enter your Name.";}else{$a++;}if ($month == ""){$message.="<br>Enter a Month.";}else{$a++;}if ($day == ""){$message.="<br>Enter a Day.";}else{$a++;}if ($title == "" AND strlen(trim($title1)) < 1){$message.="<br>Enter a Title.";}else{$a++;}if ($content == "") {$message.="<br>Enter a Program Description.";}else{$a++;}IF($title1 != ""){$title = $title1;$keepTitle1=$title1;}IF($enterBy1 != ""){$enterBy = $enterBy1;$keepName1=$enterBy1;}IF($content != ""){$keepContent=$content;}if($a==5){if (checkdate($month, $day, $year)!= "true") {echo "Invalid date. Click your browser's BACK button and make the change.";echo "m $month d $day y $year";exit;}//print_r($_REQUEST); exit;$newdateBegin = date ("Y-m-d", mktime(0,0,0,$month,$day,$year));$title=urldecode($title);$title=addslashes($title);$enterBy=urldecode($enterBy);$enterBy=addslashes($enterBy);$content1=$content;//$comment1=$comment;//$content=nl2br($content);$content=urlencode($content);//$comment=nl2br($comment);,comment,'$comment'$query = "INSERT INTO event (dateE, enterBy, title, park, content, dist) VALUES ('$newdateBegin','$enterBy', '$title', '$park','$content', '$dist')";$result = mysql_query($query) or die ("Couldn't execute query. $query");$eid = mysql_insert_id();$success= "<font size='4'>Event successfully added.</font><br>If you would like to <font size='4' color='orange'>add the same event on a different date,</font> change the date and click the Add button again.";}// end if $a} // end Add//  ************Start input form*************if($title1==""){$keepTitle=urldecode(stripslashes($title));}else{$keepTitle=stripslashes($title1);}if($enterBy1==""){$keepName=urldecode(stripslashes($enterBy));}else{$keepName=stripslashes($enterBy1);}$keepMonth=$month; $keepDay=$day; $keepYear=$year;//echo "m $month  d $day  y $year"; exit;//Temporary table to group individual records together by most recent dateToday// We first clear any existing temporary table$sql = "drop table IF EXISTS tempCOE"; $result = @mysql_query($sql, $connection) or die("Error #". mysql_errno() . ": " . mysql_error());// Create an intermediate table$sql = "CREATE TEMPORARY TABLE tempCOE SELECT * From event where park='$park' ORDER BY dateToday DESC, title";$result = @mysql_query($sql, $connection) or die("Error #". mysql_errno() . ": " . mysql_error());$sql = "SELECT DISTINCT enterBy From event WHERE park='$park' ORDER by enterBy";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");$sql = "SELECT DISTINCT title, content From tempCOE WHERE park='$park' GROUP by title ORDER by title";$result1 = mysql_query($sql) or die ("Couldn't execute query. $sql");//echo $sql; exit;echo "<html><head><title>New Event</title></head><body><font size='4' color='004400'>NC State Parks System Events Calendar</font><br><br><font size='5' color='blue'>Add a New Event for $parkCodeName[$park]</font><br>$success</font><hr><form name='newEvent' method='post' action='event.php'><table><tr><td><b>Entered By:</b></td>";if($color=="red"){$color="green";}else{$color="red";}echo"<td><select name='enterBy'><option value=''>";while ($row = mysql_fetch_array($result)){extract($row);$nameE=urlencode($enterBy);if($enterBy==$keepName or $enterBy==stripslashes($keepName)){echo "<option selected='$nameE'>$enterBy";}ELSE{echo "<option value='$nameE'>$enterBy";}}echo "</select></td><td><input type='text' name='enterBy1' value=";echo $keepName1; // this "weird" construct allows name with an apostropheecho ">(If your name wasn't listed, enter it here. $enterMessage)</td></tr></table>";    $monthArray = range(1,12); $monthArrayName = array('Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec',);echo "<table><tr><td><b>Date of Event:</b></td><td>";echo "<select name='month'>\n"; echo "<option value=''>\n";for ($i=0; $i <=11; $i++){$month = $monthArray[$i]; if($keepMonth==$month){echo "<option selected='$month'>$monthArrayName[$i]";}ELSE{echo "<option value='$month'>$monthArrayName[$i]";}}echo "</select> Month &nbsp;&nbsp;</td>";$dayArray = range(1,31); echo "<td><select name='day'>\n"; echo "<option value=''>\n";for ($i=0; $i <=30; $i++) {$day = $dayArray[$i];if($keepDay==$day){echo "<option selected='$day'>$day";}ELSE{echo "<option value='$day'>$day";}}echo "</select> Day &nbsp;</td>"; $thisYear = date('Y');  $nextYear = $thisYear + 1;$yearArray = range($thisYear, $nextYear);echo "<td><select name='year'>\n"; echo "<option value=''>\n";for ($i=0; $i <=1; $i++) {$year = $yearArray[$i];if($keepYear=="")	{if($thisYear==$yearArray[$i])	{echo "<option selected='$year'>$year";}	else{echo "<option value='$year'>$year";}	}ELSE	{if($keepYear==$yearArray[$i])	{echo "<option selected='$year'>$year";}	else{echo "<option value='$year'>$year";}	}}echo "</select> Year &nbsp;</td></tr></table>";echo "<table><tr> <td><b>Program Title:</b></td>";$titleArray = array(); $titleArray[0] = "";echo"<td><select name='title'><option value=''>";while ($row = mysql_fetch_array($result1)){extract($row);$titleE=urlencode($title);if($title==$keepTitle or $title==stripslashes($keepTitle)){echo "<option selected='$titleE'>$title";}ELSE{echo "<option value='$titleE'>$title";}$jsEncode = str_replace("+", "%20", ($row[1]));$jsEncode = str_replace("%2C", ",", $jsEncode);$jsEncode = str_replace("%3A", ":", $jsEncode);$jsEncode = str_replace("%3F", "?", $jsEncode);$titleArray[] = $jsEncode;}echo "</select><br>";echo "<input type='text' name='title1' size='55' value=";// this "weird" construct allows title with an apostropheif($Submit != "Add"){echo $keepTitle1;}echo ">(If your title wasn't listed, enter it here.)";echo "</td></tr></table><table>";if($message){echo "<tr><td><font size='4' color='red'>$message</font></td></tr></table>";}echo "<table><tr><td><b>Program Description</b><font color='purple'> (include start location and time)</font>:</td></tr><tr><td><textarea name='content' cols='80' rows='7'>$keepContent</textarea></td></tr><tr><td>Be sure to include any comments, such as \"bring bug spray\", \"wear hiking shoes\", etc.</td></tr></table>";/*<tr><td><b>Comments</b> <font color='purple'>(bring bug spray, wear hiking shoes, etc.)</font>:</td></tr><tr><td><textarea name='comment' cols='80' rows='5'>$comment1</textarea> </td></tr></table>*/echo " <table width='500'><tr><td width='100' align='center'><input type='hidden' name='park' value='$park'><input type='hidden' name='color' value='$color'><input type='hidden' name='eid' value='$eid'><input type='submit' name='Submit' value='Add'></form></td>";if($Submit =="Add"){echo "<td width='100'><form><input type='button' name='Submit' value='Edit' onclick=\"location='edit.php?eid=$eid'\"</form></td><td width='100'><form><input type='button' name='Submit' value='View Entries' onclick=\"location='find.php?Submit=Find&park=$park'\"</form></td></tr><tr>";}echo "<tr><td width='100'><form><input type='button' value='Clear Form' onclick=\"location='event.php?park=$park'\"></form></td></tr></table></body></html><SCRIPT LANGUAGE=Javascript>// Adds an event to the CONTENT fieldfunction report(element, event) {    var t = element.form.content;    var listIndex = element.selectedIndex;    var phpvar = new Array();";  $size=count($titleArray);    for ($i = 0; $i < $size; $i++) {    $temp = $titleArray[$i];      echo "phpvar[$i]=\"$temp\"\n";}    echo "t.value = decodeURI(phpvar[listIndex]);    }// This function adds one event handler to every element in a form.function addhandlers(f) {    // Loop through all the elements in the form    //for(var i = 0; i < f.elements.length; i++) {     //   var e = f.elements[i];     //  e.onclick = function() { report(this, 'Click'); } // In this use we only want the title field to respond.      f.elements.title.onclick = function() { report(this, 'Click');}}// Finally, activate our form by adding all possible event handlers!addhandlers(document.newEvent);</SCRIPT>";?>