<?phpinclude("../../include/authSYSEXP.inc");include("../../include/connectSYSEXP.inc");extract ($_FILES);// include("../../include/connectNRID.inc");// This is very messy and should be cleaned up! Later perhaps.// modified by Tom Howard after// store.php3 - by Florian Dittmer <dittmer@gmx.net>// Example php script to demonstrate the storing of binary files into// an sql database. More information can be found at http://www.phpbuilder.com/?><HTML><HEAD><TITLE>Store photograph into SYSEXP</TITLE></HEAD><BODY><body bgcolor="beige"><?php    // Data from form is processedif ($submit == "Add Photo") {    mysql_select_db("sysexp.photos");$timestamp = strtotime($datePhoto);$newdate = date("Y-m-d", $timestamp);$name = strtoupper($name);$data = addslashes(fread(fopen($_FILES['photo']['tmp_name'], "r"), $_FILES['photo']['size'])); $file = $_FILES['photo']['name'];$ext = substr(strrchr($file, "."), 1);// find file extention, mp3 e.g.// $file = $timestamp.".".$ext;if(!is_uploaded_file($photo[tmp_name])){echo "not loaded"; exit;} $name=addslashes($name);// allows for single quote ' in name$result=MYSQL_QUERY("INSERT INTO sysexp.photos (sid,name,photo,filename,filesize,filetype,pid,photographer,comment,date,phototitle) "."VALUES ('$sid','$name','$data','$photo[name]','$photo[size]','$photo[type]','$pid','$photog','$comment','$newdate','$phototitle')");    $pid= mysql_insert_id();        $folder = explode("-",$newdate);    $folder = "photos/".$folder[0];    $location = $folder."/".$pid.".jpg";    move_uploaded_file($photo[tmp_name],$location);// create file on server      $sql = "UPDATE photos set link='$location' where pid='$pid'";$result = @mysql_query($sql, $connection) or die("$sql Error 1#". mysql_errno() . ": " . mysql_error());    MYSQL_CLOSE();/*  // ************************************************ These would create a readable file from db pointer set by upload.    Could be used instead of putting upload into MySQL db. See code for sound near end of file//if(!is_uploaded_file($photo[tmp_name])){echo "not loaded"; exit;}//if($photo[type]!="image/jpeg"){echo "Not a jpeg"; exit;}//move_uploaded_file($photo[tmp_name],$photo[name]);// Prepare photo obtained from upload form to add to db$data = addslashes(fread(fopen($_FILES['photo']['tmp_name'], "r"), $_FILES['photo']['size']));     $result=MYSQL_QUERY("INSERT INTO sysexp.photos (name,photo,filename,filesize,filetype,pid,photog,comment,date,ided) ".        "VALUES ('$name','$data','$photo[name]','$photo[size]','$photo[type]','$pid','$photog','$comment','$newdate','$ided')");    $pid= mysql_insert_id();   // MYSQL_CLOSE();    // Hand off photo now IDed by $pid to file that renames and moves it to a folderinclude("writePhoto.php");*/// Displayecho "<br><br><a href='getData.php?pid=$pid&name=$name&sid=$sid' target='_blank'>Show photo for $name in a new window</a>";echo "<br><br><br><a href='edit.php?sid=$sid&v=e'>Return</a>";}     // Show the form to submit a new photoif ($submit == "Add a Photo"){  $sql = "SELECT name FROM site where sid='$sid'";$result = @mysql_query($sql, $connection) or die("$sql Error 1#". mysql_errno() . ": " . mysql_error());$row=mysql_fetch_array($result);extract($row);    MYSQL_CLOSE();    echo "<hr>";?>    <form method="post" action="<?php echo $PHP_SELF; ?>" enctype="multipart/form-data">    Unit: <?php echo $name; ?><br><br>    Date of Photo:     <input type="text" name="datePhoto" value="<?php echo $date; ?>" size="16">  <b>IMPORTANT</b> Enter Date as either yyyy-mm-dd OR m/d/yyyy<br><br>    Photo Title: <input type="text" name="phototitle" value="<?php echo $phototitle; ?>" size="50"><br><br><br>    Photographer: <input type="text" name="photog" value="<?php echo $photographer; ?>" size="50"><br><br>    Comment(s): <textarea cols="40" rows="5" name="comment"><?php echo $comment; ?></textarea><hr>    <INPUT TYPE="hidden" name="sid" value="<?php echo $sid; ?>"    <INPUT TYPE="hidden" name="name" value="<?php echo $name; ?>"    <INPUT TYPE="hidden" name="MAX_FILE_SIZE" value="1000000">    <br>1. Click the BROWSE button and select your photo.<br>    <input type="file" name="photo"  size="40"><input type="hidden" name="pid" value="<?php echo $pid; ?>"    <p>2. Then click this button. <input type="submit" name="submit" value="Add Photo">    </form><?phpecho "<br><br>Make sure your photo is in the JPEG/JPG format, and try to limit the size of your photo to less than 100K. The larger the file, the slower the upload/downloads. For example, a 185K file will take about 1 minute 35 seconds to upload over a 47K modem connection, whereas a 62K will only take about 30 seconds.";}    // Show the form to submit edit photo infoif ($submit == "Edit the Photo Info") {    // else show the form to submit new data:  $photog = urldecode($photog);   $comment = urldecode($comment); ?>    <form action="updatePhoto.php" method="POST"><b><?php echo "$name"; ?></b>    <hr>REVIEW the info.<br><br>    Date of Photo:     <input type="text" name="date" value="<?php echo $date; ?>" size="16">  <b>IMPORTANT</b> Enter Date as either yyyy-mm-dd OR m/d/yyyy<br><br>    Photographer: <input type="text" name="photographer" value="<?php echo $photographer; ?>" size="50"><br><br>   Photo Title:<br><textarea cols="40" rows="2" name="phototitle"><?php echo "$phototitle"; ?></textarea><br>    Comments:<br><textarea cols="40" rows="7" name="comment"><?php echo "$comment"; ?></textarea><?phpecho "<input type='hidden' name='pid' value='$pid'>";?>     <br><br><br><input type="submit" name="submit" value="Submit Edit">    </form><hr><?php }     // Show the form to submit a soundif ($submit == "Add a Sound File"){  $sql = "SELECT name FROM site where sid='$sid'";$result = @mysql_query($sql, $connection) or die("$sql Error 1#". mysql_errno() . ": " . mysql_error());$row=mysql_fetch_array($result);extract($row);    MYSQL_CLOSE();    echo "<hr>";?>    <form method="post" action="<?php echo $PHP_SELF; ?>" enctype="multipart/form-data">    <?php echo "Unit: $name"; ?><br><br>    Date of Sound:     <input type="text" name="dateSound" value="<?php echo $date; ?>" size="16">  <b>IMPORTANT</b> Enter Date as either yyyy-mm-dd OR m/d/yyyy<br><br>    Source of sound:<br>website's URL, original recording, etc. <input type="text" name="source" value="<?php echo $recorder; ?>" size="50"><br><br>    Comment(s): <textarea cols="40" rows="5" name="comment"><?php echo $comment; ?></textarea><hr>    <INPUT TYPE="hidden" name="sid" value="<?php echo $sid; ?>"    <INPUT TYPE="hidden" name="name" value="<?php echo $name; ?>"    <INPUT TYPE="hidden" name="MAX_FILE_SIZE" value="1000000">    <br>1. Click the button to select your sound file.<br>    <input type="file" name="sound"  size="40"><input type="hidden" name="pid" value="<?php echo $pid; ?>"    <p>2. Then click this button. <input type="submit" name="submit" value="Add Sound">    </form>  <?php } ?><?php    // Data from Sound form is processedif ($submit == "Add Sound") {$type = $sound['type']; if($type==""){echo "Improper sound format. Type=$type";exit;}$pos1 = strpos($type, "audio");$pos2 = strpos($type, "video");if($pos1+$pos2 === ""){echo "Make sure the sound file is of a supported type: mp3, wav, or mov. Contact me if you are having difficulty.";exit;}// include("connectsysexp.inc");    mysql_select_db("sysexp.sounds");$timestamp = strtotime($dateSound);$newdate = date("y/m/d", $timestamp);$name = strtoupper($name);$file = $_FILES['sound']['name'];$ext = substr(strrchr($file, "."), 1);// find file extention, mp3 e.g.$file = str_replace(" ","",strtolower($pid)).".".$ext;// remove spacesif(!is_uploaded_file($sound[tmp_name])){echo "not loaded"; exit;}$uploaddir = "sounds/"; $result=MYSQL_QUERY("INSERT INTO sysexp.sounds (sid,comment,type,source) "."VALUES ('$sid','$comment','$type','$source')");    $soid= mysql_insert_id();    $uploadfile = $uploaddir.$soid.$file;move_uploaded_file($sound[tmp_name],$uploadfile);// create file on server      $sql = "UPDATE sounds set link='$uploadfile' where soid='$soid'";$result = @mysql_query($sql, $connection) or die("$sql Error 1#". mysql_errno() . ": " . mysql_error());    MYSQL_CLOSE();// Displayecho "<br><br><a href='$uploadfile' target='_blank'>Listen to Sound for $name in a new window</a>";echo "<br><br><br><a href='edit.php?sid=$sid&v=e'>Return</a>";}// ****************QUAD***************************    // Show the form to submit a new quadif ($submit == "Add a Quad"){  $sql = "SELECT name FROM site where sid='$sid'";$result = @mysql_query($sql, $connection) or die("$sql Error 1#". mysql_errno() . ": " . mysql_error());$row=mysql_fetch_array($result);extract($row);    MYSQL_CLOSE();    echo "<hr>    <form method='post' action='$PHP_SELF' enctype='multipart/form-data'>    Quad Name: <textarea cols='40' rows='1' name='quadName'>$quadName</textarea><hr>    <INPUT TYPE='hidden' name='sid' value='$sid'>    <INPUT TYPE='hidden' name='name' value='$name'>    <INPUT TYPE='hidden' name='MAX_FILE_SIZE' value='3000000'>    <br>1. Click the BROWSE button and select your QUAD in png format.<br>    <input type='file' name='quad'  size='40'><input type='hidden' name='pid' value='$pid'>    <p>2. Then click this button.     <input type='submit' name='submit' value='Add Quad'>    </form><br><br>Make sure your quad is in the PNG format and is less than or equal to 3 MB. If you need to add a quad larger than 3 MB, contact the administrator.";}if ($submit == "Add Quad") {if(!$quadName){echo "You must enter the name of the quad. Click your Browser's BACK button.";exit;}mysql_select_db("sysexp.quad");$quadName = strtoupper($quadName);$size = $_FILES['quad']['size'];$type = $_FILES['quad']['type'];$file = $_FILES['quad']['name'];$ext = substr(strrchr($file, "."), 1);// find file extention, png e.g.// print_r($_FILES); exit;if(!is_uploaded_file($quad[tmp_name])){print_r($_FILES); exit;}if($quad[type]!="image/png"){echo "Not a png"; exit;}$result=MYSQL_QUERY("INSERT INTO sysexp.quad (filename,sid,quadname,filetype,filesize) "."VALUES ('$file','$sid','$quadName','$type','$size')");    $qid= mysql_insert_id();$ext = explode("/",$type);$uploaddir = "quad/";$uploadfile = $uploaddir.$quadName.".".$ext[1];move_uploaded_file($quad[tmp_name],$uploadfile);// create file on server      $sql = "UPDATE quad set link='$uploadfile' where qid='$qid'";$result = @mysql_query($sql, $connection) or die("$sql Error 1#". mysql_errno() . ": " . mysql_error());    MYSQL_CLOSE();// Displayecho "<br><br><a href='$uploadfile' target='_blank'>Show Quad for $name in a new window</a>";echo "<br><br><br><a href='edit.php?sid=$sid&v=e'>Return</a>";	} // ****************MAPS***************************    // Show the form to submit a new mapif ($submit == "Add a Map"){  $sql = "SELECT name FROM site where sid='$sid'";$result = @mysql_query($sql, $connection) or die("$sql Error 1#". mysql_errno() . ": " . mysql_error());$row=mysql_fetch_array($result);extract($row);    MYSQL_CLOSE();    echo "<hr>    <form method='post' action='$PHP_SELF' enctype='multipart/form-data'>    Map Name: <textarea cols='40' rows='1' name='mapName'>$mapName</textarea><hr>    <INPUT TYPE='hidden' name='sid' value='$sid'>    <INPUT TYPE='hidden' name='name' value='$name'>    <INPUT TYPE='hidden' name='MAX_FILE_SIZE' value='3000000'>    <br>1. Click the BROWSE button and select your MAP.<br>    <input type='file' name='map'  size='40'>    <p>2. Then click this button.     <input type='submit' name='submit' value='Add Map'>    </form><br><br>Make sure your Map is less than or equal to 3 MB. If you need to add a map larger than 3 MB, contact the administrator.";}if ($submit == "Add Map") {if(!$mapName){echo "You must enter the name of the map. Click your Browser's BACK button.";exit;}mysql_select_db("sysexp.map");$mapName = strtoupper($mapName);$size = $_FILES['map']['size'];$type = $_FILES['map']['type'];$file = $_FILES['map']['name'];$ext = substr(strrchr($file, "."), 1);// find file extention, png e.g.// print_r($_FILES); exit;if(!is_uploaded_file($map[tmp_name])){print_r($_FILES); exit;}// if($map[type]!="image/png"){echo "Not a png"; exit;}$result=MYSQL_QUERY("INSERT INTO sysexp.map (filename,sid,mapname,filetype,filesize) "."VALUES ('$file','$sid','$mapName','$type','$size')");    $mid= mysql_insert_id();$ext = explode("/",$type);$uploaddir = "maps/";$uploadfile = $uploaddir.$mapName.".".$ext[1];move_uploaded_file($map[tmp_name],$uploadfile);// create file on server      $sql = "UPDATE map set link='$uploadfile' where sid='$sid'";$result = @mysql_query($sql, $connection) or die("$sql Error 1#". mysql_errno() . ": " . mysql_error());    MYSQL_CLOSE();// Displayecho "<br><br><a href='$uploadfile' target='_blank'>Show Map for $name in a new window</a>";echo "<br><br><br><a href='edit.php?sid=$sid&v=e'>Return</a>";	} ?></BODY></HTML>