<?phpinclude("../../include/authPHOTOS.inc");/*echo "<pre>";print_r($_REQUEST);print_r($_SESSION);print_r($_FILES);echo "</pre>";exit;*/if($submit=="Enter"){include("../../include/connectPHOTOS.inc");$sql="select password as checkDB from users where password='$login'";$result = @mysql_query($sql, $connection) or die("$sql Error 1#". mysql_errno() . ": " . mysql_error());$row=mysql_fetch_array($result);extract($row);if(!$checkDB){echo "Sorry, but access is denied.";exit;}header("Location:pubUpload.php?submit=Add a Photo");exit;}if($com){$com1=explode("*",urldecode($com));$comName=$com1[0];$sciName=trim($com1[1]);}?><HTML><HEAD><TITLE>Store photo in THE ID</TITLE><!-- THIS JUMP ONLY WORKS FOR FRAMES --><script language="JavaScript"><!--function MM_jumpMenu(selObj,restore){ //v3.0eval("parent.frames['mainFrame']"+".location='"+selObj.options[selObj.selectedIndex].value+"'");  if (restore) selObj.selectedIndex=0;}//--></script></HEAD><BODY><body bgcolor="#CCFFCC"><?php    // Data from form is processedif ($submit == "Add Photo") {if($park==""){echo "You must designate Park.<br><br>Click your browser's BACK button";exit;}if($cat[0] == "nrid" and $majorGroup == ""){echo "You must designate a Plant or Animal Group for any NRID entry.<br><br>Click your browser's BACK button";exit;}if($cat[0] != "nrid" and $majorGroup != ""){echo "Do NOT designate a Plant or Animal Group for any non-NRID entry.<br><br>Click your browser's BACK button";exit;}if($cat == ""){echo "You must select a <b>Category</b>!<br><br>Click your browser's BACK button";exit;}/*      print "<pre>";print_r($_REQUEST); print_r($_FILES);  print "</pre>";    exit;*/$_SESSION[parkS]=$park;$sciName = $_REQUEST[sciName];$majorGroup = $_REQUEST[majorGroup];include("../../include/connectPHOTOS.inc");include("tnModified.php");// loads functions to make thumbnail$i=0;while ($i < 10) {$category.=$cat[$i].",";     $i++;}//$category=$cat[0].",".$cat[1].",".$cat[2].",".$cat[3].",".$cat[4].",".$cat[5].",".$cat[6].",".$cat[7];//echo "$category"; exit;$newdate = date("Y-m-d");//$newdate = $datePhoto;$park = strtoupper($park);$file = $_FILES['photo']['name'];$uploadFile = $_FILES['photo']['tmp_name'];$ext = substr(strrchr($file, "."), 1);// find file extention, mp3 e.g.// $file = str_replace(" ","",strtolower($sciName)).".".$ext;// remove spacesif(!is_uploaded_file($uploadFile)){echo "No photo was selected or loaded. Click your browser's BACK button."; exit;}// Clean up messy majorGroup when no species name selectedif($majorGroup){$pos1 = strpos($majorGroup, "majorGroup=");if($pos1>1){$mg=explode("majorGroup=",$majorGroup); $majorGroup=$mg[1];}}$personID=str_replace("'","",$personID);// remove ' from O'Neal e.g.$comment=addslashes($comment);$photoname=addslashes($photoname);$photog=addslashes($photog);$personID="public";// By default any public images are marked for deletion$sql="INSERT INTO images (majorGroup,park,filename,filesize,filetype,photoname,photog,comment,date,cd, sciName,cat,personID,mark,lat,lon) "."VALUES ('$majorGroup','$park','$photo[name]','$photo[size]','$photo[type]','$photoname','$photog','$comment','$datePhoto','$cd','$sciName','$category','$personID','x','$lat','$lon')";$result = @mysql_query($sql, $connection) or die("$sql Error 1#". mysql_errno() . ": " . mysql_error());//echo "$sql"; exit;    $pid= mysql_insert_id();        $dir = explode("-",$newdate);    $dirname = $park."_".$dir[0];    $folder = "photos/".$dirname;if (!file_exists($folder)) {mkdir ($folder, 0777);}    $dirname = $park."_".$dir[0]."/".$dir[1];    $folder = "photos/".$dirname;if (!file_exists($folder)) {mkdir ($folder, 0777);}  //  $folder = "photos/".$park."/".$dirname;    $location = $folder."/".$pid.".jpg";    move_uploaded_file($uploadFile,$location);// create file on server// This creates a thumbnail using functions in tnModified.php$p=$pid.".jpg";		$tn=$folder."/ztn.".$p;//$wid=800;//$hei=800;$wid=150;$hei=150;createthumb($folder."/".$p,$tn,$wid,$hei);// Prepare thumbnail of photo obtained from upload form to add to db$data = addslashes(fread(fopen($tn, "r"), filesize ($tn)));  /*// used to debug script       print "<pre>";if (move_uploaded_file($photo[tmp_name],$location)) {    print "File is valid, and was successfully uploaded. ";    print "Here's some more debugging info:\n";    print_r($_FILES);} else {    print "Possible file upload attack!  Here's some debugging info:\n";    print_r($_FILES);    print_r($_REQUEST); echo "$location";}print "</pre>"; */      $sql = "UPDATE images set link='$location',photo='$data', height='$old_y', width='$old_x' where pid='$pid'";$result = @mysql_query($sql, $connection) or die("$sql Error 1#". mysql_errno() . ": " . mysql_error());    MYSQL_CLOSE();// Encode to preserve apostrophe '$photoname=urlencode($photoname);// Displayif($sciName){$sn = "SciName=".$sciName;$cn = "ComName=".$comName;}echo "<table>		<tr><td>$sn</td><td>$cn</></tr>		<tr><td><img src='$tn'></td></tr>		<tr><td>$photoname by $photog on $datePhoto</td></tr>		<tr><td>$comment</td></tr><tr><td><br><a href='getData.php?pid=$pid&location=$location&pub=y'>Show the full-size photo</a></td></tr>";echo "<tr><td><br><a href='pubUpload.php?pid=$pid&submit=Edit the Photo Info&photoname=$photoname&photog=$photog&comment=$comment&date=$newdate'>Edit</a> the info.</td></tr><tr><td><br></td></tr><tr><td><br><a href='pubUpload.php?submit=Add a Photo'>Add</a> another photo.</td></tr></table>";exit;} // *******************************************    // Show the form to submit a new photoif ($submit == "Add a Photo" or $submit == "Add species"){//print_r($_SESSION);if($_SESSION[photos][loginS]=="ADMIN"){$employeeID="Employee ID (Lname1234):     <input type='text' name='personID' value='$personID' size='26'>";}else{$employeeID="";}include("../../include/parkcodesDiv.inc");if($category){if(strpos($category, "nrid")>0){$nridCKED="checked";}if(strpos($category, "scenic")>0){$sceCKED="checked";}if(strpos($category, "act")>0){$actCKED="checked";}if(strpos($category, "cultural")>0){$culCKED="checked";}if(strpos($category, "visit")>0){$visitorCKED="checked";}if(strpos($category, "main")>0){$mainCKED="checked";}if(strpos($category, "fac")>0){$facCKED="checked";}if(strpos($category, "staff")>0){$staffCKED="checked";}if(strpos($category, "other")>0){$otherCKED="checked";}if(strpos($category, "resource")>0){$resmanCKED="checked";}if(strpos($category, "people")>0){$peopleCKED="checked";}}if($datePhoto){$year=$datePhoto;}else{$year=date("Y-m-");}if($dateNRID){$year=$dateNRID;}if(!$cd){$cd="none";} // set cd to none if blank    echo "Enter the appropriate info.<hr> <form method='post' action='pubUpload.php' enctype='multipart/form-data'>";include("GroupArray.inc");$arrayNum = count($GroupArrayN);$i = 1;$file="listTest.php?park=$park&majorGroup=";echo "Select the <b>Group</b><br><select name=\"majorGroup\" onChange=\"MM_jumpMenu(this,0)\">\n"; echo "<option value=''>\n"; $i=1;while ($i <= $arrayNum) {if($majorGroup == $GroupArrayN[$i]){$ck="selected";}else{$ck="value";}     echo "<option $ck=\"$file$GroupArrayV[$i]\">$GroupArrayN[$i]\n";     $i++;}echo "</select>\n";echo "Select Group (<font color='red'>required</font>)<br>";echo "<br><b>Park:</b><select name='park'>";$j=0;$k=count($parkCode);$parkC=$_SESSION[parkS];if($parkNRID){$parkC=$parkNRID;}while ($j < $k) {if($parkCode[$j]==$parkC){$v="selected";}else{$v="value";}     echo "<option $v='$parkCode[$j]'>$parkCode[$j]\n";     $j++;}echo "</select> (<font color='red'>required</font>)<br>";echo "<input type='hidden' name='cat[0]' value='nrid'><br>Date of Photo:     <input type='text' name='datePhoto' value='$year' size='16'><br><br>";if($observer){$observer=urldecode($observer);$photog=$observer;}// passed from NRIDecho "Name of Photo: <input type='text' name='photoname' value='$photoname' size='50'><br><br>    Photographer(s): <input type='text' name='photog' value='$photog' size='50'><br><br>    Comment(s): <textarea cols='40' rows='5' name='comment'>$comment</textarea><br/><br />Latitude:     <input type='text' name='lat' value='$lat' size='10'>    Longitude:     <input type='text' name='lon' value='$lon' size='10'>        <hr>    <INPUT TYPE='hidden' name='MAX_FILE_SIZE' value='30000000'>    <br>1. Click the BROWSE (or Choose File) button and select your photo.<br>    <input type='file' name='photo'  size='40'><input type='hidden' name='sciName' value='$sciName'><input type='hidden' name='comName' value=\"$comName\">    <p>2. Then click this button. <input type='submit' name='submit' value='Add Photo'>    </form>";echo "</BODY></HTML>";exit;}    // Show the form to submit edit photo infoif ($submit == "Edit the Photo Info") {    // else show the form to submit new data:  $photoname = urldecode($photoname);  $cd = urldecode($cd);  $photog = urldecode($photog);   $link = urldecode($link);   $comment = urldecode($comment);  $NSsciName = urlencode($sciName); if($_SESSION[photos][loginS]=="ADMIN"){$employeeID="Employee ID (Lname1234):     <input type='text' name='personID' value='$personID' size='26'>";}else{$employeeID="";}echo "<form action='pubUpload.php' method='POST'>Park: <b>$park</b><br>"; echo "<hr>EDIT the info and Submit.<br><br>    CD Name:     <textarea cols='25' rows='1' name='cd'>$cd</textarea>    Photo Name:     <textarea cols='40' rows='1' name='photoname'>$photoname</textarea> <br>$employeeID<br>   Date of Photo:     <input type='text' name='date' value='$date' size='16'>  <b>IMPORTANT</b> Enter Date as either yyyy-mm-dd OR m/d/yyyy<br><br>    Photographer: <textarea cols='40' rows='1' name='photog'>$photog</textarea><br><br>    Comment:<br><textarea cols='40' rows='5' name='comment'>$comment</textarea><br/><br />Latitude:     <input type='text' name='lat' value='$lat' size='10'>    Longitude:     <input type='text' name='lon' value='$lon' size='10'><input type='hidden' name='pub' value='y'><input type='hidden' name='pid' value='$pid'><input type='hidden' name='link' value='$link'><br><br><br><input type='submit' name='submit' value='Submit Edit'>    </form><hr></BODY></HTML>";exit;}    // UPDATE photo infoif ($submit == "Submit Edit") { //print_r($_REQUEST); EXIT;include("../../include/connectPHOTOS.inc");  $photoname = addslashes($photoname);  $photog = addslashes($photog);   $link = urldecode($link);   $comment = addslashes($comment);   $discus = urldecode($discus);   $cd = urldecode($cd);   $personID=str_replace("'","",$personID);if($lon>0){$lon=(-$lon);}     $sql = "UPDATE images set photoname='$photoname',cd='$cd',date='$date',photog='$photog',comment='$comment',personID='$personID', lat='$lat', lon='$lon'  where pid='$pid'";$result = @mysql_query($sql, $connection) or die("$sql Error 1#". mysql_errno() . ": " . mysql_error());    MYSQL_CLOSE();header("Location: getData.php?pid=$pid&pub=y");exit;}echo "<form action='pubUpload.php'>Login <input type='text' name='login'><input type='submit' name='submit' value='Enter'</form>";?>