<?php//These are placed outside of the webserver directory for security$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/iConnect.inc"); // connection parametersmysqli_select_db($connection, $database); // databasesession_start();extract($_REQUEST);/*$ckCenter=explode("-",$center);// parse $center when = sec-parkcode-centerif($ckCenter[2]){$center=$ckCenter[2];}// Construct Query to be passed to Excel Export$varQuery="submit=Submit&center=$center&budget_group=$budget_group&track_rcc=$track_rcc";*///print_r($_SESSION);//EXIT;//print_r($_REQUEST);//EXIT;$level=$_SESSION[budget][level];$m="1";if($level==2){if($_SESSION[budget][select]=="SODI"){$DI="south";}if($_SESSION[budget][select]=="NODI"){$DI="north";}if($_SESSION[budget][select]=="EADI"){$DI="east";}if($_SESSION[budget][select]=="WEDI"){$DI="west";}$distWhere="and dist='$DI'";}if($rep==""){include("../menu.php");// Display Formecho "<html><header></header<title>Operating Expense Available Totals</title><body><table align='center'><form method='POST' action='opex_available_center_totals.php'>";if($level>3){echo "<tr>";if($dist){$distWhere="and dist='$dist'";}$sql="SELECT distinct(center.dist) as passDistfrom available_fundsleft join center on available_funds.center=center.centerwhere 1 and dist != ''order by center.dist";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");while($row=mysqli_fetch_array($result)){$menuDist[]=$row[passDist];}   echo "<td>District: <select name=\"dist\">";echo "<option selected=''>\n";for ($n=0;$n<count($menuDist);$n++){$con=$menuDist[$n];if($con==$dist){$s="selected";}else{$s="value";}		echo "<option $s='$con'>$menuDist[$n]\n";       }   echo "</select></td>";echo "<td>Show SQL <input type='checkbox' name='showSQL' value='x'></td>";echo "<td><input type='submit' name='submit' value='Submit'></td></form></tr></table>";}}else{echo "<html><header></header><title>Operating Expense Available Totals</title><body>";}if($submit!=""){// Make f_yearif($f_year==""){$testMonth=date(n);if($testMonth >0 and $testMonth<8){$year2=date(Y)-1;}if($testMonth >7){$year2=date(Y);}$yearNext=$year2+1;$yx=substr($year2,2,2);$year3=$yearNext;$yy=substr($year3,2,2);$f_year=$yx.$yy;}$today_60=date("Ymd",mktime(0,0,0,date(m),date(d)-60,date(Y)));$sql="SELECT max(acctdate) as max from exp_rev WHERE 1";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$row=mysqli_fetch_array($result);extract($row); $sql="truncate table available_funds;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL){echo "<br><br>$sql";}//exit;$sql="INSERT INTO available_funds( center, ncas_number, f_year, py_amount, allocation_amount, cy_actual, transfer_request )SELECT center, act3.ncasnum, '', sum( amount_py1 ) AS 'py_amount', sum( allocation_amount ) AS 'allocation_amount', sum( amount_cy ) AS 'amount_cy', ''FROM act3LEFT JOIN coa ON act3.ncasnum = coa.ncasnumWHERE 1 AND coa.budget_group = 'operating_expenses' AND coa.track_rcc = 'y' AND coa.ncasnum != '531311'GROUP BY center, act3.ncasnum;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL){echo "<br><br>$sql";}//exit;$sql="INSERT INTO available_funds( center, ncas_number, f_year, py_amount, allocation_amount, cy_actual, transfer_request )SELECT center, ncas_number, f_year, '', '', '', transfer_requestFROM opexpense_transfers_3WHERE 1 AND f_year = '$f_year' ANDSTATUS = 'not_processed';";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL){echo "<br><br>$sql";}//exit;$sql="INSERT INTO available_funds( center, ncas_number, f_year, py_amount, allocation_amount, cy_actual, transfer_request, unposted_codesheet, unposted_pcard )SELECT ncas_center, ncas_account, '', '', '', '', '', sum( ncas_invoice_amount ) , ''FROM cid_vendor_invoice_paymentsLEFT JOIN coa ON cid_vendor_invoice_payments.ncas_account = coa.ncasnumWHERE 1  AND post2ncas != 'y' AND budget_group = 'operating_expenses' AND coa.track_rcc = 'y'GROUP BY ncas_center, ncas_number;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL){echo "<br><br>$sql";}//exit;//AND datesql >= '$today_60' and f_year='$f_year'$sql="INSERT INTO available_funds( center, ncas_number, f_year, py_amount, allocation_amount, cy_actual, transfer_request, unposted_codesheet, unposted_pcard )SELECT center, ncasnum, '', '', '', '', '', '', sum( amount )FROM pcard_unreconciledWHERE 1 AND post2ncas = ''GROUP BY center, ncasnum;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL){echo "<br><br>$sql";}//exit;$sql="SELECT center.parkcode AS 'center_code', available_funds.center, center.dist, center.section, sum( py_amount + allocation_amount ) AS 'cy_budget', sum( cy_actual ) AS 'cy_actual', sum( py_amount + allocation_amount - cy_actual ) AS 'posted_balance', sum( unposted_codesheet ) AS 'unposted_codesheet', sum( unposted_pcard ) AS 'unposted_pcard', sum( py_amount + allocation_amount - cy_actual - unposted_codesheet - unposted_pcard ) AS 'available_balance'FROM available_fundsLEFT JOIN coa ON available_funds.ncas_number = coa.ncasnumLEFT JOIN center ON available_funds.center = center.centerWHERE 1 AND center.fund = '1280' $distWhereGROUP BY available_funds.centerORDER BY center.parkcode";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL){echo "<br><br>$sql";}//exit;$num=mysqli_num_rows($result);if($rep=="excel"){header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment; filename=operating_expense_available.xls');}// Display Resultsecho "<table border='1' align='center'><tr><td colspan='4' align='center'><font color='blue'>$num</font> records returned for Report Date: <font color='red'>$max</font></td><td colspan='4' align='center'><a href='/budget/c/transactions_unposted.php?budget_group=operating_expenses&track_rcc=y&submit=Submit'>Reconcile Unposted Transactions</a></td></tr>";$header="<tr><th>center_code</th><th>center</th><th>dist</th><th>section</th><th>cy_budget</th><th>cy_actual</th><th>posted_balance</th><th>unposted_codesheet</th><th>unposted_pcard</th><th>available_balance</th></tr>";echo "$header";while($row=mysqli_fetch_array($result)){extract($row); $cy_budgetTotal+=$cy_budget;$cy_actualTotal+=$cy_actual;$posted_balanceTotal+=$posted_balance;$unposted_codesheetTotal+=$unposted_codesheet;$unposted_pcardTotal+=$unposted_pcard;$available_balanceTotal+=$available_balance;$cy_budget=number_format($cy_budget,2);$cy_actual=number_format($cy_actual,2);$posted_balance=number_format($posted_balance,2);$unposted_codesheet=number_format($unposted_codesheet,2);$unposted_pcard=number_format($unposted_pcard,2);$available_balance=number_format($available_balance,2);$link_center_code="<a href='/budget/c/operating_expense_available.php?submit=Submit&center=$center' target='_blank'>$center_code</a>";echo "<tr><td align='center'>$link_center_code</td><td>$center</td><td>$dist</td><td>$section</td><td align='right'>$cy_budget</td><td align='right'>$cy_actual</td>";if($posted_balance<0){$f1="<font color='red'>";$f2="</font>";}else{$f1="";$f2="";}echo "<td align='right'>$f1$posted_balance$f2</td><td align='right'>$unposted_codesheet</td><td align='right'>$unposted_pcard</td>";if($available_balance<0){$f1="<font color='red'>";$f2="</font>";}else{$f1="";$f2="";}echo "<td align='right'>$f1$available_balance$f2</td></tr>";}$cy_budgetTotal=number_format($cy_budgetTotal,2);$cy_actualTotal=number_format($cy_actualTotal,2);$posted_balanceTotal=number_format($posted_balanceTotal,2);$unposted_codesheetTotal=number_format($unposted_codesheetTotal,2);$unposted_pcardTotal=number_format($unposted_pcardTotal,2);$available_balanceTotal=number_format($available_balanceTotal,2);echo "<tr><td colspan='4' align='right'><b>Totals:</b></td><td align='right'>$cy_budgetTotal</td><td align='right'>$cy_actualTotal</td><td align='right'>$posted_balanceTotal</td><td align='right'>$unposted_codesheetTotal</td><td align='right'>$unposted_pcardTotal</td>";if($available_balanceTotal<0){$f1="<font color='red'>";$f2="</font>";}else{$f1="";$f2="";}echo "<td align='right'>$f1$available_balanceTotal$f2</td></tr>";if($rep==""){echo "$header";}echo "</table></body></html>";}?>