<?php$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/iConnect.inc"); // connection parametersmysqli_select_db($connection, $database); // databaseinclude("../../../include/authBUDGET.inc");include("../../../include/activity.php");if($_SESSION['budget']['level'] < 3){echo "You do not have access to this report.";exit;}extract($_REQUEST);$sql="Select date_format(max(acctdate),'%m/%d/%Y') as maxDate from exp_rev where 1"; $result = @mysqli_query($connection, $sql,$connection);$row=mysqli_fetch_array($result); extract($row);if($section==""){include("park_budget_menu.php");//print_r($_REQUEST);//print_r($_SESSION);// Get menu values for section$sql="select distinct section    from center    where center like '1280%'    order by section";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 1. $sql");while ($row=mysqli_fetch_array($result)){$sectArray[]=$row['section'];}echo "<html><table><tr>";echo "<td>Section: <select name=\"section\" onChange=\"MM_jumpMenu('parent',this,0)\"><option selected></option>";foreach($sectArray as $k=>$v){if($section==$v){$s="selected";}else{$s="value";}		echo "<option $s='op_exp_transfer_section?section=$v'>$v</option>\n";       }   echo "</select></td></tr></table>";}if($section==""){exit;}include("../~f_year.php");// ********** Queries *********** $query = "truncate table budget1_unposted;";    $result = @mysqli_query($connection, $query,$connection);if($showSQL=="1"){echo "$query<br><br>";}//echo "$query<br><br>";/*inserts  */ $query = "insert into budget1_unposted(center,account,vendor_name,transaction_date,transaction_number,transaction_amount,transaction_type,source_table,source_id)selectncas_center,ncas_account,vendor_name,datesql,ncas_invoice_number,ncas_invoice_amount,'cdcs','cid_vendor_invoice_payments',idfrom cid_vendor_invoice_paymentswhere 1and post2ncas != 'y'group by id"; $result = @mysqli_query($connection, $query,$connection);if($showSQL=="1"){echo "$query<br><br>";}/*inserts   */ $query = "insert into budget1_unposted(center,account,vendor_name,transaction_date,transaction_number,transaction_amount,transaction_type,source_table,source_id)selectcenter,ncasnum,concat('pcard','-',cardholder,'-',vendor_name,'-',trans_date),transdate_new,transid_new,sum(amount),'pcard','pcard_unreconciled',idfrom pcard_unreconciledwhere 1and ncas_yn != 'y'group by id;";  $result = @mysqli_query($connection, $query,$connection);if($showSQL=="1"){echo "$query<br><br>";}/*inserts */ $query = "insert into budget1_unposted(center,account,vendor_name,transaction_date,transaction_number,transaction_amount,transaction_type,source_table,source_id)selectcenter,ncasnum,concat(postitle,'-',posnum,'-',tempid),datework,'na',sum(rate*hr1311),'seapay','seapay_unposted',pridfrom seapay_unpostedwhere 1group by prid"; $result = @mysqli_query($connection, $query,$connection);if($showSQL=="1"){echo "$query<br><br>";}/*TRUNCATE */ $query = "truncate table budget1_available;"; $result = @mysqli_query($connection, $query,$connection);if($showSQL=="1"){echo "$query<br><br>";} /*inserts   */ $query = "insert into budget1_available(center,account,py1_amount,allocation_amount,cy_amount,unposted_amount,source)selectcenter,ncasnum,sum(amount_py1),'',sum(amount_cy),'','act3'from act3where 1group by center,ncasnum;"; $result = @mysqli_query($connection, $query,$connection);if($showSQL=="1"){echo "$query<br><br>";}/*inserts */ $query = "insert into budget1_available(center,account,py1_amount,allocation_amount,cy_amount,unposted_amount,source)select center,ncas_acct,'',sum(allocation_amount),'','','budget_center_allocations'frombudget_center_allocationswhere 1and fy_req='$f_year'group by center,ncas_acct;"; $result = @mysqli_query($connection, $query,$connection);if($showSQL=="1"){echo "$query<br><br>";}/*inserts */ $query = "insert into budget1_available(center,account,py1_amount,allocation_amount,cy_amount,unposted_amount,source)selectcenter,account,'','','',sum(transaction_amount),'budget1_unposted'from budget1_unpostedwhere 1and post2ncas != 'y'group by center,account;"; $result = @mysqli_query($connection, $query,$connection);if($showSQL=="1"){echo "$query<br><br>";}/*UPDATE */ $query = "update budget1_available,coaset budget1_available.budget_group=coa.budget_groupwhere budget1_available.account=coa.ncasnum;"; $result = @mysqli_query($connection, $query,$connection);if($showSQL=="1"){echo "$query<br><br>";}$sql="select center.parkcode,budget1_available.center,sum( py1_amount) as 'py_amount',sum( allocation_amount) as 'cy_allocation',sum( py1_amount+allocation_amount) as 'cy_budget',sum( cy_amount) as 'cy_posted', sum( unposted_amount) as 'cy_unposted', sum(py1_amount+allocation_amount-cy_amount-unposted_amount) as 'available_funds' from budget1_availableleft join center on budget1_available.center=center.centerleft join coa on budget1_available.account=coa.ncasnumwhere 1 and budget1_available.center like '1280%' and budget1_available.budget_group='operating_expenses'and center.section='$section'  and stateparkyn='n'group by budget1_available.centerorder by parkcode;";//echo "$sql<br>";if($showSQL=="1"){echo "$sql<br>";}//$varQuery=$_SERVER[QUERY_STRING];echo "<table border='1'><tr><td colspan='6'>Click your browser's back button when done.</td></tr><tr>";$headerArray=array("parkcode","center","dist","section","budget_group","py_amount","cy_allocation","cy_budget","cy_posted", "cy_unposted","available_funds", "months_used", "transfer_request");$dontShow=array("dist","section","budget_group");$count=count($headerArray);for($i=0;$i<$count;$i++){$h=$headerArray[$i];if(!in_array($h,$dontShow)){	$selectFields.=$h.",";if($rep==""){$h=str_replace("_","<br>",$h);}	$header.="<th>".$h."</th>";					}	}	if($rep=="excel"){echo "$header</tr>";} // see fmod below$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");//$num=mysqli_num_rows($result);while($row=mysqli_fetch_array($result)){extract($row);$a_parkcode[]=$parkcode;// 1$a_center[]=$center;// 2$a_dist[]=$dist;// 3$a_section[]=$section;// 4$a_budget_group[]=$budget_group;// 5$a_account[]=$account;// 6$a_account_description[]=$account_description;// 7$a_py_amount[]=$py_amount;// 8$a_cy_allocation[]=$cy_allocation;// 9$a_cy_budget[]=$cy_budget;// 10$a_cy_posted[]=$cy_posted;// 11$a_cy_unposted[]=$cy_unposted;// 12$a_available_funds[]=$available_funds;// 13$a_months_used[]=round(($cy_posted+$cy_unposted)/($cy_budget/12),1);// 14}// end whileecho "<form action='op_exp_transfer_update_section.php'><tr><td colspan='9'><font color='red'>Report Date: $maxDate</font></td></tr>";$yy=10;for($i=0;$i<count($a_parkcode);$i++){$x=2;$r=fmod($i,$x);if($r==0){$bc=" bgcolor='aliceblue'";}else{$bc="";}$body ="<tr$bc>";$center=$a_center[$i];$acct=$a_account[$i];$cy_posted=$a_cy_posted[$i];if($level<2){$tunnelPost="<a href='/budget/c/tunnel_cy_actual.php?center=$center&acct=$acct&cy_actual=$cy_posted' target='_blank'>$cy_posted</a>";}else{$tunnelPost=$cy_posted;}$cy_unposted=$a_cy_unposted[$i];/*$tunnelUnpost="<a href='/budget/c/tunnel_cy_unpost.php?center=$center&acct=$acct' target='_blank'>$cy_unposted</a>";*/if($level<2){$tunnelUnpost="<a href='/budget/c/tunnel_cy_unpost.php?center=$center&acct=$acct' target='_blank'>$cy_unposted</a>";}else{$tunnelUnpost=$cy_unposted;}if(fmod($i,$yy)==0 and $rep==""){echo "$header";}if($a_available_funds[$i]<0){$fv1="<font color='red'>";$fv2="</font>";}else{$fv1="";$fv2="";}$body.="<td align='center'>$a_parkcode[$i]</td><td align='right'>$a_center[$i]</td><td align='right'>$a_py_amount[$i]</td><td align='right'>$a_cy_allocation[$i]</td><td align='right'>$a_cy_budget[$i]</td><td align='right'>$tunnelPost</a></td><td align='right'>$tunnelUnpost</td><td align='right'>$fv1$a_available_funds[$i]$fv2</td><td align='right'>$a_months_used[$i]</td><td align='right'><input type='text' name='transfer_request[$center]' size='7'></td></tr>";$tot_py_amount+=$a_py_amount[$i];$tot_cy_allocation+=$a_cy_allocation[$i];$tot_cy_budget+=$a_cy_budget[$i];$tot_cy_posted+=$a_cy_posted[$i];$tot_cy_unposted+=$a_cy_unposted[$i];$tot_available_funds+=$a_available_funds[$i];echo "$body";}$amount=numFormat($tot_py_amount);$allocation=numFormat($tot_cy_allocation);$budget=numFormat($tot_cy_budget);$posted=numFormat($tot_cy_posted);$unposted=numFormat($tot_cy_unposted);$funds=numFormat($tot_available_funds);$calc_months=round(($tot_cy_posted+$tot_cy_unposted)/($tot_cy_budget/12),1);echo "<tr><td colspan='3' align='right'><b>$amount</b></td><td align='right'><b>$allocation</b></td><td align='right'><b>$budget</b></td><td align='right'><b>$posted</b></td><td align='right'><b>$unposted</b></td><td align='right'><b>$funds</b></td><td align='right'><b>$calc_months</b></td></tr>";if($level>0 and $doNotUpdate==""){$user_id=$_SESSION[budget][tempID];$today=date("Y-m-d");echo "<tr><td colspan='10' align='right'><input type='hidden' name='source' value='section'><input type='hidden' name='user_id' value='$user_id'><input type='hidden' name='today' value='$today'><input type='hidden' name='f_year' value='$f_year'><input type='submit' name='submit' value='Update'></td></form>";}echo "</table></body></html>";function numFormat($nf){if($nf<0){$fv1="<font color='red'>";$fv2="</font>";}else{$fv1="";$fv2="";}$nf=$fv1.number_format($nf,2).$fv2;return $nf;}?>