<?php//These are placed outside of the webserver directory for security//include("../../include/authEEID.inc"); // used to authenticate users$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/iConnect.inc"); // connection parametersmysqli_select_db($connection, $database); // databaseinclude("../css/TDnull.inc");extract($_REQUEST);// Construct Query to be passed to Excel Export$varQuery="dbTable=$dbTable&center=$center&f_year=$f_year&acct=$acct";// FIELD NAMES to be shown are in $fieldShowArray$fieldShowArray=array("CENTER","FUND","ACCTDATE","INVOICE","PE","DESCRIPTION","DEBIT","CREDIT","SYS","ACCT","F_YEAR","MONTH","CALYEAR","WHID");$fieldSelect="CENTER,FUND,ACCTDATE,INVOICE,PE,DESCRIPTION,DEBIT,CREDIT,SYS,ACCT,F_YEAR,MONTH,CALYEAR,WHID";// FIELD NAMES are stored in $fieldArray// FIELD TYPES and SIZES are stored in $fieldType$sql = "SHOW COLUMNS FROM $dbTable";//echo "$sql";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 1. $sql");$numFlds=mysqli_num_rows($result);while ($row=mysqli_fetch_assoc($result)){extract($row);$test=strtoupper($Field);if(in_array($test,$fieldShowArray)){$fieldArray[]=$row[Field];$fieldType[]=$row[Type];}}//echo "<pre>";print_r($fieldArray);echo "</pre>";exit;$recordIDfld=$fieldArray[$numFlds-1];makeUpdateFields($fieldArray);// MAKE FIELD=VALUE FOR ADD/UPDATEfor($dk=0;$dk<count($fieldType);$dk++){$varD=substr($fieldType[$dk],0,7);if($varD=="decimal"){$fieldDecimal[]=$dk;}if($varD=="varchar"){$size=substr(substr($fieldType[$dk],8,7),0,-1);if($size>30){$size=30;}$fieldSize[]=$size;}else{$fieldSize[]=12;}}//print_r($fieldSize);//exit;// Find number fieldsfor($dk=0;$dk<count($fieldDecimal);$dk++){$t=$fieldDecimal[$dk];$varE[$fieldArray[$t]]=$fieldDecimal[$dk];}//**** Prepare To Find, Update OR Delete******function pullDown($m){global $like;$menu1=array("Like","Range","Not");if($like[$m]=="Like"){$like[$m]=1;}if($like[$m]=="Range"){$like[$m]=2;}if($like[$m]=="Not"){$like[$m]=3;}echo "<select name=\"like[$m]\"><option selected></option>";for ($n=0;$n<count($menu1);$n++){$con=$n+1;if($con==$like[$m]){$s="selected";}else{$s="value";}echo "<option $s='$con'>$menu1[$n]\n";       }  echo "</select>";}// Used \" instead of ' because of lastname or vendor name containing 'if($_SESSION[budget][level]>1){//echo "<form action=\"portal.php\" method=\"post\">";echo "<form action=\"portal.php\"";// Used to debugecho "<table><tr><td colspan='3'>You are working with table <font color=\"blue\">$dbTable</font>$rangeOfDates</td></tr><tr><td>$fieldArray[0]:"; pullDown(0); echo "<input type=\"text\" name=\"$fieldArray[0]\" size=\"$fieldSize[0]\" value=\"${$fieldArray[0]}\"</td></tr><tr><td>$fieldArray[1]:"; pullDown(1); echo " <input type=\"text\" name=\"$fieldArray[1]\" size=\"$fieldSize[1]\" value=\"${$fieldArray[1]}\"></td>";// lastnamefor($i=2;$i<4;$i++){echo "<td>$fieldArray[$i]:  "; pullDown($i); echo "<input type=\"text\" name=\"$fieldArray[$i]\" size=\"$fieldSize[$i]\" value=\"${$fieldArray[$i]}\"></td>";}echo "<td></tr>";echo "<tr>";for($i=4;$i<7;$i++){echo "<td>$fieldArray[$i]:  "; pullDown($i); echo "<input type=\"text\" name=\"$fieldArray[$i]\" size=\"$fieldSize[$i]\" value=\"${$fieldArray[$i]}\"></td>";}echo "</tr>";// companyecho "<tr>";for($i=7;$i<10;$i++){echo "<td>$fieldArray[$i]:  "; pullDown($i); echo "<input type=\"text\" name=\"$fieldArray[$i]\" size=\"$fieldSize[$i]\" value=\"${$fieldArray[$i]}\"></td>";}echo "</tr><tr>";// amt$j=1;for($i=10;$i<23;$i++){if($fieldArray[$i]){$f=fmod($j,4);if($f==0){$tagB="<tr><td>";$tagE="</td></tr>";$j++;}else{$tagB="<td>";$tagE="</td>";$j++;}echo "$tagB $fieldArray[$i]:  "; pullDown($i); echo "<input type=\"text\" name=\"$fieldArray[$i]\" size=\"$fieldSize[$i]\" value=\"${$fieldArray[$i]}\">$tagE";}}echo "</table>";}// end if level > 1  // ***** Pick display function and set sql statement$co=count($_REQUEST); //print_r($_REQUEST);echo "c=$co";exit;//$from="*";// Default - gets used if not Group By$from=$fieldSelect;// ******* Group By Variables*******// *** Make list of Fields to pass to GroupBy and Function portalHeader$passFields=$fieldArray[0];for($pf=1;$pf<count($fieldArray);$pf++){$passFields.=",".$fieldArray[$pf];}$from.=" From $dbTable";// ********* Assign passed Values by Fieldfor($j=0;$j<count($fieldArray);$j++){$passVal[$j]=${$fieldArray[$j]};}// ********* Where **********if($co>0){$where=" WHERE 1";}else{exit;}//                     **************************         Create WHERE statementfor($k=0;$k<count($fieldArray);$k++){if($passVal[$k]!=""){$dbFld=$fieldArray[$k];$dbVal=addslashes($passVal[$k]);if($like[$k]==""){$where.=" and $dbFld = '$dbVal'";}if($like[$k]==1){$where.=" and $dbFld like '%$dbVal%'";}if($like[$k]==2){$rangeDate=explode("*",$dbVal);if($rangeDate[0]!=""&&$rangeDate[1]==""){$where.=" and $dbFld='$rangeDate[0]'";}else{$where.=" and $dbFld>='$rangeDate[0]' and $dbFld<='$rangeDate[1]'";}}if($like[$k]=="3"){$where.=" and $dbFld != '$dbVal'";}}// order by $dbFld}// end for loopif($where==" WHERE 1"){exit;}if($datenew and $dbTable=="vendor_payments"){$dateRange=explode("*",$datenew);$o="ORDER by datenew DESC";$where.=" and datenew>='$dateRange[0]' and datenew<='$dateRange[1]'";}$sql1 = "SELECT $from $where $o";if($passSQL){$sql1=urldecode($passSQL);}//echo "$sql1<br>";echo "<pre>";print_r($fieldArray);echo "</pre>";//exit;if($sql1){// ********** This displays the result **********portalHeader($passSQL,$passFields,$countKeys,$sumBy,$totHeader,$countHeader);// Make Header//echo "$sql1";//exit;$result = mysqli_query($connection, $sql1) or die ("Couldn't execute query 2. $sql1");$num=mysqli_num_rows($result);if($num<1 and $dbTable=="pcard"){echo "Unable to find a Pcard transaction for that amount: $amt.";exit;}if($rep=="excel"){header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment; filename=Operating_Expense_Approval.xls');}else{echo "<a href='portal_ven_pay.php?$varQuery&rep=excel'>Excel Export</a><br>";}if($num>1000){$sql1 = "SELECT $from $where $g limit 1000";$result = mysqli_query($connection, $sql1) or die ("Couldn't execute query 3. $sql1");echo "<font color='red'>$num</font> records were found. However, only the first <font color='red'>1000</font> are being displayed. Let Tom Howard know if you need to view more than 1000 at a time.<br>";}else{echo "$num <font color='green'>$z Transactions from Expense - Revenue table.</font><hr>";}while ($row=mysqli_fetch_array($result)){itemShow($row,$passSQL,$dbTable,$sumBy,$varE,$decimalValues);}		$test1=round($passAmt);$test2=round($totAmount);if($test1!=$test2){$center="1280".$rcc;$passAmt=number_format($passAmt,2);$m="*** Vendor Payments do not equal Revenue/Expenses [$passAmt]. There was probably a credit to the Account. Check <a href='/budget/a/portal_ven_pay.php?dbTable=exp_rev&acct=$account&center=$center&f_year=0405'>here</a>";}if($totAmount!="0.00"){$totAmount=number_format($totAmount,2);echo "Total Payments: <font color='blue'>$totAmount</font><font color='teal'> $m</font> $totCredit $totDebit";}else{$tot=number_format($totCredit-$totDebit,2);$totCredit=number_format($totCredit,2);$totDebit=number_format($totDebit,2);echo "Credits: <font color='blue'>$totCredit</font> - Debits: <font color='teal'>$totDebit</font> Total = <font color='red'> $tot</font> for Center $center";}echo "</table></body></html>";}// **************  FUNCTIONS *******************function portalHeader($passSQL,$passFields,$countKeys,$sumBy,$totHeader,$countHeader){global $numOfColumns,$fld0Dec,$fld1Dec,$fld2Dec,$fld,$countKeys,$lastFld;// pass to itemShow//echo "t=$totHeader";exit;//print_r($passFields);//exit;$fld=explode(",",$passFields);// Put Field Names in an Array$c=count($fld)-1;$lastFld=$fld[$c];for($zz=0;$zz<$countKeys;$zz++){$q="fld".$zz."Dec";$r=${$q};$zSum[]="SUM".$r;}if($totHeader){array_unshift($fld, "Total");}if($countHeader){for($zz=0;$zz<$countHeader;$zz++){array_unshift($fld, "Count");}}//$zSum=array_reverse($zSum);for($zz=0;$zz<count($zSum);$zz++){array_unshift($fld, $zSum[$zz]);}if($countKeys<1 and $sumBy){//array_unshift($fld, "Count");}//print_r($fld);//exit;$numOfColumns=count($fld);//$link="<a href='portal.php?park=$park'>$park</a>";echo "<table border='1' cellpadding='3'><tr>";for($x=0;$x<$numOfColumns;$x++){$var=strtoupper($fld[$x]);echo "<th>$var</th>";}echo "</tr>";}function getDecimalFields($varE){global $fld0Dec,$fld1Dec,$fld2Dec;$decimalKeys=array_keys($varE);$fld0Dec=$decimalKeys[0];$fld1Dec=$decimalKeys[1];$fld2Dec=$decimalKeys[2];}function itemShow($row){global $numOfColumns,$totAmount,$totDebit,$totCredit;//echo "<pre>";print_r($row);echo "";exit;extract($row);$totAmount=$totAmount+$amount;$totDebit=$totDebit+$DEBIT;$totCredit=$totCredit+$CREDIT;echo "<tr>";for($x=0;$x<$numOfColumns;$x++){$var=$row[$x];if($var=="PURCHASING CARD"){$center="1280".$rcc;$pc="<a href='/budget/a/portal_ven_pay.php?dbTable=pcard&acct=$account&center=$center&amt=$row[5]' target='_blank'>ven</a>";}else{$pc="";}if($x==7){echo "<td align='right'>$var</td>";}else{echo "<td>$var $pc</td>";}}echo "</tr>";}function makeUpdateFields($fieldArray){global $updateFields;for($i=0;$i<count($fieldArray);$i++){if($i!=0){$updateFields.=",".$fieldArray[$i]."=$".$fieldArray[$i];}else{$updateFields.=$fieldArray[$i]."=$".$fieldArray[$i];}}// end for}// end makeUpdateFields?>