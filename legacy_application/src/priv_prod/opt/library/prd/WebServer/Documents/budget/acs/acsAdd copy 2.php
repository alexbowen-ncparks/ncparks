<?phpinclude("../../../include/connectBUDGET.inc");// database connection parameters//print_r($_SESSION);exit;//echo "<pre>";print_r($_REQUEST);echo "</pre>";//exit;foreach($_REQUEST as $k=>$v){if($v!="" and $k!="submit_acs"){$passQuery.=$k."=".urlencode($v)."&";}if($k=="num_invoice"){	if($v>1){$branch=$v;}	}}$passQuery=trim($passQuery,"&");//$passQuery.="m=invoices";//echo "$passQuery";exit;$level=$_SESSION['budget']['level']; function DateAdd($v,$d=null , $f="m/d/Y"){   $d=($d?$d:date("m/d/Y"));   return date($f,strtotime($v." days",strtotime($d)));  }  // Error checking if(strpos($comments,"refund")>-1 and $prefix!="43"){$e0=" [Prefix for ALL refunds must be 43.]<BR>";} if(!$ncas_invoice_number){$e1=" [Invoice number]<BR>";} if(!$ncas_invoice_date){$e2=" [Invoice date]<BR>";} if(!$ncas_invoice_amount){$e3=" [Invoice amount]<BR>";} if(!$ncas_number){$e4=" [NCAS account number]<BR>";}if($ncas_number){$sql = "SELECT DISTINCT ncas_account as OK_accountFROM `pa_approval_exceptions` WHERE 1";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");while($row=mysqli_fetch_array($result)){$approved_accounts[]=strtoupper($row['OK_account']);}$fullNC=$prefix.$ncas_number;if(in_array($fullNC,$approved_accounts)){	$approve=1;	}if($pa_re_number!=""){	$pare=explode("*",$pa_re_number);	$pa_number=$pare[1];	$re_number=$pare[2];	$approve=1;		}if($ncas_fund!="1280"){	$approve=1;	}	if(!$approve){	$e15="[Please select a valid PA number.]<BR>";	}$sql = "SELECT coaid FROM `coa` WHERE ncasNum ='$fullNC' and valid_div='y'";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$num=mysqli_num_rows($result);if($num<1){$e10="[Error Message: Not a Valid Account - $fullNC. Please re-check Account Number entered or Contact Tony P. Bass if Account Number is correct]<BR>";}	$sql = "SELECT distinct ncas_account FROM `energy` WHERE 1";	$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");		while($row=mysqli_fetch_assoc($result)){			$checkEnergy[]=$row['ncas_account'];			}		if(in_array($fullNC,$checkEnergy)){			if(!$energy OR !$energy_quantity){			$e14="[Error Message: When paying for any ENERGY related invoice, you must enter BOTH an Energy Type and an energy_quantity. Contact Tony P. Bass if you have a question.]<BR>";}			}}$ncas_invoice_date=str_replace("-", "/",$ncas_invoice_date);$splitDate=explode("/",$ncas_invoice_date);$splitMonth=$splitDate[0];$splitDay=$splitDate[1];$splitYear=$splitDate[2];if(!checkdate($splitMonth,$splitDay,$splitYear)){$e6=" <br> [Invoice date [$ncas_invoice_date] is NOT a valid date.]<BR>";}$t1=strtotime($ncas_invoice_date);$t2=strtotime(date("m/d/Y"));$t3=strtotime("1 January 2000"); if($t1>$t2){$e6=" <br> [Invoice date is greater than today's date.]<BR>";} if($t1<$t3){$e6=" <br> [Invoice date [$ncas_invoice_date] is incorrect.]<BR>";}//echo "1=$t1 2=$t2 3=$t3 6=$e6<br>m=$splitMonth d=$splitDay y=$splitYear"; exit;if(!$parkcode){$e7=" [Park code]<BR>";}if(!$project_number AND $ncas_fund!="1280" AND $ncas_fund!="1932" AND $ncas_fund!="2803" AND $ncas_fund!="1000"){$e8=" Fund $ncas_fund entered requires a project number. Please select PARTF Project Info button & select project number. Thanks<BR>";}$find="4";// force $find to be a string and not an integer$nn=strpos($ncas_number,$find);// value of 0 means first char = 4// echo "f=$find nn=$nn  ncas=$ncas_number p=$prefix fu=$ncas_fund";exit;if(!$er_num AND $nn===0 AND ($ncas_fund=="1280" OR $ncas_fund=="1932") AND $prefix=="53"){$e9="Your Equipment Item requires an Equipment Request Number. Please select the Approved Equipment List button & select an equipment request number. Thanks<BR>";} if($received_by=="" AND $received_byAlt==""){$e11=" [received_by]<BR>";}if($prepared_by=="" AND $prepared_byAlt==""){$e12=" [prepared_by]<BR>";}if($approved_by=="" AND $approved_byAlt==""){$e13=" [approved_by]<BR>";} if($e0.$e1.$e2.$e3.$e4.$e5.$e6.$e7.$e8.$e9.$e10.$e11.$e12.$e13.$e14.$e15){ $e="You failed to include or incorrectly entered a value for:<br /><font color='red'><b>$e0 $e1 $e2 $e3 $e4 $e5 $e6 $e7 $e8 $e9 $e10 $e11 $e12 $e13 $e14 $e15</b></font><br><br>Click this <a href='acs.php?$passQuery'>LINK</a> to correct the code sheet. You will not lose any previously entered values.";echo "$e"; exit;}  // FIELD NAMES are stored in $fieldArray// FIELD TYPES and SIZES are stored in $fieldType$sql = "SHOW COLUMNS FROM cid_vendor_invoice_payments";//echo "$sql";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$numFlds=mysqli_num_rows($result);while ($row=mysqli_fetch_assoc($result)){extract($row);if($row[Field]!="dateCreate" and $row[Field]!="ncas_center"){$fieldArray[]=$row[Field];}// remove dateCreat & ncas_center to prevent dupe entry-see line 132//$fieldType[]=$row[Type];}// ****** Any modifications to variables **********session_start();$level=$_SESSION['budget']['level'];$tempID=$_SESSION['budget']['tempID'];If($level==1){$parkcode=$_SESSION['budget']['select'];}$ncas_invoice_amount=str_replace(",","",$ncas_invoice_amount);$vendor_address=addslashes($vendor_address);$vendor_name=addslashes($vendor_name);//$ncas_remit_code=addslashes($ncas_remit_code);$pcard_holder=urldecode($pcard_holder);// necessary for O'Neal$pcard_sum=addslashes($pcard_sum);$pcard_just=addslashes($pcard_just);$comments=addslashes($comments);if($project_number!=""){$ncas_rcc="";}if($ncas_fund=="2803"){	$ncas_budget_code="24317";	$ncas_company="1612";	$ncas_rcc="";}$invoice_total=$ncas_invoice_amount+$ncas_freight;if($ncas_number=="4410"){$prefix="43";}$ncas_account=$prefix.$ncas_number;$dateSQL=date("Ymd",strtotime($ncas_invoice_date));$pcard_holder=str_replace("\n"," ",$pcard_holder);$pcard_holder=str_replace("\r"," ",$pcard_holder);if($pcard_holderAlt){$pcard_holderAlt=str_replace("\n"," ",$pcard_holderAlt);$pcard_holderAlt=str_replace("\r"," ",$pcard_holderAlt);$pcard_holder=$pcard_holderAlt;}$pcard_holder=addslashes(trim($pcard_holder));if($received_byAlt){$received_by=addslashes(trim($received_byAlt));}if($prepared_byAlt){$prepared_by=$prepared_byAlt;}if($approved_byAlt){$approved_by=$approved_byAlt;}$prepared_by=addslashes(trim($prepared_by));$approved_by=addslashes(trim($approved_by));$user_id=substr($tempID,0,-2);	if($energy){		$query = "SELECT upper(concat(energy_group,'-',energy_subgroup)) as concat_energy,cdcs_uom FROM energy where 1";		$result = mysqli_query($connection, $query);		while($row=mysqli_fetch_assoc($result)){				$cdcs[$row['concat_energy']]=$row['cdcs_uom'];				}						$en=explode("-",$energy);				}//ECHO "<PRE>";PRINT_R($cdcs);echo "</pre>";//exit;sort($fieldArray);//ECHO "<PRE>";PRINT_R($fieldArray);echo "</pre>";exit;$removeFld=array("CIA","caa","caa6","caa_count","charge_year","ciaa","ciaa_count","controller_approve","temp_match","temp_match2","posted","TAX_Hwy_Use_AMT","acct6","post2ncas");//print_r($fieldArray);exit;for($i=1;$i<count($fieldArray);$i++){	if(in_array($fieldArray[$i],$removeFld)){continue;}		if($fieldArray[$i]!="due_date" and $fieldArray[$i]!="id"){				$val=${$fieldArray[$i]};// force the variable		$multiArray[$fieldArray[$i]]=$val;		if($fieldArray[$i]=="energy_group"){$val=$en[0];}		if($fieldArray[$i]=="energy_subgroup"){$val=$en[1];}		if($fieldArray[$i]=="cdcs_uom"){				$indice=$en[0]."-".$en[1];				$val=$cdcs[$indice];}				if($fieldArray[$i]=="energy_quantity"){$val=str_replace(",","",$val);}		// textarea input doesn't need slashes		if($fieldArray[$i]!="comments" and $fieldArray[$i]!="vendor_name"){$val=addslashes($val);}		$val="'".$val."'";		if($i!=1) {$arraySet.=",".$fieldArray[$i]."=".$val;}else{$arraySet.=$fieldArray[$i]."=".$val;}		}		}if($submit_acs=="Submit"){if(!$due_date||$due_date=="will be calculated"){$due_date=",due_date='".DateAdd(14,$ncas_invoice_date)."-".$parkcode."'";}else{$due_date=",due_date='".$due_date."'";} if($branch>1){include("acs_multi.php");exit;}  $query = "INSERT into cid_vendor_invoice_payments SET $arraySet $due_date,ncas_center=concat(ncas_fund,ncas_rcc)";//echo "insert $query"; exit;$result = mysqli_query($connection, $query) or die ("Couldn't execute query. $query");$id=mysql_insert_id();/*if($check_num!=''){$query = "UPDATE cid_vendor_invoice_payments SET posted='x' where id='$id'";$result = mysqli_query($connection, $query) or die ("Couldn't execute query. $query");}*/}if($submit_acs=="Update"){$query = "UPDATE cid_vendor_invoice_payments SET $arraySet,due_date='$due_date',system_entry_date=system_entry_date, post2ncas=post2ncas,ncas_center=concat(ncas_fund,ncas_rcc) where id='$id'";//echo "update $query";exit;$result = mysqli_query($connection, $query) or die ("Couldn't execute query. $query");/*if($check_num!=''){$query = "UPDATE cid_vendor_invoice_payments SET posted='x',due_date='$due_date',system_entry_date=system_entry_date, post2ncas=post2ncas where id='$id'";$result = mysqli_query($connection, $query) or die ("Couldn't execute query. $query");}*/}header("Location: /budget/acs/acs.php?id=$id&num_invoice=$branch");?>