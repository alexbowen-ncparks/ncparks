<?php$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/iConnect.inc"); // connection parametersmysqli_select_db($connection, $database); // databaseinclude("../../../include/authBUDGET.inc");extract($_REQUEST);//print_r($_REQUEST);EXIT;// Get most recent date from Exp_Rev$sql="SELECT DATE_FORMAT(max(acctdate),'Report Date: %c/%e/%y') as maxDate FROM `exp_rev` WHERE 1";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 0. $sql");$row=mysqli_fetch_array($result);extract($row);if($rep=="excel"){header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment; filename=Budget_Total.xls');}// ********** Level > 2 *****************if($_SESSION[budget][level]>2){$sql="SELECT  DISTINCT section FROM  `center`";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 1. $sql");while ($row=mysqli_fetch_array($result)){extract($row);$sectArray1[]="sect-x-".$section;//$sectArray2[]=$section."-NCAS#";$sectArray3[]="sect-y-".$section;$sectArray4[]=$section."-PARK";}if($rep==""){include_once("../menu.php");echo "<table><form action=\"budget_total.php\">";$array1=array("east","north","south","west","div");$array2=array("EADI-PARK","NODI-PARK","SODI-PARK","WEDI-PARK","Budget-operating expenses total-Division");$menuArray1=array_merge($array1,$sectArray1);$menuArray1=array_merge($menuArray1,$sectArray3);$menuArray2=array_merge($array2,$sectArray2);$menuArray2=array_merge($menuArray2,$sectArray4);// Menu 1echo "<td>Scope: <select name=\"scopeMenu\"><option selected></option>";$s="value";for ($n=0;$n<count($menuArray2);$n++){$con=$menuArray1[$n];		echo "<option $s='$con'>$menuArray2[$n]\n";       }   echo "</select></td>";// Menu 2$sql="SELECT section,parkcode,center as varCenter from center where fund='1280' order by section,parkcode,center";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 1. $sql");while ($row=mysqli_fetch_array($result)){extract($row);$pc[]=$parkcode;$c[]=$varCenter;$sec[]=$section;}echo "<td><select name=\"center\"><option selected>Select Center</option>";$s="value";for ($n=0;$n<count($c);$n++){$con=$c[$n];		echo "<option $s='$con'>$sec[$n]-$pc[$n]-$c[$n]\n";       }   echo "</select><input type='submit' name='submit' value='Submit'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type='checkbox' name='showSQL' value='1'>Show SQL</form></td></tr></table>";}// *********** Set Scopelist($dist_sect,$orderByToggle)=explode("-",$scopeMenu);if($dist_sect!="sect"){$limitWhere=" AND center.section='operations'";}if($dist_sect=="div"){$limitWhere="";}else{$orderBy="ORDER BY center.parkcode";}if($scopeMenu){list($dist_sect,$orderByToggle,$sect)=explode("-",$scopeMenu);if($dist_sect=="sect"){$whichCenter="AND center.section='$sect'";}else{$whichCenter="AND center.dist='$dist_sect'";}if($dist_sect=="div"){$whichCenter="";}}else{$whichCenter="AND center.center='$center'";}if($center==""){exit;}}// end Level > 2// ************* Level 2 *****************if($_SESSION[budget][level] == 2){//print_r($_REQUEST);EXIT;if($rep==""){include_once("../menu.php");include_once("../../../include/parkRCC.inc");$distCode=$_SESSION[budget][select];echo "<table><form action=\"budget_total.php\">";switch($distCode){case "EADI":$distCode="east";break;case "NODI":$distCode="north";break;case "SODI":$distCode="south";break;case "WEDI":$distCode="west";break;}//$D=$distCode."-NCAS";$DP=$distCode."-PARK";$array1=array($DP);// Menu 1echo "<td>Scope: <select name=\"scopeMenu\"><option selected></option>";$s="value";for ($n=0;$n<count($array1);$n++){$con=$array1[$n];		echo "<option $s='$con'>$array1[$n]\n";       }   echo "</select></td>";   $parkList=$_SESSION[budget][select];$da=${"array".$parkList}; //print_r($da);exit;while (list($key,$val)=each($da)){$parkList=$parkList.",".$val;}$where="where FIND_IN_SET(center.parkCode,'$parkList')>''";// Menu 2$sql="SELECT section,parkcode,center as varCenter from center $where order by section,parkcode,center";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 1. $sql");while ($row=mysqli_fetch_array($result)){extract($row);$pc[]=$parkcode;$c[]=$varCenter;$sec[]=$section;}echo "<td><select name=\"center\"><option selected>Select Center</option>";$s="value";for ($n=0;$n<count($c);$n++){$con=$c[$n];		echo "<option $s='$con'>$sec[$n]-$pc[$n]-$c[$n]\n";       }   echo "</select>   <input type='hidden' name='distCodeCheck' value='$distCode'>   <input type='submit' name='submit' value='Submit'>   </form></td></tr></table>";}// *********** Set Scopelist($dist_sect,$orderByToggle)=explode("-",$scopeMenu);if($orderByToggle=="NCAS"){$GroupByToggle="x";$orderBy="ORDER BY oxt3.ncasnum,center.dist,center.parkcode";if($dist_sect!="sect"){$limitWhere=" AND center.section='operations'";}}else{$orderBy="ORDER BY center.parkcode";}if($scopeMenu){list($dist_sect,$orderByToggle,$sect)=explode("-",$scopeMenu);if($dist_sect=="sect"){$whichCenter="AND center.section='$sect'";}else{$whichCenter="AND center.dist='$dist_sect'";}}else{$whichCenter="AND center.center='$center'";}if($center==""){exit;}}// *********** Level 1 ************if($_SESSION[budget][level]==1){include_once("../menu.php");include_once("../../../include/parkcountyRCC.inc");include_once("subDist.php");}// end Level = 1// *********** Check Level **************if($_SESSION[budget][level]==2){list($dist_sect,$orderByToggle)=explode("-",$scopeMenu);switch($dist_sect){case "east":$distCode="EADI";break;case "north":$distCode="NODI";break;case "south":$distCode="SODI";break;case "west":$distCode="WEDI";break;}if($_SESSION[budget][select]!=$distCode AND $distCode!=$distCodeCheck){echo "$distCodeAccess denied";exit;}}$sql = "SELECT center.section, center.dist, center.parkcode, oxt3.center, sum( spent0203 )  AS  'spent0203', sum( spent0304 )  AS  'spent0304', sum( spent0405 )  AS  'spent0405', sum( ware0405 )  AS  'ware0405', sum( spent0405 + ware0405 )  AS  'total_spent0405', sum( parkinc0506 + distinc0506 - ware0405 )  AS  'inc0506', round( ( ( sum( parkinc0506 + distinc0506 - ware0405 )  / sum( spent0405 + ware0405 +  '.01'  )  )  ) *100 ) AS  'inc0506_perc', sum( spent0405 + parkinc0506 + distinc0506 )  AS  'request_0506', sum( spent0506 )  AS  'spent0506', sum( ware0506 )  AS  'ware0506', sum( spent0506 + ware0506 )  AS  'total_spent0506', sum( spent0405 + parkinc0506 + distinc0506 - spent0506 - ware0506 )  AS  'available'FROM  `oxt3`LEFT  JOIN coa ON oxt3.ncasnum = coa.ncasnumLEFT  JOIN center ON oxt3.center = center.centerWHERE 1  AND coa.track_rcc =  'y' AND oxt3.ncasnum NOTLIKE  '534%' $whichCenter $limitWhereGROUP  BY oxt3.centerORDER  BY center.section, center.dist, center.parkcode";if($showSQL=="1"){echo "$sql<br>";//exit;}$varQuery=$_SERVER[QUERY_STRING];if($rep==""){$flip=array_flip($menuArray1);$scopeKey=$flip[$scopeMenu];$title=$menuArray2[$scopeKey]." ".$maxDate;echo "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href='budget_total.php?$varQuery&rep=excel&title=$title'>Excel Export</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$menuArray2[$scopeKey]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $maxDate<br>";echo "<table border='1'><tr><th>SECTION</th><th>DIST</th><th>PARK</th><th>CENTER</th><th>Spent 0203</th><th>Spent 0304</th><th>Spent 0405</th><th>WARE 0405</th><th>Tot Spent<br>0405</th><th>Increase<br>Decrease</th><th>Percent<br>Inc_Dec</th><th>0506 Req</th><th>0506 Spent</th><th>WARE 0506</th><th>0506 Tot Spent</th><th>Available</th></tr>";}else{echo "<table border='1'><tr><th colspan='8'>$title</th></tr><tr><th>SECTION</th><th>DIST</th><th>PARK</th><th>CENTER</th><th>Spent 0203</th><th>Spent 0304</th><th>Spent 0405</th><th>WARE 0405</th><th>Tot Spent 0405</th><th>Increase Decrease</th><th>Percent Inc_Dec</th><th>0506 Req</th><th>0506 Spent</th><th>WARE 0506</th><th>0506 Tot Spent</th><th>Available</th></tr>";}if($orderByToggle=="x"){$checkField="ncasnum";}else{$checkField="parkcode";}$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");//$num=mysqli_num_rows($result);while($row=mysqli_fetch_array($result)){extract($row);// Track Totals$spent0203tot=$spent0203tot+$spent0203;// 1$spent0304tot=$spent0304tot+$spent0304;//2$spent0405tot=$spent0405tot+$spent0405;//3$ware0405tot=$ware0405tot+$ware0405;//4$total_spent0405tot=$total_spent0405tot+$total_spent0405;//5$inc0506tot=$inc0506tot+$inc0506;//6//$inc0506_perctot=$inc0506_perctot+$inc0506_perc;//6a$request_0506tot=$request_0506tot+$request_0506;//7$spent0506tot=$spent0506tot+$spent0506;//8$ware0506tot=$ware0506tot+$ware0506;//9$total_spent0506tot=$total_spent0506tot+$total_spent0506;//10$availabletot=$availabletot+$available;//11// Format for display$spent0203F=number_format($spent0203,2);$spent0304F=number_format($spent0304,2);$spent0405F=number_format($spent0405,2);$ware0405F=number_format($ware0405,2);$total_spent0405F=number_format($total_spent0405,2);$inc0506F=number_format($inc0506,2);if($inc0506_perc==0){$inc0506_percF="-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";}else{$countPerCent++;$inc0506_percF=number_format($inc0506_perc,0)."%";}$request_0506F=number_format($request_0506,2);$spent0506F=number_format($spent0506,2);$ware0506F=number_format($ware0506,2);$total_spent0506F=number_format($total_spent0506,2);$availableF=number_format($available,2);$section=strtolower($section);echo "<tr><td align='right'>$section</td><td align='center'>$dist</td><td align='center'>$parkcode</td><td align='right'>$center</td><td align='right'>$spent0203F</td><td align='right'>$spent0304F</td><td align='right'>$spent0405F</td><td align='right'>$ware0405F</td><td align='right'>$total_spent0405F</td><td align='right'>$inc0506F</td><td align='right'>$inc0506_percF</td><td align='right'>$request_0506F</td><td align='right'>$total_spent0506</td><td align='right'>$ware0506F</td><td align='right'>$total_spent0506F</td><td align='right'>$availableF</td></tr>";// Track SubTotals// $subx is used to hold value for last subTotal$subspent0203tot=$subspent0203tot+$spent0203;$sub1=number_format($subspent0203tot,2);$subspent0304tot=$subspent0304tot+$spent0304;$sub2=number_format($subspent0304tot,2);$subspent0405tot=$subspent0405tot+$spent0405;$sub3=number_format($subspent0405tot,2);$subware0405tot=$subware0405tot+$ware0405;$sub4=number_format($subware0405tot,2);$subnonware_incdectot=$subnonware_incdectot+$total_spent0405;$sub5=number_format($subnonware_incdectot,2);$subinc_dectot=$subinc_dectot+$inc0506;$sub6=number_format($subinc_dectot,2);//$subinc0506_perctot=$subinc0506_perctot+$inc0506_perc;//$sub6a=number_format($subinc0506_perctot,2);$subrequest_0506tot=$subrequest_0506tot+$request_0506;$sub7=number_format($subrequest_0506tot,2);$subspent0506tot=$subspent0506tot+$spent0506;$sub8=number_format($subspent0506tot,2);$subware0506tot=$subware0506tot+$ware0506;$sub9=number_format($subware0506tot,2);$subtotal_spent0506=$subtotal_spent0506+$total_spent0506;$sub10=number_format($subtotal_spent0506,2);$subRemainingtot=$subRemainingtot+$available;$sub11=number_format($subRemainingtot,2);$check=$$checkField;	}// end while// Format and Display Totals$spent0203totF=number_format($spent0203tot,2);$spent0304totF=number_format($spent0304tot,2);$spent0405totF=number_format($spent0405tot,2);$ware0405totF=number_format($ware0405tot,2);$total_spent0405totF=number_format($total_spent0405tot,2);$inc0506totF=number_format($inc0506tot,2);//$inc0506_perctotF=number_format($inc0506_perctot,2);$request_0506totF=number_format($request_0506tot,2);$spent0506totF=number_format($spent0506tot,2);$ware0506totF=number_format($ware0506tot,2);$total_spent0506totF=number_format($total_spent0506tot,2);$availabletotF=number_format($availabletot,2);// Print Grand Totals$subspent0203grandF=number_format($subspent0203grand+$subspent0203tot,2);$subspent0304grandF=number_format($subspent0304grand+$subspent0304tot,2);$subspent0405grandF=number_format($subspent0405grand+$subspent0405tot,2);$subware0405grandF=number_format($subware0405grand+$subware0405tot,2);$subnonware_incdecgrandF=number_format($subnonware_incdecgrand+$subnonware_incdectot,2);$subinc_decgrandF=number_format($subinc_decgrand+$subinc_dectot,2);//$subinc0506_percgrandF=number_format($subinc0506_percgrand+$subinc0506_perctot,2);$subrequest_0506grandF=number_format($subrequest_0506grand+$subrequest_0506tot,2);$subspent0506grandF=number_format($subspent0506grand+$subspent0506tot,2);$subware0506grandF=number_format($subware0506grand+$subware0506tot,2);$subtotal_spent0506grandF=number_format($subtotal_spent0506grand+$subtotal_spent0506,2);$subrequest_0506grandF=number_format($subrequest_0506grand+$subrequest_0506tot,2);$subRemaininggrandF=number_format($subRemaininggrand+$subRemainingtot,2);echo "<tr><td align='right' colspan='5'>Grand Total: <b>$spent0203totF</b></td><td align='right'><b>$spent0304totF</b></td><td align='right'><b>$spent0405totF</b></td><td align='right'><b>$ware0405totF</b></td><td align='right'><b>$total_spent0405totF</b></td><td align='right'><b>$inc0506totF</b></td><td align='right'><b>$inc0506_perctotF</b></td><td align='right'><b>$request_0506totF</b></td><td align='right'><b>$spent0506totF</b></td><td align='right'><b>$ware0506totF</b></td><td align='right'><b>$total_spent0506totF</b></td><td align='right'><b>$availabletotF</b></td></tr>";echo "</table></body></html>";?>