<?php$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/connectROOT.inc"); // connection parametersmysql_select_db($database, $connection); // databaseinclude("../../../include/authBUDGET.inc");extract($_REQUEST);$level=$_SESSION['budget']['level'];$thisUser=$_SESSION['budget']['tempID'];if($level<2 AND !$center){$pay_center=$_SESSION['budget']['centerSess'];$center=$pay_center;}//echo "<pre>";print_r($_REQUEST);print_r($_SESSION);echo "</pre>";//exit;if($del!=""){$sql="DELETE from purchase_request_3 where pa_number='$del' and division_approved !='y'";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");$sql="OPTIMIZE  TABLE  `purchase_request_3`";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");}if($submit=="Update"){//echo "<pre>"; print_r($_POST); echo "</pre>"; exit;if($edit){	$dateSQL=date("Y-m-d",strtotime($purchase_date));if($_POST['purchase_type']=="emergency"){	if($_POST['purchase_date']<$dateSQL){	$pd=$_POST['purchase_date'];		echo "When making an emergency purchase, you MUST specify a 'purchase date' AFTER today. Please click you browser's BACK button and resubmit.  $pd $dateSQL"; exit;}	}		foreach($_POST as $k=>$v){			if($k!="submit" AND $k!="edit"){				$clause.=$k."='".$v."', ";				}				}			$clause=trim($clause,", ");		$sql="UPDATE purchase_request_3 set $clause where pa_number='$edit'"; 		$result = mysql_query($sql) or die ("Couldn't execute query. $sql");			//echo "$sql";exit;		header("Location: park_purchase_request_view.php?view=all&report_date=$report_date&submit=Submit");		}$ignoreKey=array("report_date","purchase_description","requested_amount","purchase_type","purchase_date","justification","edit","submit");foreach($_POST as $k=>$v){	if(!in_array($k,$ignoreKey)){$fldArray[]=$k;}	}//	echo "<pre>"; print_r($fldArray); echo "</pre>";  //exit;$pa_numberArray=array_keys($_POST[$fldArray[0]]);//echo "<pre>"; print_r($pa_numberArray); echo "</pre>"; // exit;foreach($pa_numberArray as $k=>$v){$dc="UPDATE purchase_request_3 set ";	foreach($fldArray as $key=>$value){		$fld=mysql_real_escape_string($_POST[$value][$v]);		$dc.=" $value='$fld', ";			}// end fldArray			$dc=trim($dc,", ");		$sql="$dc where pa_number='$v'";//	echo "$sql<br>";			$result = mysql_query($sql) or die ("Couldn't execute query UPDATE. $sql");}// end pa_numberArray	//	exit;		$rd=$_POST['report_date']; //echo "r=$rd";exit;		header("Location: park_purchase_request_view.php?view=all&report_date=$rd&submit=Submit");}// end submit// Construct Query to be passed to Excel Exportforeach($_REQUEST as $k => $v){if($v and $k!="PHPSESSID" and $k!="del"){$varQuery.=$k."=".$v."&";}}$passQuery=$varQuery;   $varQuery.="rep=excel";    if($rep=="excel"){header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment; filename=park_purchase_request.xls');}// Get f_yearinclude("../~f_year.php");if($rep==""){			include_once("../menu.php");			include_once("park_purchase_request_menu.php");if($level==2){switch ($_SESSION['budget']['select']) {		case "SODI":			$w="and district='south'";			$pu="and (district='south')";$distCode="south";			break;			case "NODI":			$w="and district='north'";			$pu="and (district='north')";$distCode="north";			break;			case "EADI":			$w="and district='east'";			$pu="and (district='east')";$distCode="east";			break;			case "WEDI":			$w="and district='west'";			$pu="and (district='west')";$distCode="west";			break;		}// end switch	$D=$distCode."-NCAS";$DP=$distCode."-PARK";$array1=array($D,$DP);$where=" and section='operations'";/*if($rep==""){$sql="SELECT section,parkcode,center as varCenter from center $where order by section,parkcode,center";$result = mysql_query($sql) or die ("Couldn't execute query 1. $sql");while ($row=mysql_fetch_array($result)){extract($row);$pc[]=$parkcode;$c[]=$varCenter;$sec[]=$section;}echo "<table align='center'><form><tr>";echo "<td><select name=\"center\"><option selected>Select Center</option>";for ($n=0;$n<count($c);$n++){$con=$c[$n];if($center==$con){$s="selected";}else{$s="value";}		echo "<option $s='$con'>$sec[$n]-$pc[$n]-$c[$n]\n";       }   echo "</select> <input type='submit' name='submit' value='Submit'></td></form></tr></table>";}   */}// end level=2}//if($showSQL==1){$p="method='POST'";}if($submit!="Submit"){exit;}// ********* Body Queries ***************$today=date("Y-m-d");$sql="Select start_date,end_date from budget_request_acceptable_dates where budget_group='equipment' order by budget_group";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");$row=mysql_fetch_array($result);extract($row);if($today>=$start_date and $today<=$end_date){}else{$menuList=1;}$pay_center=$_SESSION['budget']['centerSess'];if($center){$pay_center=$center;}// overrideif($level==1 AND $view=="approved"){$where=" and pay_center='$pay_center' and division_approved='y'";}if($level==1 AND $view=="pending"){$where=" and pay_center='$pay_center' and district_approved != 'n' and section_approved != 'n' and division_approved='u'";}if($level==1 AND $view=="denied"){$where=" and pay_center='$pay_center' and (district_approved = 'n' or section_approved = 'n' or division_approved ='n')";}if($level==1 AND $view=="all"){$where=" and pay_center='$pay_center'";}if($level>2){		if($district){$where=" and district='$district'";}		if($section){$where.=" and section='$section'";}				}if($level==2 AND $view=="approved"){$where.=" $w and division_approved='y'";}if($level==2 AND $view=="pending"){$where.=" $w and district_approved != 'n' and section_approved != 'n' and division_approved='u'";}if($level==2 AND $view=="denied"){$where.=" $w and (district_approved = 'n' or section_approved = 'n' or division_approved ='n')";}if($level==2 AND $view=="all"){$where.=" $w";}if(($level==3 || $level==4) AND $view=="approved"){$where.=" and section='$section' and division_approved='y'";}if(($level==3 || $level==4) AND $view=="pending"){$where.=" and section='$section' and district_approved != 'n' and section_approved != 'n' and division_approved='u'";}if(($level==3 || $level==4) AND $view=="denied"){$where.=" and section='$section' and (district_approved = 'n' or section_approved = 'n' or division_approved ='n')";}if(($level==3 || $level==4) AND $view=="all"){$where.=" and section='$section'";}if(($level>4) AND $view=="approved"){$where.=" and division_approved='y'";}if(($level>4) AND $view=="pending"){$where.=" and district_approved != 'n' and section_approved != 'n' and division_approved='u'";}if(($level>4) AND $view=="denied"){$where.=" and (district_approved = 'n' or section_approved = 'n' or division_approved ='n')";}if(($level>4) AND $view=="all"){$where.="";}if($level==1 and $edit!=""){	$center=$_SESSION['budget']['centerSess'];	$where.=" and pay_center='$center'";}/*select query for center budgets*/$sql="selectpa_number,section,district,center_code,pay_center,user_id,system_entry_date,purchase_description,sum(unit_quantity*unit_cost) as 'requested_amount',purchase_type,purchase_date,justification,district_approved,disu_comments,section_approved,division_approved,bo_commentsfrom purchase_request_3where 1$whereand report_date='$report_date'group by pa_numberorder by section,district,center_code";if($level>4 and $rep==""){echo "$sql<br>";}//exit;//if($showSQL=="1"){//echo "$sql<br>";//}$headerArray=array("pa_number","section","district","center_code","pay_center","user_id","system_entry_date","purchase_description","requested_amount","purchase_type","purchase_date","justification","district_approved","disu_comments","section_approved","division_approved","bo_comments");//,"status","pasu_priority","disu_priority","pasu_ranking"//"funding_source","category",$count=count($headerArray);for($i=0;$i<$count;$i++){$h=$headerArray[$i];if($h=="division_approved"){$h=str_replace("_","&nbsp;",$h);}$header.="<th>".$h."</th>";}$header=str_replace("_"," ",$header);$result = mysql_query($sql) or die ("Couldn't execute query. $sql");$num=mysql_num_rows($result);while($row=mysql_fetch_array($result)){$b[]=$row;}// end while//echo "<pre>";print_r($b);echo "</pre>";exit;$view1=strtoupper($view);echo "<html><form method='POST'><table border='1'>";if($rep==""){echo "<tr bgcolor='lightgray'><th colspan='6'><font color='red'>$view1 Requests = $num</font> for Report Date: $report_date</th><td colspan='2'> Excel <a href='park_purchase_request_view.php?$varQuery'>Export</a></td></tr>";}else{echo "<tr><th colspan='6'><font color='red'>$view1 Requests = $num</font> for Report Date: $report_date</th></tr><tr>$header</tr>";}// *************** Non-excel *************$editFlds=array("purchase_description","requested_amount","purchase_date","justification");$x=2;$yy=10;	for($i=0;$i<count($b);$i++){	$r=fmod($i,$x);if($r==0){$bc=" bgcolor='aliceblue'";}else{$bc="";}	if(fmod($i,$yy)==0 and $rep==""){echo "<tr>$header</tr>";}echo "<tr$bc>";	for($j=0;$j<count($headerArray);$j++){	$var=$b[$i][$headerArray[$j]];		$passPA_number=$b[$i]['pa_number'];	$fieldName=$headerArray[$j];$f1="<font color='red'>";$f2="</font>";	$checkDist=$b[$i]['district_approved'];	$checkSect=$b[$i]['section_approved'];	$checkDiv=$b[$i]['division_approved'];	if($fieldName=="pa_number" and $checkDist=="u" and $checkSect=="u" and $checkDiv=="u")	{$var="<a href='park_purchase_request_view.php?center=$center&report_date=$report_date&edit=$var&submit=Submit'>$var</a> <a href='park_purchase_request_view.php?center=$center&del=$passPA_number&report_date=$report_date&edit=$var&submit=Submit' onClick='return confirmLink()'><img src='button_drop.png'></a>";}		if($fieldName=="pa_number" and $rep!=""){$var=$b[$i][$headerArray[$j]];}	if($edit==$passPA_number and $checkDist=="u" and $checkSect=="u" and $checkDiv=="u"){		if(in_array($fieldName,$editFlds)){		$var="<input type='text' name='$fieldName' value='$var'>";}		}				if($level==2){		if($fieldName=="district_approved")		{$ckU="";$ckY="";$ckN="";		if($var=="u"){$ckU="checked";}		if($var=="n"){$ckN="checked";}		if($var=="y"){$ckY="checked";}		$var="		Y<input type='radio' name='district_approved[$passPA_number]' value='y'$ckY>		$f1 N$f2<input type='radio' name='district_approved[$passPA_number]' value='n'$ckN>		U<input type='radio' name='district_approved[$passPA_number]' value='u'$ckU>		";		if($rep!=""){$var=$b[$i][$headerArray[$j]];}		}		if($fieldName=="disu_comments")		{		$var="<textarea name='disu_comments[$passPA_number]' cols='15' rows='3'>$var</textarea>";		}	} // >level1		if($level==3 || $level==4){		if($fieldName=="section_approved")		{$ckU="";$ckY="";$ckN="";		if($var=="u"){$ckU="checked";}		if($var=="n"){$ckN="checked";}		if($var=="y"){$ckY="checked";}		$var="		Y<input type='radio' name='section_approved[$passPA_number]' value='y'$ckY>		$f1 N$f2<input type='radio' name='section_approved[$passPA_number]' value='n'$ckN>		U<input type='radio' name='section_approved[$passPA_number]' value='u'$ckU>		";				if($rep!=""){$var=$b[$i][$headerArray[$j]];}		}	}		if($level>4){		if($fieldName=="division_approved")		{$ckU="";$ckY="";$ckN="";		if($var=="u"){$ckU="checked";}		if($var=="n"){$ckN="checked";}		if($var=="y"){$ckY="checked";}		$var="		Y<input type='radio' name='division_approved[$passPA_number]' value='y'$ckY>		$f1 N$f2<input type='radio' name='division_approved[$passPA_number]' value='n'$ckN>		U<input type='radio' name='division_approved[$passPA_number]' value='u'$ckU>		";				if($rep!=""){$var=$b[$i][$headerArray[$j]];}		}		if($fieldName=="bo_comments")		{		$var="<textarea name='bo_comments[$passPA_number]' cols='15' rows='3'>$var</textarea>";				if($rep!=""){$var=$b[$i][$headerArray[$j]];}		}	} // >level4	if($fieldName=="requested_amount"){	$total+=$var;	$al=" align='right'";}else{$al="";}	if($edit==$passPA_number AND $headerArray[$j]=="purchase_type"){$passVar=$var;	$menuArray=array("non-emergency","emergency");	$var="<select name='$headerArray[$j]'>";	foreach($menuArray as $k=>$v){		if($passVar==$v){$s="selected";}else{$s="value";}		$var.="<option $s='$v'>$v</option>\n";}	$var.="</select>";}echo "<td$al>$var</td>";			}	echo "</tr>";	}//}$total=number_format($total,2);echo "<tr><td colspan='9' align='right'>$total</td></tr>";if($rep==""){echo "<tr><td colspan='14' align='right'>";if($edit){echo "<input type='hidden' name='edit' value='$edit'>";}echo "<input type='hidden' name='report_date' value='$report_date'><input type='submit' name='submit' value='Update'></td></tr>";}echo "</table></form></html>";?>