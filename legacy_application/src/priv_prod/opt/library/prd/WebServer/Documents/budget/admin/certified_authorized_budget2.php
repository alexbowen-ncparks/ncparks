<?php$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/iConnect.inc"); // connection parametersmysqli_select_db($connection, $database); // databaseinclude("../../../include/authBUDGET.inc");include("../../../include/activity.php");extract($_REQUEST);//echo "<pre>"; print_r($_SESSION); echo "</pre>"; // exit;include("../~f_year.php");$level=$_SESSION['budget']['level'];// Construct Query to be passed to Excel Exportforeach($_REQUEST as $k => $v){if($v and $k!="PHPSESSID"){$varQuery.=$k."=".$v."&";}}$passQuery=$varQuery;   $varQuery.="rep=excel";    if($rep=="excel"){header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment; filename=certified_authorized_budget.xls');}$sql="select distinct account_group from coawhere cash_type='disburse'order by cash_type;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 1. $sql");while ($row=mysqli_fetch_array($result)){$bg[]=$row['account_group'];}if($rep==""){echo "<table align='center'><form><tr>";echo "<td>Select Account Group: <select name=\"account_group\"><option selected></option>";for ($n=0;$n<count($bg);$n++){$con=$bg[$n];if($account_group==$con){$s="selected";}else{$s="value";}		echo "<option $s='$con'>$con\n";       }$sqlpc="select percent_change from budget_request_cab_changes where account_group='$account_group'";$resultpc = mysqli_query($connection, $sqlpc) or die ("Couldn't execute query 1. $sqlpc");$row=mysqli_fetch_array($resultpc);extract($row);	      echo "</select>  percent_change: <input type='text' name='perecent_change' value='$percent_change'> <input type='submit' name='submit' value='Submit'></td></form></tr>";}if($submit==""){exit;}include("../~f_year.php");//echo $f_year;exit;$sql="truncate table budget_request22;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br>";}$sql="insert into budget_request22(ncas_num,center,authorized,amount_py3,amount_py2,amount_py1,amount_cy,approved_changes,unapproved_requests,reversions) select account,fund,sum(authorized),'','','','','','','' from authorized_budget where 1 and f_year='$f_year' group by account,fund;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br>";}$sql="insert into budget_request22(ncas_num,center,authorized,amount_py3,amount_py2,amount_py1,amount_cy,approved_changes,unapproved_requests,reversions) select account,fund,'','','','','','','',sum(reversions) from reversions where 1 and f_year='$f_year' group by account,fund;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br>";}$sql="insert into budget_request22(ncas_num,center,authorized,amount_py3,amount_py2,amount_py1,amount_cy,approved_changes,unapproved_requests,reversions) select ncasnum,center,'',sum(amount_py3),sum(amount_py2),sum(amount_py1),sum(amount_cy),'' ,'','' from act3 where 1 group by ncasnum,center;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br>";}$sql="insert into budget_request22(ncas_num,center,authorized,amount_py3,amount_py2,amount_py1,amount_cy,approved_changes,unapproved_requests,reversions) select ncas_acct,center, '', '', '', '', '', sum(allocation_amount), '','' from budget_center_allocations where 1 and fy_req='$f_year' group by ncas_acct,center;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br>";}$sql="insert into budget_request22(ncas_num,center,authorized,amount_py3,amount_py2,amount_py1,amount_cy,approved_changes,unapproved_requests,reversions) select ncas_number,center,'','','','','','',sum(allocation_amount),'' from manual_allocations_3 where 1 and approved='n' and f_year='$f_year' group by ncas_number,center;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br>";}$sql="update budget_request22,coa set budget_request22.cash_type=coa.cash_type where budget_request22.ncas_num=coa.ncasnum;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br>";}$sql="update budget_request22,coa set budget_request22.account_group=coa.account_group where budget_request22.ncas_num=coa.ncasnum;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br>";}// ********* budget_request33$sql="truncate table budget_request33;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br>";}$sql="insert into budget_request33(ncas_num,center,authorized,amount_py3,amount_py2,amount_py1,amount_cy,approved_changes,unapproved_requests,reversions) select ncas_num,center,sum(authorized),sum(amount_py3),sum(amount_py2),sum(amount_py1),sum(amount_cy),sum(approved_changes),sum(unapproved_requests),sum(reversions) from budget_request22 where 1 and cash_type='disburse' group by ncas_num,center;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br>";}$sql="insert into budget_request33(ncas_num,center,authorized,amount_py3,amount_py2,amount_py1,amount_cy,approved_changes,unapproved_requests,reversions) select ncas_num,center,sum(authorized),-sum(amount_py3),-sum(amount_py2),-sum(amount_py1),-sum(amount_cy),sum(approved_changes),-sum(unapproved_requests),sum(reversions) from budget_request22 where 1 and cash_type='receipt' group by ncas_num,center;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br>";}$sql="update budget_request33,coa set budget_request33.account_group=coa.account_group where budget_request33.ncas_num=coa.ncasnum;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br>";}$sql="update budget_request33,coa set budget_request33.cash_type=coa.cash_type where budget_request33.ncas_num=coa.ncasnum;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br>";}// **** budget_request44$sql="truncate table budget_request44;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br>";}$sql="insert into budget_request44 (ncas_num,center,authorized,amount_py3,amount_py2,amount_py1,amount_cy,approved_changes,unapproved_requests,reversions,encumbrances,account_group)selectncas_num,center,sum(authorized),sum(amount_py3),sum(amount_py2),sum(amount_py1),sum(amount_cy),sum(approved_changes),sum(unapproved_requests),sum(reversions),'',account_groupfrom budget_request33where 1and center like '1280%'group by ncas_num;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br>";}$sql="insert into budget_request44 (ncas_num,center,authorized,amount_py3,amount_py2,amount_py1,amount_cy,approved_changes,unapproved_requests,reversions,encumbrances)selectacct,center,'','','','','','','','',sum(po_remaining_encumbrance)from xtnd_po_encumbranceswhere 1and center like '1280%'group by acct;";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");if($showSQL=="1"){echo "$sql<br>";}echo "<table border='1'>";if($rep==""){echo "<tr><td colspan='9'>";echo "<a href='certified_authorized_budget.php?$varQuery&rep=excel'>Excel Export</a>";//echo "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Report Date: <font color='red'>$today</font>&nbsp;&nbsp;&nbsp; $t</td></tr>";}// ***** Final Select $WHERE="where 1";if($account_group){$WHERE.= " and coa.account_group='$account_group'";}//if($ncas_account){$WHERE.=" and budget_request44.ncas_num like '$ncas_account%'";}$sql="select ncas_num as 'ncas_account',coa.park_acct_desc as 'account_description',budget_request44.account_group,sum(authorized) as 'cy_authorized',sum(authorized*$percent_change/100) as 'reversions',sum(authorized)+sum(authorized*$percent_change/100) as 'ny_authorized',sum(amount_py1) as 'last_year',sum(authorized)+sum(authorized*$percent_change/100)-sum(amount_py1) as 'next_versus_last'from budget_request44left join coa on budget_request44.ncas_num=coa.ncasnum$WHEREand coa.cash_type='disburse'group by ncas_numorder by ncas_num;";if($showSQL=="1"){echo "$sql<br>";}//echo "$sql<br>";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$num=mysqli_num_rows($result);while($row=mysqli_fetch_assoc($result)){$b[]=$row;}// end whileforeach($b[0] as $k=>$v){		$headerArray[]=$k;		$header.="<th>$k</th>";		}//echo "<pre>";print_r($headerArray);echo "</pre>";exit;$decimalFlds=array("authorized","reversions","new_authorized","ytd_expenses","encumbrances","available_funds");if($rep==""){echo "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color='red'>$num records returned.</font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Close this window when done.</td></tr>";}if($rep=="excel"){echo "<tr>$header</tr>";}$yy=10;echo "<tr>";	for($i=0;$i<count($b);$i++){	if(fmod($i,$yy)==0 and $rep==""){echo "<tr>$header</tr><tr><td></td></tr>";}$bc=" bgcolor='white'";echo "<tr>";	for($j=0;$j<count($headerArray);$j++){		$var=$b[$i][$headerArray[$j]];		$fieldName=$headerArray[$j];		$totArray[$headerArray[$j]]+=$var;	$a="<td>";		if(in_array($headerArray[$j],$decimalFlds)){			$a="<td align='right'>";			$var=numFormat($var);}				if($var=="0.00"){$var="-";}		$f1="";$f2="";		if($var<0){$f1="<font color='red'>";$f2="</font>";}		echo "$a$f1$var$f2</td>";	}	echo "</tr>";	}//echo "<pre>"; print_r($totArray); echo "</pre>"; // exit;echo "<tr><td colspan='3'></td>";	for($j=3;$j<count($headerArray);$j++){			$var=$totArray[$headerArray[$j]];				$f1="";$f2="";		if($var<0){$f1="<font color='red'>";$f2="</font>";}		if($var==0){$var="-";}else{		if(in_array($headerArray[$j],$decimalFlds)){$var=numFormat($var);}		}	echo "<td align='right'><b>$f1$var$f2</b></td>";}echo "</tr>";echo "</table>";echo "</body></html>";function numFormat($nf){$nf=number_format($nf,2);return $nf;}?>