<?php$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/connectROOT.inc"); // connection parametersmysql_select_db($database, $connection); // databaseinclude("../../../include/authBUDGET.inc");extract($_REQUEST);//echo "<pre>";print_r($_REQUEST);print_r($_SESSION);echo "</pre>";exit;if($del!=""){$sql="DELETE from equipment_request_3 where er_num='$del' and division_approved !='y'";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");}// Construct Query to be passed to Excel Exportforeach($_REQUEST as $k => $v){if($v and $k!="PHPSESSID" and $k!="del"){$varQuery.=$k."=".$v."&";}}$passQuery=$varQuery;   $varQuery.="rep=excel";    $level=$_SESSION[budget][level];$thisUser=$_SESSION[budget][tempID];if($rep=="excel"){header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment; filename=park_equip_request.xls');}// Make f_yearif($f_year==""){$testMonth=date(n);if($testMonth >0 and $testMonth<7){$year2=date(Y)-1;}if($testMonth >6){$year2=date(Y);}$yearNext=$year2+1;$yx=substr($year2,2,2);$year3=$yearNext;$yy=substr($year3,2,2);$f_year=$yx.$yy;}if($level==2){switch ($_SESSION[budget][select]) {		case "SODI":			$w="and district='south'";			//$pu="and (district='south' OR purchaser='sodo')";			$pu="and (district='south')";			break;			case "NODI":			$w="and district='north'";			//$pu="and (district='north' OR purchaser='nodo')";			$pu="and (district='north')";			break;			case "EADI":			$w="and district='east'";			//$pu="and (district='east' OR purchaser='eado')";			$pu="and (district='east')";			break;			case "WEDI":			$w="and district='west'";			//$pu="and (district='west' OR purchaser='wedo')";			$pu="and (district='west')";			break;		}// end switch}// end level=2if($rep==""){include_once("../menu.php");}if($showSQL==1){$p="method='POST'";}if($submit!="Submit"){exit;}// ********* Body Queries ***************$pay_center=$_SESSION[budget][centerSess];$pay_center=$center;/*select query for center budgets*/$sql="select er_num,user_id,status,f_year,purchaser,location,pay_center,funding_source,category,equipment_description,unit_quantity,unit_cost,requested_amount,justification,pasu_priority,disu_priority,district_approved,division_approvedfrom equipment_request_3where 1and pay_center='$pay_center'and f_year='$f_year'";echo "$sql<br>";//exit;if($showSQL=="1"){echo "$sql<br>";}echo "<table border='1'><tr bgcolor='lightgray'><th colspan='3'><font color='red'>Existing Requests</font></th><form ID=\"equip_request_1\" NAME=\"equip_request_1\" action='park_equip_request_update.php' method='POST'>$goBack";$headerArray=array("er_num","user_id","f_year","purchaser","location","pay_center","funding_source","category","equipment_description","unit_quantity","unit_cost","requested_amount","justification","district_approved","division_approved");//"pasu_priority","disu_priority","status",$count=count($headerArray);for($i=0;$i<$count;$i++){$h=$headerArray[$i];$header.="<th>".$h."</th>";}echo "<td colspan='$count'>&nbsp;</td></tr><tr>$header</tr>";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");$num=mysql_num_rows($result);while($row=mysql_fetch_array($result)){$b[]=$row;}// end while//echo "<pre>";print_r($b);echo "</pre>";exit;//$pullDownFlds=array("status","purchaser","location","funding_source","pasu_priority","disu_priority");$pullDownFlds=array("category","purchaser","location","funding_source");//,"pasu_priority","status"$decimalFlds=array("requested_amount","approved_amount","ordered_amount", "unordered_amount","surplus_deficit","unit_cost");if($rep=="") {if($level>1){$editFlds=array("purchaser","location","pay_center","funding_source","category","equipment_description","unit_quantity","unit_cost","requested_amount","justification");}//"pasu_priority","disu_priority","status",else{$editFlds=array("purchaser","location","pay_center","funding_source","category","equipment_description","unit_quantity","unit_cost","requested_amount","justification");}//"pasu_priority","status",}$x=2;//echo "<tr><form ID=\"equip_request_1\" NAME=\"equip_request_1\" action='park_equip_request_update.php' method='POST'><tr>";	for($i=0;$i<count($b);$i++){	$r=fmod($i,$x);if($r==0){$bc=" bgcolor='aliceblue'";}else{$bc="";}echo "<tr$bc>";	for($j=0;$j<count($headerArray);$j++){	$var=$b[$i][$headerArray[$j]];$fieldName=$headerArray[$j];	if($fieldName=="er_num"){	$er=$var;	$var=$er." <a href='park_equip_request.php?del=$er&center=$center&m=1&submit=Submit' onClick='return confirmLink()'><img src='button_drop.png'></a>";	}		//if($fieldName=="user_id"){$var=substr($var,0,-2);}	//if($fieldName=="status" and $var=="inactive"){$bc=" bgcolor='yellow'";}	if($fieldName=="order_complete" and $var=="n"){$bc=" bgcolor='red'";}	if($fieldName=="receive_complete" and $var=="n"){$bc=" bgcolor='orange'";}	if($fieldName=="paid_in_full" and $var=="n"){$bc=" bgcolor='yellow'";}		if($var<0){$f1="<font color='red'>";$f2="</font>";}else{$f1="";$f2="";}		if(in_array($headerArray[$j],$decimalFlds)){	$a="<td align='right'$bc>";	$totArray[$headerArray[$j]]+=$var;	$var=numFormat($var);}		else{$a="<td$bc>";}					if(in_array($headerArray[$j],$editFlds)){						if(in_array($headerArray[$j],$pullDownFlds)){	echo "<td align='center'>";if($headerArray[$j]=="category"){$sql="SELECT concat( category, '=', ncas_account ) as concatMenu,category,ncas_accountFROM purchasing_productsWHERE 1ORDER BY category";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");$menuArray[]="";while($row=mysql_fetch_array($result)){$menuArray[$row[category]]=strtoupper($row[concatMenu]);$menuNCAS[$row[category]]=$row[ncas_account];}// end while//print_r($menuNCAS);}//if($headerArray[$j]=="status"){$menuArray=array("active"=>"active","inactive"=>"inactive");}if($headerArray[$j]=="funding_source"){$menuArray=array("","approp"=>"approp","opreserve"=>"opreserve","not_available"=>"not_available");}//if($headerArray[$j]=="pasu_priority"){$menuArray=array("","highest"=>"highest","high"=>"high","medium"=>"medium","lowest"=>"lowest");}//if($headerArray[$j]=="disu_priority"){$menuArray=array("","highest"=>"highest","high"=>"high","medium"=>"medium","lowest"=>"lowest");}if($headerArray[$j]=="purchaser"){//,fullname as pur$sql="SELECT codeFROM `purchasing_purchasers`WHERE 1ORDER BY code ASC";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");$menuArray[]="";while($row=mysql_fetch_array($result)){//$menuArray[$row[code]]=strtoupper($row[pur]);$menuArray[$row[code]]=$row[code];}// end while}if($headerArray[$j]=="location"){$sql="select distinct(location) as loc from equipment_request_3 where 1 order by location";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");while($row=mysql_fetch_array($result)){$menuArray[]=strtoupper($row[loc]);}// end while}// Make Pull-downsecho "<select name='$headerArray[$j][$er]'>";//if($headerArray[$j]=="category"){$ncas_acctMenu=$menuNCAS;}//if($headerArray[$j]=="purchaser"){$ncas_purMenu=$menuArray;}foreach($menuArray as $k=>$v){if($headerArray[$j]=="category"){$v=$k;$vv=$k;$v=strtoupper($v);$k=strtolower($menuArray[$k]);}if($headerArray[$j]=="purchaser"){$v=$k;$vv=$menuArray[$k];$v=strtoupper($v);}if(strtoupper($var)==strtoupper($v)){$s="selected";}else{$s="value";}if($headerArray[$j]=="category"){$v=$v."=".$menuNCAS[$vv];}if($headerArray[$j]=="purchaser"){$v=$vv;}echo "<option $s='$k'>$v</option>\n";}echo "</select></td>";unset($menuArray);}// end Pull-downelse						{			$value="";$ro="";$js="";$cs=10;if($headerArray[$j]=="justification"||$headerArray[$j]=="equipment_description"){$cs=30;}						echo "<td $bc align='center'><input type='text' name='$headerArray[$j][$er]' value='$var' size='$cs'$js></td>";}							}else{echo "$a$f1$var$f2</td>";}	}	echo "</tr>";	}echo "<tr>";	for($j=0;$j<count($headerArray);$j++){	if($totArray[$headerArray[$j]]){	$var=$totArray[$headerArray[$j]];	if($var<0){$f1="<font color='red'>";$f2="</font>";}else{$f1="";$f2="";}	$v=numFormat($var);$xx=2;	echo "<td align='right'><b>$v</b></td>";}else{echo "<td></td>";}}if(($level<3 and $_SESSION[budget][centerSess]==$pay_center) OR $level==2){$edit=1;}if($edit==1||$level>2){if($location){$pay_center=$center;}echo "</tr><tr><td colspan='2'>$num item(s)</td><td colspan='14' align='right'><input type='hidden' name='f_year' value='$f_year'><input type='hidden' name='passQuery' value='$passQuery'><input type='submit' name='submit' value='Update'></td></tr>";}echo "</form>";//  ************** Add New Record Form ********include("../../../include/parkcodesDiv.inc");echo "<tr bgcolor='lightgray'><th colspan='3'><font color='blue'>New Request</font></th><form ID=\"equip_request_2\" NAME=\"equip_request_2\" action='park_equip_request_update.php' method='POST'>";if($level>1){$editFlds=array("user_id","f_year","purchaser","location","pay_center","funding_source","category","equipment_description","unit_quantity","unit_cost","requested_amount","justification");}//"pasu_priority","disu_priority","status",else{$editFlds=array("user_id","f_year","purchaser","location","pay_center","funding_source","category","equipment_description","unit_quantity","unit_cost","requested_amount","justification");}//"pasu_priority","status",$pullDownFlds=array("category","purchaser","location","funding_source");//,"pasu_priority","disu_priority","status"if($level>2){$pullDownFlds[]="pay_center";}$textFlds=array("equipment_description","justification");$decimalFlds=array("requested_amount","unit_cost");echo "<td colspan='$j'>&nbsp;</td></tr><tr>";	for($j=0;$j<count($headerArray);$j++){	echo "<td align='right'><b>$headerArray[$j]</b></td>";}echo "</tr><tr>";for($j=0;$j<count($headerArray);$j++){		if(in_array($headerArray[$j],$decimalFlds)){	$a="<td align='right'>";			}else{$a="<td>";}			if(in_array($headerArray[$j],$editFlds)){			$cs="8";				if(in_array($headerArray[$j],$pullDownFlds)){	echo "<td align='center'>";if($headerArray[$j]=="category"){$sql="SELECT concat( category, '=', ncas_account ) as concatMenuFROM purchasing_productsWHERE 1ORDER BY category";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");$menuArray[]="";while($row=mysql_fetch_array($result)){$menuArray[$row[concatMenu]]=strtoupper($row[concatMenu]);}// end while}//if($headerArray[$j]=="status"){$menuArray=array("active","inactive");}if($headerArray[$j]=="funding_source"){$menuArray=array("","approp","opreserve","not_available");}//if($headerArray[$j]=="pasu_priority"){$menuArray=array("","highest","high","medium","lowest");}//if($headerArray[$j]=="disu_priority"){$menuArray=array("","highest","high","medium","lowest");}if($headerArray[$j]=="purchaser"){$sql="SELECT code,fullname as purFROM `purchasing_purchasers`WHERE 1ORDER BY code ASC";$result = mysql_query($sql) or die ("Couldn't execute query. $sql");$menuArray[]="";while($row=mysql_fetch_array($result)){$menuArray[$row[code]]=strtoupper($row[pur]);}// end while}if($headerArray[$j]=="location"){//$sql="select distinct(location) as loc from equipment_request_3 where 1 order by location";//$result = mysql_query($sql) or die ("Couldn't execute query. $sql");//while($row=mysql_fetch_array($result)){$menuArray[]=strtoupper($row[loc]);}// end while$menuArray=$parkCodeName;}if($headerArray[$j]=="pay_center"){$sql="SELECT section,parkcode,center as varCenter from center where fund='1280' order by section,parkcode,center";$result = mysql_query($sql) or die ("Couldn't execute query 1. $sql");$menuArray[]="";while ($row=mysql_fetch_array($result)){$menuArray[$row[varCenter]]=$row[parkcode]."-".$row[varCenter]."-".$row[section];}}echo "<select name='$headerArray[$j]'>";foreach($menuArray as $k=>$v){if($var==$v){$s="selected";}else{$s="value";}if($headerArray[$j]=="purchaser"||$headerArray[$j]=="pay_center"||$headerArray[$j]=="location"){$kv=$k;}else{$kv=$v;}echo "<option $s='$kv'>$v</option>\n";}echo "</select></td>";unset($menuArray);}// end Pull-downselse{			if(in_array($headerArray[$j],$textFlds)){echo "<td align='center'><textarea name='$headerArray[$j]' cols='30' rows='4'></textarea></td>";}		else{			$value="";$ro="";$js="";			if($headerArray[$j]=="user_id"){$value=substr($thisUser,0,-2);$ro="READONLY";}			if($headerArray[$j]=="f_year"){$value=$f_year;$ro="READONLY";}			if($headerArray[$j]=="pay_center"){$value=$center;			if($level<2){$ro="READONLY";}			}									if($headerArray[$j]=="unit_quantity"){$js=" onKeyUp=\"calc_add()\"";}			if($headerArray[$j]=="unit_cost"){$js=" onKeyUp=\"calc_add()\"";}						if($headerArray[$j]=="requested_amount"){$ro="READONLY";}						echo "<td align='center'><input type='text' name='$headerArray[$j]' size='$cs' value='$value'$ro$js></td>";}				}// end edit non-Pull_downs			}// end editFlds			else{echo "<td></td>";}		}	if($level>0){echo "</tr><tr><td colspan='$j' align='center'><input type='hidden' name='f_year' value='$f_year'><input type='hidden' name='passQuery' value='$passQuery'><input type='submit' name='submit' value='Add'></td></form></tr>";}$footer="<tr><td colspan='4' align='center'>Equipment Budget <a href='popupex.html' onclick=\"return popitup('explain_search.php?subject=equipment')\">Terminology</a></td></tr>";echo "$footer</table>";//echo "<pre>";print_r($ncas_purMenu);echo "</pre>";echo "</body></html>";function numFormat($nf){$nf=number_format($nf,2);return $nf;}?>