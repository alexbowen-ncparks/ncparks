<?php//include("../../include/authPHOTOS.inc");include("../../include/connectPHOTOS.inc");//$connection//echo "<pre>";print_r($_SERVER);echo "</pre>";$refer=explode("?",$_SERVER[HTTP_REFERER]);//echo "ref=$refer[0]";extract($_REQUEST);

$withThis="http:";
$pos=strpos($sciName,$withThis);
if($pos>-1){echo "bogus";exit;}if($sciName){// limit to only the linked photo// connect to NRID running on the 38 machine// cannot JOIN tables on different serversinclude("../../include/connectNRID.38.inc");//$connectionNRinclude("../../include/parkcodes.inc");$where="sciName='$sciName'";$sql = "select dprspp.comName,dprspp.majorGroup as mg,dprspp.orderX,dprspp.family,dprspp.authSp,dprspp.authSsp,synonymfrom dprspp where $where";//echo "1 $sql";exit;$result = @mysql_query($sql, $connectionNR) or die("$sql Error 1#". mysql_errno() . ": " . mysql_error());$row=MYSQL_FETCH_ARRAY($result);extract($row);//$sciName = urldecode($sciName);$getWords = explode(" ", $sciName);$first2Words = $getWords[0]." ".$getWords[1];$pidTest = $pid;$sql2 = "SELECT * FROM nrid.photos WHERE nrid.photos.sciName LIKE '$first2Words%' and photos.mark !='x'";$result2 = @mysql_query($sql2, $connectionNR) or die("Error 2# ".$sql2);$numrow2 = mysql_num_rows($result2);//echo "n=$numrow2";exit;// ****** Get any Fun Fact for majorGroup **********$sql2a = "SELECT funFact,sciName as ffmg FROM nrid.fact where sciName='$mg'";$result2a = @mysql_query($sql2a, $connectionNR) or die("Error #". mysql_errno() . ": " . mysql_error());$total_found2a = @mysql_num_rows($result2a);if($total_found2a > 0){while ($row2a = mysql_fetch_array($result2a)){extract($row2a);$funFactArrayMG[]=strtoupper($ffmg);}}//print_r($funFactArrayMG); echo "$mg";// ****** Get any Fun Fact for sciName **********$sql2c = "SELECT funFact,sciName FROM nrid.fact where sciName LIKE '$first2Words%'";$result2c = @mysql_query($sql2c, $connectionNR) or die("Error #". mysql_errno() . ": " . mysql_error());$total_found2c = @mysql_num_rows($result2c);if($total_found2c > 0){while ($row2c = mysql_fetch_array($result2c)){extract($row2c);$sciNameSearch=explode(" var ",$sciName);//echo "s=$sciNameSearch[0]";$funFactArraySN[]=$sciNameSearch[0];}}//print_r($funFactArraySN); echo "2 $sciName $sql2c";// ****** Get any Fun Fact for Genus **********$sql2d = "SELECT funFact,sciName FROM nrid.fact where sciName = '$getWords[0]'";$result2d = @mysql_query($sql2d, $connectionNR) or die("Error #". mysql_errno() . ": " . mysql_error());$total_found2d = @mysql_num_rows($result2d);if($total_found2d > 0){while ($row2d = mysql_fetch_array($result2d)){extract($row2d);$sciNameSearch=explode(" var ",$sciName);//echo "s=$sciNameSearch[0]";$funFactArrayGenus[]=$sciNameSearch[0];}}//print_r($funFactArrayGenus); echo "2 $getWords[0] $sql2d";// ****** Get any ID Note **********$genus=$getWords[0];$species=$getWords[1];$sql2c = "SELECT noteid,text,sciName as sciNameCheck FROM nrid.note where sciName LIKE '$genus%' and nrid.note.mark=''";//echo "$sql2c";$result2c = @mysql_query($sql2c, $connectionNR) or die("$sql2c Error #". mysql_errno() . ": " . mysql_error());$total_found2c = @mysql_num_rows($result2c);if($total_found2c > 0){while($row2c = mysql_fetch_array($result2c)){extract($row2c);$testText=strpos($text,$species);if($sciNameCheck==$genus." ".$species){$IDnote=1;$IDnoteArray[]=$noteid;}if($testText>-1 and $sciNameCheck!=$genus." ".$species){$IDnote=1;$IDnoteSimilarArray[]=$noteid;}		}// end while}// end if > 0}// if sciNmae$sql = "select photos.images.* from photos.images where pid='$pid'";//echo "p=$pid";exit;$result1 = @mysql_query($sql, $connection) or die("$sql Error 1#". mysql_errno() . ": " . mysql_error());$row1=MYSQL_FETCH_ARRAY($result1);extract($row1);    $linkOriginal=$link; //used to pass file location from database    $otherLinks[]=$link;$CATgroup = strtoupper(str_replace(",", " ", $cat));Header( "Content-type: text/html");    echo "<HTML><HEAD><TITLE>ID (Image Database)</TITLE><script language='JavaScript'>function confirmLink(){bConfirm=confirm('Are you sure you want to delete this Photo?') return (bConfirm);}</script></HEAD><BODY bgcolor='beige'><div align='center'";    echo "<hr><table border='1' cellpadding='3'><tr><td>Category: $CATgroup</td><td>Photo Title: $photoname</td><td>CD Name: $park $cd</td></tr><tr><td>File Name: $filename</td><td>Original File Size: $width x $height pixels</td></tr>";if($photog){echo "<tr><td>Photographer: $photog</td>";}if($date != "0000-00-00"){echo "<td>Date photo taken: $date </td>";}if($mg){echo "</tr><tr><td>Group: $mg </td><td>Order: $orderX</td><td>Family: $family</td></tr>";}if($sciName){if($authSp){$authSp1=" $authSp ";}$sciName1=$sciName;$pos1=strpos($sciName,' var. ');if($pos1>0){$sciNameArray=explode(" var. ",$sciName);$sciName1=$sciNameArray[0]; $sciNameVar=" <i>var. ".$sciNameArray[1]."</i>";}$pos2=strpos($sciName,' var ');if($pos2>0){$sciNameArray=explode(" var ",$sciName);$sciName1=$sciNameArray[0]; $sciNameVar=" <i>var. ".$sciNameArray[1]."</i>";}$pos3=strpos($sciName,' ssp ');if($pos3>0){$sciNameArray=explode(" ssp ",$sciName);$sciName1=$sciNameArray[0]; $sciNameVar=" <i>ssp. ".$sciNameArray[1]."</i>";}$pos4=strpos($sciName,' ssp. ');if($pos4>0){$sciNameArray=explode(" ssp. ",$sciName);$sciName1=$sciNameArray[0]; $sciNameVar=" <i>ssp. ".$sciNameArray[1]."</i>";}echo "<tr><td>SciName: <i>$sciName1</i>$authSp1 $sciNameVar $authSsp</td>";}if($comName){echo "<td>ComName: $comName </td>";}if($synonym){echo "<td>Synonym: <i>$synonym</i></td>";}if($source=="nrid" OR $refer[0]=="http://149.168.1.196/nrid/recentAddPH.php" OR $refer[0]=="http://149.168.1.196/nrid/viewPhoto.php"){//$source="nrid";$linkFull="<a href='fromNRID.php?pid=$pid&location=$link&size=max&source=nrid'>$width x $height</a>";if($width > "1024" || $height > "1024"){$link1024="<a href='fromNRID.php?pid=$pid&location=$link&size=1024&source=nrid'>1024</a>";}if($width > "800" || $height > "800"){$link800="<a href='fromNRID.php?pid=$pid&location=$link&size=800&source=nrid'>800</a>";}if($width > "640" || $height > "640"){$link640="<a href='fromNRID.php?pid=$pid&location=$link&size=640&source=nrid'>640</a>";}$editLink="<form action='edit.php' method='POST'><td><input type='hidden' name='category' value='$cat'><input type='hidden' name='park' value='$park'><input type='hidden' name='pid' value='$pid'><input type='hidden' name='photog' value='$photog'<input type='hidden' name='cd' value='$cd'><input type='hidden' name='date' value='$date'><input type='hidden' name='name' value='$name'><input type='hidden' name='photoname' value='$photoname'><input type='hidden' name='comment' value='$NScomment'><input type='submit' name='submit' value='Edit the Photo Info'></form></td><td><font size='-1'><a href='deletePh.php?pid=$pid' onClick='return confirmLink()'>Delete this Photo</a></font></td>";}else{if($photog=="Donald L. Barnett"){$linkFull="Click for full resolution of: <a href='$linkOriginal'>$width x $height</a>";}else{//$parkL=strtolower($park);echo "Also available in sizes up to <b>$width x $height</b><br>Contact the site <a href='mailto:tom.howard@ncdenr.gov?subject=Request%20for%20NRID%20photo%20info&body=Photo%20of%20$sciName%20from%20$park%20with%20ID=$pid'>admin</a> for info on obtaining a higher resolution of photo <font color='red'>#$pid</font>.";}}echo "</tr></table>";if($comment){echo "<table><tr><td>Comment: $comment</td></tr></table>";}echo "<table><tr><td align='center'>$linkFull</td><td>$link1024</td><td>$link800</td><td>$link640</td>$editLink</tr>";if($funFactArrayMG||$funFactArraySN||$IDnote||$funFactArrayGenus){echo "<tr>";if($funFactArrayMG){echo "<td align='center' colspan='3'>";$nKey=array_search($mg,$funFactArrayMG);if($nKey>-1){$searchTerm=$mg;}echo "[<a href=\"#\" onClick=\"window.open('http://149.168.1.196/nrid/getFactPub.php?sciName=$searchTerm','FunFact','height=600,width=500,scrollbars=1,resizable=1');\"><font size='+1'>$mg</font>-Fun Fact</a>]";}if($funFactArraySN){//print_r($funFactArraySN);$pos=strpos($sciName,' var. ');if($pos===false){$v=" var ";}else{$v=" var. ";}$sciNameSearch=explode($v,$sciName);//echo "s=$sciNameSearch[0]";$nKey=array_search($sciNameSearch[0],$funFactArraySN);if($nKey>-1){$searchTerm=$sciNameSearch[0];} else{$searchTerm=$first2Words;}echo "[<a href=\"#\" onClick=\"window.open('http://149.168.1.196/nrid/getFactPub.php?sciName=$searchTerm','FunFact','height=600,width=500,scrollbars=1,resizable=1');\"><font size='+1'><i>$sciName</i></font>-Fun Fact</a>] ";echo "</td>";}// end funfactif($funFactArrayGenus){//print_r($funFactArrayGenus);$sciNameSearch=explode(" ",$sciName);//echo "s=$sciNameSearch[0]";$nKey=array_search($sciNameSearch[0],$funFactArrayGenus);if($nKey>-1){$searchTerm=$sciNameSearch[0];}echo "[<a href=\"#\" onClick=\"window.open('http://149.168.1.196/nrid/getFactPub.php?genus=$searchTerm','FunFact','height=600,width=500,scrollbars=1,resizable=1');\"><font size='+1'>$sciNameSearch[0] -Fun Fact</a>]  ";echo "</td>";}// end funfactif($IDnote){if($IDnoteArray){echo "<td align='center' colspan='3'>ID Note for Species";$endTD1="</td>";}for($nn=0;$nn<count($IDnoteArray);$nn++){echo "&nbsp;&nbsp;&nbsp;[<a href=\"#\" onClick=\"window.open('http://149.168.1.196/nrid/getNoteID.php?noteid=$IDnoteArray[$nn]','FunFact','height=600,width=500,scrollbars=1,resizable=1');\"><font size='+1'>v-$nn</font></a>]";}echo "$endTD1";if($IDnoteSimilarArray){echo "<td align='center' colspan='3'>ID Note Similar Species";$endTD2="</td>";}for($nn=0;$nn<count($IDnoteSimilarArray);$nn++){echo "&nbsp;&nbsp;&nbsp;[<a href=\"#\" onClick=\"window.open('http://149.168.1.196/nrid/getNoteID.php?noteid=$IDnoteSimilarArray[$nn]','FunFact','height=400,width=400,scrollbars=1,resizable=1');\"><font size='+1'>v-$nn</font></a>]";}echo "$endTD2";}// end IDnoteecho "</tr>";}// end if funfact or IDnoteecho "</table>";// Works with either photo stored in db or as a file$cn=urlencode($comName);if(!$location){echo "<img src='getPhoto.php?pid=$pid' alt=\"$cn (<I>$sciName</I>), $parkCodeName[$park], North Carolina, United States\">";}	else	{$loc=explode("/",$location); //if($source=="pub" || $source==""){$size="640";}	switch ($size) {		case "max":echo "<img src='$location'>";			break;		case "1024":		// code to resize to 800  resize.php$wid=1024; $hei=1024;$tn=$loc[0]."/".$loc[1]."/".$loc[2]."/1024.".$pid.".jpg";if (file_exists($tn)) {    echo "<img src='$tn'>";} else {include("resize.php");createthumb($location,$tn,$wid,$hei);echo "<img src='$tn'>";}			break;		case "800":		// code to resize to 800  resize.php$wid=800; $hei=800;$tn=$loc[0]."/".$loc[1]."/".$loc[2]."/800.".$pid.".jpg";if (file_exists($tn)) {    echo "<img src='$tn'>";} else {include("resize.php");createthumb($location,$tn,$wid,$hei);echo "<img src='$tn'>";}			break;		case "640":		// code to resize to 640  resize.php$wid=640; $hei=640;$tn=$loc[0]."/".$loc[1]."/".$loc[2]."/640.".$pid.".jpg";if (file_exists($tn)) {    echo "<img src='$tn' alt=\"$cn (<I>$sciName</I>), $parkCodeName[$park], North Carolina, United States\">";} else {include("resize.php");createthumb($location,$tn,$wid,$hei);echo "<img src='$tn'>";}			break;		default:		$tn=$loc[0]."/".$loc[1]."/".$loc[2]."/640.".$pid.".jpg";			echo "<img src='$tn'>";		}	}	if($source=="pub"){echo "<br>Close window when done.<br><br><a href='http://149.168.1.196/nrid/gallery.php'>Search</a> Photo Gallery";//exit;}if($sciName){$sql = "select photos.images.* from photos.images where sciName='$sciName' and mark=''";$result1 = @mysql_query($sql, $connection) or die("$sql Error 1#". mysql_errno() . ": " . mysql_error());$num=mysql_num_rows($result1);$j=0;$k=4;if($num>1){echo "<hr><table>";while ($row1=MYSQL_FETCH_ARRAY($result1)){extract($row1);$base="http://149.168.1.195/photos/";if($source=="nrid" OR $refer[0]=="http://149.168.1.196/nrid/recentAddPH.php"){$newLink="http://149.168.1.195/photos/fromNRID.php?sciName=$sciName&pid=$pid&location=$link&size=640&source=nrid";}else{$newLink="http://149.168.1.195/photos/fromNRID.php?sciName=$sciName&pid=$pid&location=$link&size=640&source=pub";}$iLink=explode("/",$link);$tempA=array($iLink[0],$iLink[1],$iLink[2]);$jLink=implode("/",$tempA);$x++;$tnLink=$base.$jLink."/ztn.".$iLink[3];$z=fmod($j,$k);if($z==0){$t1="<tr>";}else{$t1="";}if($z==3){$t2="</tr>";}else{$t2="";}echo "$t1<td width='25%' align='center'><a href='$newLink'><img src='$tnLink'><br>Photo $x</a> &nbsp;&nbsp;$park&nbsp;&nbsp;$comment</td>$t2";$j++;}echo "</table>";}}// ********** Show Photos from NRID **********$NRIDlink="http://149.168.1.196/nrid/"; $i = 1; $SIPSpath = "/usr/bin";$j=0;$k=4;while ($row2 = mysql_fetch_array($result2))	{extract($row2);if($i==1){echo "<hr>Photos from NRID<br><table border='1' cellpadding='5'>";}$filename=$link;// for sips$path=explode("/",$filename);$folder="photos/".$path[1]."/~tn";if (!file_exists($folder)) {mkdir ($folder, 0777);}$tnName=$folder."/tn".$path[2];$link = "<a href='http://149.168.1.196/nrid/getDataPub.php?pid=$pid' target='_blank'>";//$getName = explode(" ", $sciName);$countWords=count($getName);$zz = "<i>".$sciName."</i><br>".$comName;if (!file_exists($tnName)) {exec("$SIPSpath/sips -g format $filename",$output);if($output[1]!="format: jpeg"){exec("$SIPSpath/sips --setProperty format jpeg --setProperty formatOptions high $filename");}exec("$SIPSpath/sips -Z 150 $filename --out $tnName");}$z=fmod($j,$k);if($z==0){$t1="<tr>";}else{$t1="";}if($z==3){$t2="</tr>";}else{$t2="";}$tnName1=$NRIDlink.$tnName;echo "$t1<td align='center' width='25%'>$link<img src=\"$tnName1\" alt=\"$cn (<I>$sciName</I>), $park, $parkCodeName[$park], North Carolina, United States\"><br>Photo $i </a><br>from <b>$parkCodeName[$park]</b><br>$zz<br>$comment</td>$t2"; $i++; $j++;  		}   echo "</table>";			echo "</div></body></html>";?>