<?php$database="state_lakes";include("../../include/connectROOT.inc");// database connection parameters$db = mysql_select_db($database,$connection)       or die ("Couldn't select database $database");extract($_REQUEST);$tab="Reports";if($rep=="")	{	include("menu.php");	}	else	{	header('Content-Type: application/vnd.ms-excel');	header('Content-Disposition: attachment; filename=outstanding_fees.xls');	}//session_start();$level=$_SESSION['state_lakes']['level'];//echo "<pre>"; print_r($_REQUEST); echo "</pre>";  //exit;if($park==""){echo "You must select a park.";exit;}if($unpaid=="x")	{	$pass_query="&unpaid=x&park=$park";	}	else	{	$pass_query="&start_date=$start_date&end_date=$end_date&park=$park";	}	// seawall in not included since there is no charge$field_list_1="t1.park,t1.entity,t1.id,t1.billing_title,t1.billing_last_name,t1.billing_first_name,group_concat(distinct t2.check_number separator ',') as pier_check_number,group_concat(distinct t2.pier_mod_check separator ',') as pier_mod_check,count(distinct t2.pier_id) as number_pier_check,count(distinct t5.buoy_id) as number_buoy_check,count(distinct t4.ramp_id) as number_ramp_check,count(distinct t6.swim_line_id) as number_swim_line_check,count(distinct t7.seawall_id) as number_seawall_check,group_concat(distinct t5.check_number separator ',') as buoy_check_number,group_concat(distinct t4.check_number separator ',') as ramp_check_number,group_concat(distinct t6.check_number separator ',') as swim_line_check_number,group_concat(distinct t7.check_number separator ',') as seawall_check_number,group_concat(distinct t2.pier_payment separator ',') as pier_receipt,group_concat(distinct t5.buoy_receipt separator ',') as buoy_receipt,group_concat(distinct t4.ramp_receipt separator ',') as ramp_receipt,group_concat(distinct t6.swim_line_receipt separator ',') as swim_line_receipt,group_concat(distinct concat(t2.pier_number,'=',t2.fee) separator '<br />') as pier_fee,(count(distinct t5.fee)*(t5.fee)) as buoy_fee,(count(distinct t4.fee)*(t4.fee)) as ramp_fee,(count(distinct t6.fee)*(t6.fee)) as swim_line_fee,t5.app_fee as buoy_app_fee,t2.transfer_fee as pier_transfer_fee,t2.mod_fee_amt as pier_mod_fee,t7.app_fee as seawall_app_fee";if($park=="WHLA" OR $park=="BATR")	{	$clause="and (t1.park='WHLA' OR t1.park='BATR')";	}	ELSE	{	$clause="and t1.park='$park'";	}if($end_date=="")	{	$end_date=$start_date;	$date_range="for $start_date";	}	else	{	$date_range="from $start_date to $end_date";	}	$receipt_clause="((t2.pier_payment >= '$start_date' AND t2.pier_payment <= '$end_date') OR (t4.ramp_receipt >= '$start_date' AND t4.ramp_receipt <= '$end_date') OR (t5.buoy_receipt >= '$start_date' AND t5.buoy_receipt <= '$end_date') OR (t6.swim_line_receipt >= '$start_date' AND t6.swim_line_receipt <= '$end_date') OR (t2.trans_pay_date >= '$start_date' AND t2.trans_pay_date <= '$end_date') OR (t2.mod_pay_date >= '$start_date' AND t2.mod_pay_date <= '$end_date') OR (t7.app_date >= '$start_date' AND t7.app_date <= '$end_date'))";if($unpaid=="x")	{	$receipt_clause="(t2.pier_payment = '' OR t4.ramp_receipt = '' OR t5.buoy_receipt = '' OR t6.swim_line_receipt = '')";	}$sql="SELECT $field_list_1FROM  contacts as t1LEFT JOIN piers as t2 on t1.id=t2.contacts_id LEFT JOIN ramp as t4 on t1.id=t4.contacts_id LEFT JOIN buoy as t5 on t1.id=t5.contacts_id LEFT JOIN swim_line as t6 on t1.id=t6.contacts_id LEFT JOIN seawall as t7 on t1.id=t7.contacts_id where 1 and (t2.pier_number is not NULL OR t4.ramp_id is not NULL OR t5.buoy_id is not NULL OR t6.swim_line_id is not NULL OR t7.seawall_id is not NULL)and $receipt_clause$clausegroup by t1.idORDER BY billing_last_name"; //echo "$sql";$result1 = mysql_query($sql) or die ("Couldn't execute query. $sql c=$connection");$num_pay=mysql_num_rows($result1);if($num_pay<1){echo "No records found for $park $start_date.";exit;}while($row=mysql_fetch_assoc($result1))	{	$ARRAY[]=$row;	}//echo "<pre>"; print_r($ARRAY); echo "</pre>";  //exit;$skip=array("buoy_receipt","ramp_receipt","swim_line_receipt","buoy_check_number","ramp_check_number","swim_line_check_number","number_pier_check","number_buoy_check","number_ramp_check","number_swim_line_check","number_seawall_check","seawall_check_number");if($unpaid=="x")	{	$phrase="Owner/Agents with outstanding fees for this Fiscal Year";	}	else	{	$phrase="Payments received <font color='red'>$date_range</font>";	}echo "<table border='1' cellpadding='2'><tr><th colspan='18'>$num_pay $phrase $clause</th></tr><tr>";	foreach($ARRAY[0] as $fld=>$array)		{		if(in_array($fld,$skip)){continue;}		if($fld=="pier_receipt"){$fld="receipt_date";}		if($fld=="pier_check_number"){$fld="check_number";}		$fld=str_replace("_"," ",$fld);		echo "<th>$fld</th>";		}	echo "<th>Total</th></tr>";//echo "<pre>"; print_r($ARRAY); echo "</pre>";  //exit;		foreach($ARRAY as $num=>$array)	{		echo "<tr>";		foreach($array as $k=>$v)			{			if(in_array($k,$skip)){continue;}			$td=""; $temp="";						if(strpos($k,"_fee")>-1)				{				if($k=="pier_fee")					{					$td=" align='right'";					$var_id_fee=explode("<br />",$v);						foreach($var_id_fee as $fee_value)							{							$var_fee_1=explode("=",$fee_value);								if($array['pier_receipt']<$start_date OR $array['pier_receipt']>$end_date)								{								$v="";								continue;								}							$total+=$var_fee_1[1];														}					}					else					{						if($k=="buoy_fee")							{							if($array['buoy_receipt']>=$start_date AND $array['buoy_receipt']<=$end_date)								{								$v=15*$ARRAY[$num]['number_buoy_check'];								}								else								{								$v="";								}							}											$total+=$v; $td=" align='right'";					}								}						if($k=="id")				{					if($rep=="")						{						$v="<a href='payment_form.php?contact_id=$v' target='_blank'>$v</a>";						}				}							if($k=="pier_check_number")				{				unset($temp);				unset($vTemp);				unset($count);				$objects=array("pier","buoy","ramp","swim_line");				foreach($objects as $key=>$var)					{					$obj=$var."_check_number";					$obj_1="number_".$var."_check";				$temp=array();				if($array[$obj]!="")						{						$test=explode(",",$array[$obj]);						$count=$array[$obj_1];							foreach($test as $k1=>$v1)							{							if(!in_array($v1,$temp)){$temp[]=$v1;}							}						if($count>1){$p=$var."s";}else{$p=$var;}						$object=implode(",",$temp)." - ($count $p)";						$vTemp.="<br />".$object;						}					}					$v=$vTemp;				}							if($k=="pier_receipt")				{								unset($temp);				unset($vTemp);				unset($count);				$objects=array("pier","buoy","ramp","swim_line");				foreach($objects as $key=>$var)					{					$obj=$var."_receipt";				$temp=array();				if($array[$obj]!="")						{						$test=explode(",",$array[$obj]);						$count=$array[$obj_1];							foreach($test as $k1=>$v1)							{							if($v1<$start_date OR $v1>$end_date)								{continue;}							if(!in_array($v1,$temp))								{								$temp[]=$v1;								}							}						$object=implode(",",$temp);						$vTemp.="<br />".$object;						}					}					$v=$vTemp;				}						if($v==","){$v="";}			echo "<td$td>$v</td>";				}		echo "<th>$total</th></tr>";		$grand_total+=$total;		unset($total);	}	$gt=number_format($grand_total,2);echo "<tr><td colspan='18' align='right'><b>$gt</b></td></tr>";$journal="<a href='cash_journal.php?pass_query=$pass_query'>Journal</a>";echo "<tr><td colspan='18' align='right'>$journal <a href='payments_received.php?pass_query=$pass_query&rep=x'>Excel</a></td></tr>";echo "<tr><td colspan='18' align='right'>Late Fee Letter(s) <a href='http://149.168.1.196/state_lakes/print_letters_unpaid.php?pass_query=$pass_query'>PDF</a> (For now this is presently limited to 20 letters while we are testing this function.)</td></tr>";	echo "</table></body></html>";?>