<?php$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/iConnect.inc"); // connection parametersmysqli_select_db($connection, $database); // databaseinclude("../../../include/authBUDGET.inc");extract($_REQUEST);//echo "<pre>";print_r($_REQUEST);print_r($_SESSION);echo "</pre>";// Construct Query to be passed to Excel Exportforeach($_REQUEST as $k => $v){if($v and $k!="PHPSESSID"){$varQuery.=$k."=".$v."&";}}$passQuery=$varQuery;   $varQuery.="rep=excel";    $level=$_SESSION[budget][level];if($rep=="excel"){header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment; filename=equipment_division.xls');}// Get f_yearinclude("../~f_year.php");echo "<table align='center'>";//if($submit!="Submit"){exit;}//$showSQL=1;// ********* Body Queries *************** $query = "truncate table equipment_payments1;";    $result = @mysqli_query($connection, $query,$connection);if($showSQL=="1"){echo "$query<br><br>";} $query = "insert into equipment_payments1(er_num,center,account,vendor_name,transaction_date,transaction_number,transaction_amount,transaction_type,source_table,source_id,post2ncas)selecter_num,ncas_center,ncas_account,vendor_name,datesql,ncas_invoice_number,ncas_invoice_amount,'cdcs','cid_vendor_invoice_payments',id,post2ncasfrom cid_vendor_invoice_paymentswhere 1and er_num != ''and ncas_credit != 'x' group by id;"; $result = @mysqli_query($connection, $query,$connection);if($showSQL=="1"){echo "$query<br><br>";} $query = "insert into equipment_payments1( er_num, center, account, vendor_name, transaction_date, transaction_number, transaction_amount, transaction_type, source_table, source_id, post2ncas ) select er_num, ncas_center, ncas_account, vendor_name, datesql, ncas_invoice_number, -ncas_invoice_amount,'cdcs','cid_vendor_invoice_payments', id, post2ncas from cid_vendor_invoice_payments where 1 and er_num != '' and ncas_credit = 'x' group by id;";  $result = @mysqli_query($connection, $query,$connection);if($showSQL=="1"){echo "$query<br><br>";} $query = "insert into equipment_payments1(er_num,center,account,vendor_name,transaction_date,transaction_number,transaction_amount,transaction_type,source_table,source_id,post2ncas)selectequipnum,center,ncasnum,concat('pcard','-',cardholder,'-',vendor_name,'-',trans_date),transdate_new,transid_new,sum(amount),'pcard','pcard_unreconciled',id,ncas_ynfrom pcard_unreconciledwhere 1and equipnum != ''group by id;";  $result = @mysqli_query($connection, $query,$connection);if($showSQL=="1"){echo "$query<br><br>";}/*select query for er num*/$sql="select *from equipment_payments1where er_num='$er_num'order by er_num;";//echo "$sql<br>";exit;if($showSQL=="1"){echo "$sql<br>";}if($rep==""){$goBack="<tr><td><a href='er_display.php?$varQuery'>Excel</a></td></tr>";}$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$num=mysqli_num_rows($result);echo "<table border='1'>$goBack";$headerArray=array("er_num",  "vendor_name","transaction_number","transaction_date","transaction_amount","transaction_type","post2ncas");$replaceArray=array("er_num","transaction_number","transaction_date","transaction_amount","transaction_type");$decimalFlds=array("transaction_amount");$count=count($headerArray);for($i=0;$i<$count;$i++){$h=$headerArray[$i];if(!in_array($h,$dontShow)){	$selectFields.=$h.",";if($rep==""){if(in_array($h,$replaceArray)){$h=str_replace("_","<br>",$h);}			}	$header.="<th>".$h."</th>";					}	}while($row=mysqli_fetch_array($result)){$b[]=$row;}// end while$cen=$b[0][center];$er=$b[0][er_num];if($num<1){$notice="<br />No payment has been made yet.";}echo "<tr><td colspan='$count'>&nbsp;&nbsp;&nbsp;<font color='green' size='+1'>$num payments</font> <font color='red' size='+1'>for er_num $er center $cen</font> $notice</td></tr>";$x=2;if($passYY){$yy=$passYY;}else{$yy=10;}echo "<tr>";	for($i=0;$i<count($b);$i++){	$r=fmod($i,$x);if($r==0){$bc=" bgcolor='aliceblue'";}else{$bc="";}	if(fmod($i,$yy)==0 and $rep==""){echo "<tr>$header</tr>";}echo "<tr$bc>";	for($j=0;$j<count($headerArray);$j++){	$var=$b[$i][$headerArray[$j]];	$fieldName=$headerArray[$j];		if($fieldName=="er_num"){$er=$var;}		if(in_array($fieldName,$decimalFlds)){	$a="<td align='right'>";$totArray[$fieldName]+=$var;	$var=numFormat($var);}else{$a="<td>";}			if(in_array($fieldName,$editFlds)){			if(in_array($fieldName,$radioFlds)){	if($var=="y"){$ckY="checked";$ckN="";}else{$ckN="checked";$ckY="";}echo "<td align='right'><font color='green' size='-1'>Y</font><input type='radio' name='$headerArray[$j][$er]' value='y'$ckY><font color='red' size='-1'>N</font><input type='radio' name='$headerArray[$j][$er]' value='n'$ckN></td>";}else						{echo "<td bgcolor='beige' align='center'><input type='text' name='$headerArray[$j][$er]' value='$var' size='10'></td>";}									}else{echo "$a$var</td>";}	}	echo "</tr>";	}echo "<tr>";	for($j=0;$j<count($headerArray);$j++){	if($totArray[$headerArray[$j]]){	$var=$totArray[$headerArray[$j]];	if($var<0){$f1="<font color='red'>";$f2="</font>";}else{$f1="";$f2="";}	$v=numFormat($var);$xx=2;	echo "<td align='right'><b>$v</b></td>";}else{echo "<td></td>";}}/*$footer="<tr><td colspan='8' align='center'>Equipment Budget <a href='popupex.html' onclick=\"return popitup('explain_search.php?subject=equipment')\">Terminology</a></td></tr>";*/$footer="<tr><td colspan='9' align='center'><font color='red'>Close window to exit.</font></td></tr>";echo "$footer</table></body></html>";function numFormat($nf){$nf=number_format($nf,2);return $nf;}?>