<?php//These are placed outside of the webserver directory for security$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/iConnect.inc"); // connection parametersmysqli_select_db($connection, $database); // databasesession_start();extract($_REQUEST);$level=$_SESSION[budget][level];// Construct Query to be passed to Excel Export$varQuery="submit=Submit&center=$center&budget_group=$budget_group&track_rcc=$track_rcc";//print_r($_SESSION);//EXIT;//print_r($_REQUEST);//EXIT;// ******** Edit/Update Status ***********if($p_ok=="y" and $level>4){$query="UPDATE `cid_vendor_invoice_payments` set post2ncas='y'WHERE id='$idPass'";//echo "$query<br>";exit;$result = mysqli_query($connection, $query) or die ("Couldn't execute query 0. $query");}// end if$m="trans_unpost";if($rep==""){include("../menu.php");}if($level<2){$center=$_SESSION[budget][centerSess];//$submit="submit";}/*$sql="select max(acctdate) as maxDate from exp_rev where 1";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$row=mysqli_fetch_array($result);extract($row);*/if($rep==""){// Display Formecho "<html><header></header<title></title><body><table align='center'><form method='POST' action='transactions_unposted.php'>";if($level>1){echo "<tr><td colspan='3'>";$sql="SELECT section,parkcode,center as varCenter from center where fund='1280' order by section,parkcode,center";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 1. $sql");while ($row=mysqli_fetch_array($result)){extract($row);$pc[]=$parkcode;$c[]=$varCenter;$sec[]=$section;}echo "<select name=\"center\"><option selected>Select Center</option>";for ($n=0;$n<count($c);$n++){$show=$sec[$n]."-".$pc[$n]."-".$c[$n];if($center==$c[$n]||$center==$show){$s="selected";}else{$s="value";}$con=$c[$n];		echo "<option $s='$con'>$show</option>\n";       }   echo "</select></td>";}// ******** Budget Groups *************$sql="select distinct budget_group as bud_group from coa where 1 and budget_group != '' order by budget_group";$result = mysqli_query($connection, $sql) or die ("Couldn't execute query 1. $sql");while ($row=mysqli_fetch_array($result)){extract($row);$bg[]=$bud_group;}if(!$budget_group){$budget_group="operating_expenses";}echo "<td>View: transactions where Budget Group is: ";echo "<select name=\"budget_group\">";foreach($bg as $k => $v){if($budget_group==$v){$s="selected";}else{$s="value";}		echo "<option $s='$v'>$v\n";       }   echo "</select></td>";echo "<td>Track RCC: <select name=\"track_rcc\">";		echo "<option value=''>\n";		echo "<option selected='y'>y\n";		echo "<option value='n'>n\n";echo "</select></td>";echo "<td>Show SQL <input type='checkbox' name='showSQL' value='x'></td>";//echo "<pre>";print_r($bg);echo "</pre>";EXIT;//if($center){$addCenter="<input type='hidden' name='center' value='$center'>";}echo "<td>$addCenter<input type='submit' name='submit' value='Submit'></td></form></tr>";if($submit){if($center==""||$center=="Select Center"){echo "<font color='red'>You must select a Center.</font>";exit;}echo "<tr><td colspan='7'><a href='transactions_unposted.php?$varQuery&rep=excel'>Excel Export</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color='DarkRed' size='+1'>$message</font></td></tr>";//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Invoices Paid-<a href='quick_lookup.php?center=$center'>Quick Lookup</a>}// if submitecho "</table>";}if($submit!=""){$find="-";$testStr=strpos($center,$find);if($testStr>0){$cen=explode("-",$center);$center=$cen[2];}//else{$center=$_SESSION[budget][centerSess];}//$today_60=date("Ymd",mktime(0,0,0,date(m),date(d)-60,date(Y)));$sql="SELECT parkcode,ncas_center AS  'center', ncas_account, park_acct_desc AS  'description', vendor_name as 'vendor', ncas_invoice_date AS  'invoice_date', ncas_invoice_number AS  'invoice', ncas_invoice_amount AS  'amount', id, post2ncas,parkcode as 'location', user_id as 'user_id', system_entry_date as 'system_date'FROM  `cid_vendor_invoice_payments` LEFT  JOIN coa ON cid_vendor_invoice_payments.ncas_account = coa.ncasnumWHERE 1  AND ncas_center =  '$center' AND budget_group =  '$budget_group' AND track_rcc =  '$track_rcc' AND post2ncas !=  'y'ORDER  BY center,ncas_account,vendor_name";if($showSQL){echo "$sql<br><br>";//exit;}//echo "$sql<br><br>";//exit;$result = mysqli_query($connection, $sql) or die ("Couldn't execute query. $sql");$num=mysqli_num_rows($result);if($rep=="excel"){header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment; filename=transactions_unposted.xls');}// Display Resultsecho "<html><header></header><title>Transactions Unposted</title><body><table border='1' align='center'><tr><td colspan='4' align='center'><font color='blue'>$num</font> records returned</td><td colspan='4' align='center'><a href='/budget/c/operating_expense_available.php'>Operating Budget Available</a></td></tr>";$header="<tr><th>center</th><th>ncas<br>account</th><th>description</th><th>vendor</th><th>invoice<br>date</th><th>invoice</th><th>amount</th><th>location</th><th>user_id</th><th>system<br>date</th><th>id</th>";//echo "<th>quick<br>post</th>";echo "</tr>";echo "$header";if($message!=""){$_SESSION[budget][checkID][]=$idRow;}while($row=mysqli_fetch_array($result)){extract($row); $amtTotal+=$amount;$amt=$amount;$amount=number_format($amount,2);if($ckNCAS!="" AND $ckNCAS!=$ncas_account){echo "<tr><td colspan='8'>&nbsp;</td></tr>";}$ckNCAS=$ncas_account;if(in_array($id,$_SESSION[budget][checkID])){$rc=" bgcolor='yellow'";}else{$rc="";if($p_ok=="y" and $id==$idPass){$rc=" bgcolor='aliceblue'";}}echo "<tr$rc><td align='center'>$center</td><td>$ncas_account</td><td width='150'>$description</td><td>$vendor</td><td align='center'>$invoice_date</td><td>$invoice</td><td align='right'>$amount</td><td>$location</td><td>$user_id</td><td>$system_date</td><td align='center'>$id</td>";/*echo "<td align='center'><a href='quick_lookup.php?submit=submit&center=$center&budget_group=$budget_group&amount=$amt&id=$id'>lookup</a></td>";*/echo "</tr>";}$amtTotal=number_format($amtTotal,2);echo "<tr><td colspan='7' align='right'>$amtTotal</td></tr>";echo "</table></body></html>";}?>