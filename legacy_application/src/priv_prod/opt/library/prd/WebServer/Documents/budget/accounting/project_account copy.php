<?php// Requires makeTable.php, uploadTextFileForm.php, uploadTextFile.php$database="budget";$db="budget";include("/opt/library/prd/WebServer/include/connectROOT.inc"); // connection parametersmysql_select_db($database, $connection); // databasesession_start();//$_SESSION[budget][statusC0]="";exit;extract($_REQUEST);//include("../menu.php");//if ($_SESSION[budget][level] < 2){echo "You do not have Admin privileges.";exit();}//print_r($_SESSION);// *********** Input Fields ****************$sql = "select max(datenew) as max from partf_payments where 1";$result = @mysql_query($sql, $connection) or die("$sql Error 1#". mysql_errno() . ": " . mysql_error());$row=mysql_fetch_array($result);extract($row);if($_SESSION[budget][start] AND $_SESSION[budget][end]){$start=$_SESSION[budget][start];$end=$_SESSION[budget][end];}echo "<hr><div align='center'>Last Update = $max<form action='project_account.php'> <table><tr><td>Start Date (yyyymmdd): <input type='text' name='start' size='10' value='$start'></td><td>End Date (yyyymmdd): <input type='text' name='end' size='10' value='$end'></td><td>Current Fiscal Year: <input type='text' name='fy' size='6' value='$fy'><input type='submit' name='submit' value='Find'></form></td></tr></table><form></div>";if(!$fy){echo "You must enter a Fiscal Year";exit;}else{$_SESSION[budget][start]=$start;$_SESSION[budget][end]=$end;$_SESSION[budget][statusFY]=$fy;$fy=$_SESSION[budget][statusFY];}$comp="<font color='red'>Completed</font>";// *********** Run Steps ****************$start=$_SESSION[budget][start];$end=$_SESSION[budget][end];//Aif($_SESSION[budget][statusA]!="x"){$sql = "Truncate table xtnd_ci_monthly";	$result = @mysql_query($sql, $connection);$sql = "Truncate table reconcilement_non1280";	$result = @mysql_query($sql, $connection);$sql = "Truncate table cid_charg_project_balances";	$result = @mysql_query($sql, $connection);if($result){$_SESSION[budget][statusA]="x";}$A="<a href='project_account.php?fy=$fy'>Run</a>";}else{$A="$comp";}echo "$A A) Truncate temporary tables=(xtnd_ci_monthly,reconcilement_non1280,cid_charg_project_balances)";//A0if($_SESSION[budget][statusA0]!="x"){$A0="<a href='project_account.php?fy=$fy&r=A0'>Run</a>";$table="pcard_xtnd_bk".date(ymdHis);$_SESSION[budget][table]=$table;if($r=="A0"){$table=$_SESSION[budget][table];$sql = "CREATE table $table SELECT * from pcard_xtnd where 1";	$result = @mysql_query($sql, $connection);//echo "$sql r=$result";exit;if($result){$_SESSION[budget][statusA0]="x";}$sql = "DELETE from pcard_xtnd where f_year='$fy'";	$result = @mysql_query($sql, $connection);	header("Location: project_account.php?fy=$fy");}}else{$A0="$comp";}$t=$_SESSION[budget][table];echo "<br><br>$A0 A0) Backup to $t then delete current year records from Table=pcard_xtnd";//A1aif($_SESSION[budget][statusA1a]!="x"){$A1a="<a href='/budget/uploadTextFileForm.php?db=pcard_xtnd&s=A1a'>Run</a>";}else{$A1a="$comp";}echo "<br><br>$A1a A1a) Insert XTND 1616 report(pcard) into table=(pcard_xtnd) [<font color='blue'>Download XTND 1616 report(pcard) into excel and clean up to text should already have been completed.</font>]";//A1bif($_SESSION[budget][statusA1b]!="x"){$A1b="<a href='/budget/uploadTextFileForm.php?db=pcard_xtnd&s=A1b'>Run</a>";}else{$A1b="$comp";}echo "<br><br>$A1b A1b) Insert XTND 1629 report(pcard) into table=(pcard_xtnd) [<font color='blue'>Download XTND 1629 report(pcard) into excel and clean up to text should already have been completed.</font>]";//A2if($_SESSION[budget][statusA2]!="x"){$A2="<a href='project_account.php?fy=$fy&r=A2'>Run</a>";if($r=="A2"){$sql = "update pcard_xtnd set card_num=trim(card_num), user_name=trim(user_name), vendor=trim(vendor), post_date=trim(post_date), trans_id=trim(trans_id), trans_date=trim(trans_date), company=trim(company), acct=trim(acct), center=trim(center), amount=trim(amount), item_description=trim(item_description), pay_status=trim(pay_status), location=trim(location), card_num=trim(card_num), user_name=trim(user_name), vendor=trim(vendor), post_date=trim(post_date), trans_id=trim(trans_id), trans_date=trim(trans_date), company=trim(company), acct=trim(acct), center=trim(center), amount=trim(amount), item_description=trim(item_description), pay_status=trim(pay_status), location=trim(location)";	$result = @mysql_query($sql, $connection);if($result){$_SESSION[budget][statusA2]="x";}	header("Location: project_account.php?fy=$fy");}}else{$A2="$comp";}echo "<br><br>$A2 A2) Trim TABLE=pcard_xtnd";//A3if($_SESSION[budget][statusA3]!="x"){$A3="<a href='/budget/uploadTextFileForm.php?db=xtnd_ci_monthly&s=A3'>Run</a>";}else{$A3="$comp";}echo "<br><br>$A3 A3) Insert XTND report(bd725 into table=(xtnd_ci_monthly) [<font color='blue'>Download XTND report(bd725) into excel, clean up to text prior to clicking Run.</font>]";//Bif($_SESSION[budget][statusB]!="x"){$B="<a href='project_account.php?fy=$fy&r=B'>Run</a>";$table="partf_payments_bk".date(ymdHis);$_SESSION[budget][tableB]=$table;if($r=="B"){$table=$_SESSION[budget][tableB];$sql = "CREATE table $table SELECT * from partf_payments where 1";	$result = @mysql_query($sql, $connection);//echo "$sql r=$result";exit;if($result){$_SESSION[budget][statusB]="x";}	header("Location: project_account.php?fy=$fy");}}else{$B="$comp";}$t=$_SESSION[budget][tableB];echo "<br><br>$B B) Backup partf_payments to $t ";/*//Bif($_SESSION[budget][statusB]!="x"){$B="<a href='project_account.php?fy=$fy&r=B'>Run</a>";if($r=="B"){$table="partf_payments_bk";$sql = "TRUNCATE table $table";	$result = @mysql_query($sql, $connection);$sql = "insert into partf_payments_bkselect * from partf_payments where 1";	$result = @mysql_query($sql, $connection);//echo "$sql r=$result";exit;if($result){$_SESSION[budget][statusB]="x";}	header("Location: project_account.php?fy=$fy");}}else{$B="$comp";}echo "<br><br>$B B) Backup table=partf_payments";*///Cif($_SESSION[budget][statusC]!="x"){$C="<a href='project_account.php?fy=$fy&r=C'>Run</a>";if(!$start||!$end){echo "<br><br>Error -You must enter both a start and an end date.";exit;}if($r=="C"){$sql = "INSERT INTO partf_payments( company, fund, center, account, datepost, checknum, invoice, amount, vendornum, groupnum, vendorname, proj_num, contract_num, contract_amt, charg_proj_num, noncon_amt, dateinvoice, datenew, pcard_num, pcard_name, pcard_vendor, pcard_descr, trans_id, purch_descr_input, trans_id_9, pe, f_year )SELECT '', fund, center, acct, '', '', invoice, sum( debit - credit ) , '', '', description, '', '', '', '', '', '', acctdate, '', '', '', '', '', '', '', pe, f_yearFROM exp_revWHERE 1 AND acctdate >= '$start' and acctdate <= '$end' and fund != '1280' AND ( acctLIKE '531%' OR acctLIKE '532%' OR acctLIKE '533%' OR acctLIKE '534%' OR acctLIKE '535%' )GROUP BY whid;";	$result = @mysql_query($sql, $connection);//echo "$sql r=$result";exit;if($result){$_SESSION[budget][statusC]="x";}	header("Location: project_account.php?fy=$fy");}}else{$C="$comp";}echo "<br><br>$C C) Update Table=partf_payments with new records, source (exp_rev)";//C0if($_SESSION[budget][statusC0]!="x"){$C0="<a href='project_account.php?fy=$fy&r=C0'>Run</a>";if($r=="C0"){$sql = "update partf_payments set fund=trim(fund), center=trim(center), account=trim(account), invoice=trim(invoice), amount=trim(amount), vendorname=trim(vendorname), datenew=trim(datenew), pe=trim(pe), f_year=trim(f_year), fund=trim(fund), center=trim(center), account=trim(account), invoice=trim(invoice), amount=trim(amount), vendorname=trim(vendorname), datenew=trim(datenew), pe=trim(pe), f_year=trim(f_year)";	$result = @mysql_query($sql, $connection);	$sql = "update partf_payments set proj_num='na' where proj_num=''";	$result = @mysql_query($sql, $connection);$sql = "update partf_payments set charg_proj_num='na' where charg_proj_num=''";	$result = @mysql_query($sql, $connection);$_SESSION[budget][statusC0]="x";	header("Location: project_account.php?fy=$fy");}}else{$C0="$comp";}echo "<br><br>$C0 C0) Trim TABLE=partf_payments, Update proj_num and charg_proj_num";//Dif($_SESSION[budget][statusD]!="x"){$D="<a href='project_account.php?fy=$fy&r=D'>Run</a>";if($r=="D"){/*creates temporary table=count_center*/$sql = "DROP DATABASE [IF EXISTS] count_center";	$result = @mysql_query($sql, $connection);$sql = "CREATE TABLE `count_center` (`center` VARCHAR( 15 ) NOT NULL ,`count_center` DECIMAL( 12, 2 ) NOT NULL ,`id` INT( 10 ) UNSIGNED NOT NULL AUTO_INCREMENT ,PRIMARY KEY ( `id` ))";	$result = @mysql_query($sql, $connection);	/*creates temporary table=count_center2*/$sql = "DROP DATABASE [IF EXISTS] count_center2";	$result = @mysql_query($sql, $connection);$sql = "CREATE TABLE `count_center2` (`center` VARCHAR( 15 ) NOT NULL ,`count_center` DECIMAL( 12, 2 ) NOT NULL ,`id` INT( 10 ) UNSIGNED NOT NULL AUTO_INCREMENT ,PRIMARY KEY ( `id` ))";	$result = @mysql_query($sql, $connection);	/*creates temporary table=count_center3*/$sql = "DROP DATABASE [IF EXISTS] count_center3";	$result = @mysql_query($sql, $connection);$sql = "CREATE TABLE `count_center3` (`projnum` VARCHAR( 15 ) NOT NULL ,`center` VARCHAR( 15 ) NOT NULL ,`count_center` DECIMAL( 12, 2 ) NOT NULL ,`id` INT( 10 ) UNSIGNED NOT NULL AUTO_INCREMENT ,PRIMARY KEY ( `id` ))";	$result = @mysql_query($sql, $connection);$_SESSION[budget][statusD]="x";	header("Location: project_account.php?fy=$fy");}}else{$D="$comp";}echo "<br><br>$D D) Establish 3 temporary tables (final temp table=count_center3; centers with 1 project)";//Eif($_SESSION[budget][statusE]!="x"){$E="<a href='project_account.php?fy=$fy&r=E'>Run</a>";if($r=="E"){/*selects all centers & a "project count" of those centers from table=partf_projects where reportdisplay='y'. Then, inserts "selected" values into table=count_center*/$sql = "insert into count_center(center,count_center)SELECT center, count( center )FROM partf_projectsWHERE 1 AND partf_projects.reportdisplay = 'y'GROUP BY center";	$result = @mysql_query($sql, $connection);if($result){$_SESSION[budget][statusE]="x";}	/*selects all centers from table=count_centerwhere "project count" for those centers ='1'. Then inserts "selected" values into table=count_center2*/$sql = "INSERT INTO count_center2( center, count_center )SELECT center, count_centerFROM count_centerWHERE count_center = '1'GROUP BY id";	$result = @mysql_query($sql, $connection);if($result){$_SESSION[budget][statusE]="x";}	/*joins table=partf_projects(to get projnum) to table=count_center2(includes only centers which have '1' project assigned to that center) . Then "selects" all projects from joined table above. Then "inserts" "selected" values into table=count_center3. We now have records for table=count_center3 & these records ONLY include Centers which have ONLY 1 Project. This means that all payments paid from these Centers can ONLY be for that 1 Project. */$sql = "insert into count_center3(projnum,center,count_center)SELECT partf_projects.projnum, count_center2.center, count_center2.count_centerFROM count_center2LEFT JOIN partf_projects ON count_center2.center = partf_projects.centerWHERE 1 AND partf_projects.reportdisplay = 'y'";	$result = @mysql_query($sql, $connection);if($result){$_SESSION[budget][statusE]="x";}	header("Location: project_account.php?fy=$fy");}}else{$E="$comp";}echo "<br><br>$E E) Trim TABLE=partf_payments, Update proj_num and charg_proj_num";//E1if($_SESSION[budget][statusE1]!="x"){$E1="<a href='project_account.php?fy=$fy&r=E1'>Run</a>";if($r=="E1"){/*This update query matches up centers in table=count_center3 with centers in table=partf_payments. Since centers in table=count_center3 are Centers which have ONLY 1 Project, we know that payments to that Center can ONLY be for 1 project. Therefore, the projnum from table=count_center3 can be "passed" to the charg_proj_num in table=partf_payment*/$sql = "update partf_payments,count_center3set partf_payments.charg_proj_num=count_center3.projnumwhere partf_payments.center=count_center3.centerand partf_payments.charg_proj_num='na'and partf_payments.datenew >='$start' and partf_payments.datenew <='$end'";	$result = @mysql_query($sql, $connection);if($result){$_SESSION[budget][statusE1]="x";}	header("Location: project_account.php?fy=$fy");}}else{$E1="$comp";}echo "<br><br>$E1 E1) Populate Table=partf_payments, field=charg_proj_num, source(count_center3; centers with 1 project)";//E2if($_SESSION[budget][statusE2]!="x"){$E2="<a href='project_account.php?fy=$fy&r=E2'>Run</a>";if($r=="E2"){$sql = "truncate table count_center";	$result = @mysql_query($sql, $connection);$sql = "truncate table count_center2";	$result = @mysql_query($sql, $connection);$sql = "truncate table count_center3";	$result = @mysql_query($sql, $connection);if($result){$_SESSION[budget][statusE2]="x";}	header("Location: project_account.php?fy=$fy");}}else{$E2="$comp";}echo "<br><br>$E2 E2) truncate 3 auxillary tables";//Fif($_SESSION[budget][statusF]!="x"){$F="<a href='project_account.php?fy=$fy&r=F'>Run</a>";if($r=="F"){/*selects all centers & a "project count" of those centers from table=partf_projects where projyn='y'. Then, inserts "selected" values intotable=count_center*/$sql = "insert into count_center(center,count_center)SELECT center, count( center )FROM partf_projectsWHERE 1 AND partf_projects.projyn = 'y'GROUP BY center";	$result = @mysql_query($sql, $connection);if($result){$_SESSION[budget][statusF]="x";}		/*selects all centers from table=count_centerwhere "project count" for those centers ='1'. Then inserts "selected" values into table=count_center2*/$sql = "INSERT INTO count_center2( center, count_center )SELECT center, count_centerFROM count_centerWHERE count_center = '1'GROUP BY id";	$result = @mysql_query($sql, $connection);if($result){$_SESSION[budget][statusF]="x";}		/*joins table=partf_projects(to get projnum) to table=count_center2(includes only centers which have '1' project assigned to that center) . Then "selects" all projects from joined table above. Then "inserts" "selected" values into table=count_center3. We now have records for table=count_center3 & these records ONLY include Centers which have ONLY 1 Project. This means that all payments paid from these Centers can ONLY be for that 1 Project. */$sql = "insert into count_center3(projnum,center,count_center)SELECT partf_projects.projnum, count_center2.center, count_center2.count_centerFROM count_center2LEFT JOIN partf_projects ON count_center2.center = partf_projects.centerWHERE 1 AND partf_projects.projyn = 'y'";	$result = @mysql_query($sql, $connection);if($result){$_SESSION[budget][statusF]="x";}	header("Location: project_account.php?fy=$fy");}}else{$F="$comp";}echo "<br><br>$F F) Populate 3 auxillary tables";//F0if($_SESSION[budget][statusF0]!="x"){$F0="<a href='project_account.php?fy=$fy&r=F0'>Run</a>";if($r=="F0"){/*This update query matches up centers in table=count_center3 with centers in table=partf_payments. Since centers in table=count_center3 are Centers which have ONLY 1 Project, we know that payments to that Center can ONLY be for 1 project. Therefore, the projnum from table=count_center3 can be "passed" to the proj_num in table=partf_payment*/$sql = "update partf_payments,count_center3set partf_payments.proj_num=count_center3.projnumwhere partf_payments.center=count_center3.centerand partf_payments.proj_num='na'and partf_payments.datenew >='$start' and partf_payments.datenew <='$end'";$result = @mysql_query($sql, $connection);if($result){$_SESSION[budget][statusF0]="x";}	header("Location: project_account.php?fy=$fy");}}else{$F0="$comp";}echo "<br><br>$F0 F0) Populate Table=partf_payments, field=proj_num, source(count_center3; centers with 1 project)";//F1if($_SESSION[budget][statusF1]!="x"){$F1="<a href='project_account.php?fy=$fy&r=F1'>Run</a>";if($r=="F1"){$sql = "DROP table count_center";	$result = @mysql_query($sql, $connection);$sql = "DROP table count_center2";	$result = @mysql_query($sql, $connection);$sql = "DROP table count_center3";	$result = @mysql_query($sql, $connection);if($result){$_SESSION[budget][statusF1]="x";}	header("Location: project_account.php?fy=$fy");}}else{$F1="$comp";}echo "<br><br>$F1 F1) Drop 3 auxillary tables";//Gif($_SESSION[budget][statusG]!="x"){$G="<a href='project_account.php?fy=$fy&r=G'>Run</a>";if($r=="G"){$sql = "update partf_paymentsset acct6=mid(account,1,6),caa6=concat(center,'-',amount,'-',acct6),ciaa=concat(center,'-',invoice,'-',amount,'-',account),cia=concat(center,'-',invoice,'-',amount),ci=concat(center,'-',invoice),ca=concat(center,'-',amount)where 1";	$result = @mysql_query($sql, $connection);	if($result){$_SESSION[budget][statusG]="x";}	header("Location: project_account.php?fy=$fy");}}else{$G="$comp";}echo "<br><br>$G G) Update Table=partf_payments, fields=(acct6,caa6,ciaa,ci,ca), source(partf_payments)";//Hif($_SESSION[budget][statusH]!="x"){$H="<a href='project_account.php?fy=$fy&r=H'>Run</a>";if($r=="H"){$sql = "update cid_vendor_invoice_paymentsset ncas_center=ncas_fund where ncas_fund != '1280'";	$result = @mysql_query($sql, $connection);	$sql = "update cid_vendor_invoice_paymentsset ncas_center=concat(ncas_fund,ncas_rcc) where ncas_fund = '1280'";	$result = @mysql_query($sql, $connection);	$sql = "update cid_vendor_invoice_paymentsset acct6=mid(ncas_account,1,6), ciaa=concat(ncas_center,'-',ncas_invoice_number,'-',ncas_invoice_amount,'-',ncas_account), caa6=concat(ncas_center,'-',ncas_invoice_amount,'-',acct6), cia=concat(ncas_center,'-',ncas_invoice_number,'-',ncas_invoice_amount), ci=concat(ncas_center,'-',ncas_invoice_number), ca=concat(ncas_center,'-',ncas_invoice_amount)where 1";	$result = @mysql_query($sql, $connection);	if($result){$_SESSION[budget][statusH]="x";}	header("Location: project_account.php?fy=$fy");}}else{$H="$comp";}echo "<br><br>$H H) Update Table=cid_vendor_invoice_payments, fields=(center,acct6,ciaa,caa6,cia,ci,ca), source(cid_vendor_invoice_payments)";//Iif($_SESSION[budget][statusI]!="x"){$I="<a href='project_account.php?fy=$fy&r=I'>Run</a>";if($r=="I"){$sql = "update pcard_xtndset acct6=mid(acct,1,6),caa6=concat(center,'-',amount,'-',acct6)where 1";	$result = @mysql_query($sql, $connection);	if($result){$_SESSION[budget][statusI]="x";}	header("Location: project_account.php?fy=$fy");}}else{$I="$comp";}echo "<br><br>$I I)  Update Table=pcard_xtnd, fields=(acct6,caa6), source(pcard_xtnd)";//I0if($_SESSION[budget][statusI0]!="x"){$I0="<a href='project_account.php?fy=$fy&r=I0'>Run</a>";if($r=="I0"){$sql = "update pcard_xtndset datenew=mid(post_date,7,4) where 1";	$result = @mysql_query($sql, $connection);$sql = "update pcard_xtndset datenew=concat(datenew,mid(post_date,1,2)) where 1";	$result = @mysql_query($sql, $connection);$sql = "update pcard_xtndset datenew=concat(datenew,mid(post_date,4,2)) where 1";	$result = @mysql_query($sql, $connection);	if($result){$_SESSION[budget][statusI0]="x";}	header("Location: project_account.php?fy=$fy");}}else{$I0="$comp";}echo "<br><br>$I0 I0)  Update Table=pcard_xtnd, datenew=mid(post_date,7,4), datenew=concat(datenew,mid(post_date,1,2)), datenew=concat(datenew,mid(post_date,4,2))";//Jif($_SESSION[budget][statusJ]!="x"){$J="<a href='project_account.php?fy=$fy&r=J'>Run</a>";if($r=="J"){/* populate pcard info from pcard_xtnd to partf_payments for partf_payments datenew period not previously updated*/$sql = "update partf_payments, pcard_xtnd set partf_payments.pcard_num=pcard_xtnd.card_num,partf_payments.pcard_name=pcard_xtnd.user_name,partf_payments.pcard_vendor=pcard_xtnd.vendor,partf_payments.trans_id=pcard_xtnd.trans_id,partf_payments.pcard_descr=pcard_xtnd.item_description where partf_payments.caa6=pcard_xtnd.caa6and partf_payments.datenew >= '$start'and partf_payments.datenew <= '$end'";	$result = @mysql_query($sql, $connection);	if($result){$_SESSION[budget][statusJ]="x";}	header("Location: project_account.php?fy=$fy");}}else{$J="$comp";}echo "<br><br>$J J) J) Update Table=partf_payments, fields=(pcard_num,pcard_name,pcard_vendor,trans_id,pcard_descr), source(pcard_xtnd)";//Kif($_SESSION[budget][statusK]!="x"){$K="<a href='project_account.php?fy=$fy&r=K'>Run</a>";if($r=="K"){/* K) Update Table=partf_payments, fields=(proj_num,ci_match,ca_match), source(cid_vendor_invoice_payments)*/$sql = "update partf_payments, cid_vendor_invoice_payments set partf_payments.proj_num=cid_vendor_invoice_payments.project_number where partf_payments.ciaa=cid_vendor_invoice_payments.ciaaand partf_payments.datenew >= '$start'and partf_payments.datenew <= '$end'and partf_payments.proj_num='na'";	$result = @mysql_query($sql, $connection);	$sql = "update partf_payments, cid_vendor_invoice_payments set partf_payments.proj_num=cid_vendor_invoice_payments.project_number where partf_payments.cia=cid_vendor_invoice_payments.ciaand partf_payments.datenew >= '$start'and partf_payments.datenew <= '$end'and partf_payments.proj_num='na'";	$result = @mysql_query($sql, $connection);	$sql = "update partf_payments, cid_vendor_invoice_payments set partf_payments.ci_match=cid_vendor_invoice_payments.project_numberwhere partf_payments.ci=cid_vendor_invoice_payments.ciand partf_payments.datenew >= '$start'and partf_payments.datenew <= '$end'";	$result = @mysql_query($sql, $connection);if($result){$_SESSION[budget][statusK]="x";}$sql = "update partf_payments, cid_vendor_invoice_payments set partf_payments.ca_match=cid_vendor_invoice_payments.project_numberwhere partf_payments.ca=cid_vendor_invoice_payments.caand partf_payments.datenew >= '$start'and partf_payments.datenew <= '$end'";	$result = @mysql_query($sql, $connection);if($result){$_SESSION[budget][statusK]="x";}	header("Location: project_account.php?fy=$fy");}}else{$K="$comp";}echo "<br><br>$K K) K) Update Table=partf_payments, fields=(proj_num,ci_match,ca_match), source(cid_vendor_invoice_payments)";echo "</body></html>";?>